<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="apple-touch-icon" href="../apple-touch-icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock &amp; Inventory Module | Cable Factory ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f3f3f3;
            --fg: #000000;
            --gray-100: #f3f4f6;
            --gray-300: #d1d5db;
            --positive: #16a34a;
            --negative: #dc2626;
            --accent: #2563eb;
            --turquoise: #00b5ad;
        }
        body { font-family: 'IBM Plex Mono', monospace; background: var(--bg); color: var(--fg); font-size: 12px; line-height: 1.3; }
        .nav { position: sticky; top: 0; z-index: 50; border-bottom: 2px solid var(--fg); background: var(--bg); }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 64px; height: 56px; display: flex; align-items: center; }
        .nav-left { display: flex; align-items: center; gap: 12px; }
        .nav-logo { font-size: 18px; font-weight: 700; letter-spacing: 2px; text-decoration: none; color: var(--fg); }
        .nav-right { margin-left: auto; }
        .nav-link-small { color: var(--fg); text-decoration: underline; font-size: 11px; }
        .nav-divider { color: var(--fg); font-size: 14px; font-weight: 300; }
        .report { max-width: 1400px; margin: 0 auto; padding: 24px 64px; }
        .report h1 { font-size: 28px; margin-bottom: 8px; letter-spacing: 2px; }
        .report h2 { font-size: 18px; margin-top: 36px; margin-bottom: 12px; border-bottom: 2px solid #000; padding-bottom: 4px; scroll-margin-top: 72px; }
        .report h3 { font-size: 14px; margin-top: 20px; margin-bottom: 8px; }
        .report h4 { font-size: 12px; margin-top: 14px; margin-bottom: 6px; }
        .report p { font-size: 13px; line-height: 1.6; margin-bottom: 12px; }
        .report ul { font-size: 13px; margin: 12px 0; padding-left: 20px; }
        .report li { margin-bottom: 6px; line-height: 1.5; }
        .report ol { font-size: 13px; margin: 12px 0; padding-left: 20px; }
        .report ol li { margin-bottom: 6px; line-height: 1.5; }
        .report .subtitle { font-size: 14px; color: #666; margin-bottom: 4px; }
        .report .authors { font-size: 12px; color: #888; margin-bottom: 32px; }
        .report code { background: #e5e5e0; padding: 1px 5px; font-size: 12px; }
        .report pre { background: #1a1a2e; color: #e0e0e0; padding: 16px; margin: 12px 0; overflow-x: auto; font-size: 12px; line-height: 1.5; border: 2px solid #000; }
        .report .abstract { background: #f5f5f0; padding: 16px; margin: 20px 0; border-left: 3px solid #000; }
        .report .finding { background: #fffbe6; padding: 12px; margin: 12px 0; border: 1px solid #e6d600; }
        .report .warning { background: #fee2e2; padding: 12px; margin: 12px 0; border: 1px solid #dc2626; }
        .report .discovery { background: #e6ffe6; padding: 12px; margin: 12px 0; border: 1px solid #0a0; }
        .report .insight { background: #eff6ff; padding: 12px; margin: 12px 0; border: 1px solid #2563eb; }
        .report .philosophy { background: #faf5ff; padding: 12px; margin: 12px 0; border: 1px solid #7c3aed; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 16px 0; }
        .stat-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0; }
        .stat-box { background: #f3f4f6; padding: 12px; text-align: center; border: 2px solid #000; }
        .stat-box .value { font-size: 24px; font-weight: bold; }
        .stat-box .label { font-size: 10px; color: #666; margin-top: 2px; }
        .report table { width: auto; border-collapse: collapse; border: 2px solid #000; margin: 16px 0; }
        .report tr:first-child { background: #f3f4f6; border-bottom: 2px solid #000; }
        .report th { padding: 4px 10px; text-align: left; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; white-space: nowrap; border-right: 2px solid #000; background: #f3f4f6; }
        .report th:last-child { border-right: none; }
        .report tr:not(:first-child) { border-bottom: 1px solid #d1d5db; }
        .report tr:last-child { border-bottom: none; }
        .report td { padding: 4px 10px; font-size: 0.75rem; border-right: 2px solid #000; }
        .report td:last-child { border-right: none; }
        .report tr:not(:first-child):hover { background: rgba(0,0,0,0.02); }
        .flow { display: flex; align-items: center; gap: 8px; margin: 16px 0; flex-wrap: wrap; }
        .flow-step { padding: 8px 14px; border: 2px solid #000; font-size: 12px; font-weight: 700; text-align: center; min-width: 100px; }
        .flow-arrow { font-size: 18px; font-weight: 700; }
        .flow-box { padding: 8px 14px; border: 2px solid #000; font-size: 12px; font-weight: 700; text-align: center; min-width: 100px; }
        .flow-box.done { background: #dcfce7; border-color: #16a34a; }
        .flow-box.active { background: #dbeafe; border-color: #2563eb; }
        .flow-box.pending { background: #f3f4f6; }
        .arch-box { background: #fff; border: 2px solid #000; padding: 16px; margin: 12px 0; }
        .arch-box h4 { font-size: 14px; margin-bottom: 8px; margin-top: 0; }
        .arch-box p { font-size: 12px; line-height: 1.5; }
        .arch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin: 16px 0; }
        .back-link { display: inline-block; font-size: 12px; color: #666; text-decoration: none; margin-bottom: 24px; padding: 8px 0; }
        .back-link:hover { color: #000; }
        .back-link::before { content: "\2190  "; }
        .good { color: #16a34a; font-weight: 700; }
        .bad { color: #dc2626; font-weight: 700; }
        .code-block { background: #1a1a2e; color: #e0e0e0; padding: 16px; margin: 12px 0; overflow-x: auto; font-size: 12px; line-height: 1.5; border: 2px solid #000; }

        .submod-card { background: #fff; border: 2px solid #000; padding: 16px; margin: 10px 0; display: flex; align-items: flex-start; gap: 16px; }
        .submod-num { background: #000; color: #fff; font-size: 13px; font-weight: 700; min-width: 36px; height: 36px; padding: 0 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .submod-body { flex: 1; }
        .submod-body h4 { font-size: 14px; margin: 0 0 4px 0; }
        .submod-body p { font-size: 12px; color: #555; margin: 0 0 6px 0; line-height: 1.4; }
        .submod-tags { display: flex; gap: 6px; flex-wrap: wrap; }
        .submod-tag { font-size: 10px; padding: 2px 6px; background: #f3f4f6; border: 1px solid #d1d5db; }

        @media (max-width: 768px) {
            .report { padding: 16px; }
            .nav-container { padding: 0 16px; }
            .stat-grid, .stat-grid-3 { grid-template-columns: repeat(2, 1fr); }
            .flow { flex-direction: column; align-items: stretch; }
            .flow-arrow { transform: rotate(90deg); text-align: center; }
            .arch-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <div class="nav-left">
                <a href="erp-system.html" class="nav-logo">ERP SYSTEM</a>
            </div>
            <div class="nav-right">
                <a href="erp-mod-stok-tr.html" class="nav-link-small">TR</a>
                <span class="nav-divider">|</span>
                <a href="erp-mod-stok.html" class="nav-link-small" style="font-weight: 700;">EN</a>
            </div>
        </div>
    </nav>

    <main class="report">
        <a href="erp-deep-dives.html" class="back-link">Back to Modules</a>
        <h1>STOCK &amp; INVENTORY &mdash; DUAL-LOGIC MATERIAL VISIBILITY</h1>
        <p class="subtitle">Two parallel systems answering two different questions: &ldquo;What do we have right now?&rdquo; and &ldquo;What will we have in the future?&rdquo; &mdash; the live inventory and the dynamic projection forecast, running side by side as a built-in double-check mechanism.</p>
        <p class="authors">February 2026 &bull; Solen Kablo &bull; Living Document</p>

        <div class="abstract">
            <p style="margin-bottom: 0;"><strong>The Stock &amp; Inventory module operates on a fundamental duality.</strong> Two of its three pages &mdash; &Uuml;r&uuml;n Stok and Hammadde Stok &mdash; show the physical reality of the factory at this exact moment: every basket of copper wire, every reel of extruded cable, every kilogram of raw plastic sitting in the warehouse. These change every time Production records an output or a material is consumed. The third page &mdash; Projeksiyon &mdash; ignores physical reality entirely and instead shows the <em>plan</em>: a week-by-week forecast of what materials will be needed (from work cards) versus what materials are coming in (from purchase orders). Projeksiyon dynamically reacts to plan changes &mdash; when a material order is delivered, it switches from the expected date/quantity to the actual delivered date/quantity, shifting the projection accordingly. It also updates when work cards are created, modified, or cancelled. This duality is intentional &mdash; it creates a built-in cross-verification mechanism where the live inventory validates the projection, and the projection warns about future shortages that the live inventory cannot yet see.</p>
        </div>

        <div class="stat-grid">
            <div class="stat-box">
                <div class="value" style="color: var(--accent);">3</div>
                <div class="label">SUBMODULES</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: var(--turquoise);">~14</div>
                <div class="label">API ENDPOINTS</div>
            </div>
            <div class="stat-box">
                <div class="value">2</div>
                <div class="label">DATABASE TABLES</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: var(--positive);">5800+</div>
                <div class="label">LINES OF CODE</div>
            </div>
        </div>

        <!-- TABLE OF CONTENTS -->
        <div style="background: #fff; border: 2px solid #000; padding: 20px 28px; margin: 24px 0;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; letter-spacing: 1px;">TABLE OF CONTENTS</h3>
            <div style="columns: 2; column-gap: 32px; font-size: 12px; line-height: 2;">
                <a href="#sec-1" style="text-decoration: none; color: var(--fg); display: block;"><strong>1.</strong> What Stock &amp; Inventory Does</a>
                <a href="#sec-2" style="text-decoration: none; color: var(--fg); display: block;"><strong>2.</strong> The Data Flow</a>
                <a href="#sec-3" style="text-decoration: none; color: var(--fg); display: block;"><strong>3.</strong> The Database Layer</a>
                <a href="#sec-4" style="text-decoration: none; color: var(--fg); display: block;"><strong>4.</strong> The Backend Architecture</a>
                <a href="#sec-5" style="text-decoration: none; color: var(--fg); display: block;"><strong>5.</strong> The Frontend</a>
                <a href="#sec-6" style="text-decoration: none; color: var(--fg); display: block;"><strong>6.</strong> The Submodules</a>
                <a href="#sec-6-1" style="text-decoration: none; color: #555; display: block; padding-left: 16px;">6.1 Projeksiyon (Stock Projection)</a>
                <a href="#sec-6-2" style="text-decoration: none; color: #555; display: block; padding-left: 16px;">6.2 Hammadde Stok (Raw Material Stock)</a>
                <a href="#sec-6-3" style="text-decoration: none; color: #555; display: block; padding-left: 16px;">6.3 &Uuml;r&uuml;n Stok (Product Stock)</a>
                <a href="#sec-7" style="text-decoration: none; color: var(--fg); display: block;"><strong>7.</strong> Conclusion</a>
            </div>
        </div>

        <!-- ============================================ -->
        <h2 id="sec-1">1. WHAT STOCK &amp; INVENTORY DOES</h2>
        <!-- ============================================ -->

        <p>The Stock &amp; Inventory module answers the two most fundamental questions in any manufacturing operation:</p>

        <ol>
            <li><strong>&ldquo;What do we have right now?&rdquo;</strong> &mdash; Answered by &Uuml;r&uuml;n Stok (finished/semi-finished goods) and Hammadde Stok (raw materials). These pages show the live, physical state of the factory&rsquo;s inventory at t=0. Every basket of drawn copper wire (X-coded), every reel of tinned wire (Y-coded), every kilogram of raw plastic &mdash; all visible with real-time weights, statuses, allocations, and full production traceability.</li>
            <li><strong>&ldquo;What will we have in the future?&rdquo;</strong> &mdash; Answered by Projeksiyon (Stock Projection). This page shows a week-by-week forecast across 8 material categories (copper, tin, plastic, catalyst, dye, antirodent, reels, palettes), calculating how much material will be consumed by planned work cards (MINUS) versus how much is arriving through purchase orders (PLUS), producing a running cumulative balance that reveals shortages weeks before they become critical.</li>
        </ol>

        <p>These two systems run on <strong>fundamentally different data sources</strong>:</p>

        <table>
            <tr><th>Aspect</th><th>Live Inventory (&Uuml;r&uuml;n + Hammadde Stok)</th><th>Projection (Projeksiyon)</th></tr>
            <tr><td><strong>Data source</strong></td><td><code>half_product_stock</code> table + <code>materials</code> table</td><td><code>work_cards</code> (MINUS) + <code>material_orders</code> (PLUS)</td></tr>
            <tr><td><strong>Time axis</strong></td><td>Now (t=0)</td><td>Weeks into the future (H01&ndash;H52+)</td></tr>
            <tr><td><strong>Changes when</strong></td><td>Production records output, materials consumed/received</td><td>Plan changes: work card created/modified/cancelled, material order delivered (switches to actual date &amp; quantity), order date/qty changed, order cancelled</td></tr>
            <tr><td><strong>Does NOT change when</strong></td><td>&mdash;</td><td>Production physically completes (completed work cards still counted in plan)</td></tr>
            <tr><td><strong>CRUD</strong></td><td>Full (view, edit weight/status, delete)</td><td>Read-only (projection is calculated, not edited)</td></tr>
        </table>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>The double-check mechanism:</strong> If Projeksiyon shows a copper surplus for week H15, but Hammadde Stok shows copper running low <em>now</em>, something is wrong &mdash; perhaps a material order was recorded but the physical delivery didn&rsquo;t happen. Conversely, if Hammadde Stok shows plenty of plastic but Projeksiyon projects a shortage in H20, it means current stock will be depleted by upcoming production. Neither system alone tells the complete story; together they form a comprehensive material visibility layer.</p>
        </div>

        <!-- ============================================ -->
        <h2 id="sec-2">2. THE DATA FLOW</h2>
        <!-- ============================================ -->

        <h3>2.1 Projeksiyon Data Flow</h3>
        <p>Projeksiyon computes its weekly forecast from two independent data sources, combined in the <code>ProjeksiyonService</code> (804 lines):</p>

        <div class="flow">
            <span class="flow-step">Work Cards (sevkiyat_week)</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">material_details JSON</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">MINUS per week per material</span>
        </div>
        <div class="flow">
            <span class="flow-step">Material Orders (expected_date)</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">quantity + material_type</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">PLUS per week per material</span>
        </div>
        <div class="flow">
            <span class="flow-step">PLUS &minus; MINUS</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Weekly change</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Running cumulative</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Shortage detection</span>
        </div>

        <h4>MINUS Side: Work Card Material Requirements</h4>
        <p>Each work card carries a <code>material_details</code> JSON that specifies exactly what raw materials it will consume. The service maps machine types to material categories:</p>
        <table>
            <tr><th>Machine Type</th><th>Material Extracted</th><th>JSON Path</th></tr>
            <tr><td>Kabatel &Ccedil;ekme</td><td>Copper (kg)</td><td><code>material_details.copper_kg</code></td></tr>
            <tr><td>Kalaylama</td><td>Tin (kg)</td><td><code>material_details.tin_kg</code></td></tr>
            <tr><td>Extruder</td><td>Plastic, Catalyst, Dye, Antirodent (kg)</td><td><code>quantities.*</code>, <code>insulation_materials[]</code>, <code>sheath_materials[]</code></td></tr>
            <tr><td>Aktarma</td><td>Reels (adet)</td><td><code>makara_distributions[].count</code></td></tr>
            <tr><td>Paletleme</td><td>Palettes (adet)</td><td><code>palettes[].quantity</code></td></tr>
        </table>

        <p>All work cards except <code>CANCELLED</code> are included &mdash; even completed ones, because Projeksiyon tracks the full plan history. On the incoming side, when an order is delivered, the service switches from <code>expected_date</code>/<code>quantity</code> to <code>delivered_date</code>/<code>delivered_quantity</code>, so the projection dynamically reflects actual delivery timing and amounts.</p>

        <h4>PLUS Side: Material Order Incoming</h4>
        <p>Each material order has a <code>material_type</code>, <code>quantity</code>, and <code>expected_date</code>. For delivered orders, the system uses <code>delivered_date</code> and <code>delivered_quantity</code> instead. Material names are resolved from the supplier&rsquo;s material catalog when available. All orders except <code>CANCELLED</code> are included.</p>

        <h4>Cumulative Calculation</h4>
        <p>The service generates all weeks from the <strong>earliest data point</strong> (which may be in a previous year) through the last visible week. It calculates <code>weekly = plus - minus</code> and maintains a running <code>cumulative</code> for each of the 8 material categories. For the user&rsquo;s view window (default 10 weeks), it also tracks <strong>sub-material cumulatives</strong> (e.g., individual plastic types like &ldquo;HFX 500P&rdquo; within the Plastic category) for hidden shortage detection.</p>

        <h3>2.2 Live Inventory Data Flow</h3>
        <p>The live inventory pages read directly from physical inventory tables:</p>

        <div class="flow">
            <span class="flow-step">Production records output</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">half_product_stock row created</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">&Uuml;r&uuml;n Stok shows it</span>
        </div>
        <div class="flow">
            <span class="flow-step">Material entry form</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">materials row created</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Hammadde Stok shows it</span>
        </div>

        <p>&Uuml;r&uuml;n Stok fetches 7 parallel API calls (one per production step: Kabatel, Kalaylama, &Idot;ncetel, Buncher, Extruder, E-Beam, Aktarma), while Hammadde Stok fetches all materials in a single call and groups them client-side into 8 categories.</p>

        <!-- ============================================ -->
        <h2 id="sec-3">3. THE DATABASE LAYER</h2>
        <!-- ============================================ -->

        <p>The Stock module relies on two primary tables for live inventory, plus two external tables (from other modules) that feed the Projeksiyon calculation.</p>

        <h3>3.1 half_product_stock (20 columns) &mdash; Semi-Finished &amp; Finished Products</h3>
        <p>Every basket, reel, or coil produced by any machine is recorded here. Each entry has a deterministic QR code (X1 for Kabatel, Y1 for Kalaylama, Z1 for &Idot;ncetel, T1 for Buncher, U1 for Extruder, G1 for E-Beam).</p>

        <table>
            <tr><th>Column</th><th>Type</th><th>Details</th></tr>
            <tr><td><code>id</code></td><td>Integer PK</td><td>Auto-increment</td></tr>
            <tr><td><code>qr_code</code></td><td>String(50)</td><td>Unique, indexed. Deterministic: X1, X2, Y1, Y2, etc.</td></tr>
            <tr><td><code>product_code</code></td><td>String(100)</td><td>Indexed. e.g., KC_18 (Kabatel 1.8mm), KL_18 (Kalaylama 1.8mm)</td></tr>
            <tr><td><code>product_name</code></td><td>String(200)</td><td>Human-readable name</td></tr>
            <tr><td><code>production_step</code></td><td>String(50)</td><td>Indexed. Enum: kabatel_cekme, kalaylama, incetel, buncher, extruder, ebeam</td></tr>
            <tr><td><code>initial_weight_kg</code></td><td>Float</td><td>Weight when first produced</td></tr>
            <tr><td><code>remaining_weight_kg</code></td><td>Float</td><td>Current weight (decreases as material is consumed in next step)</td></tr>
            <tr><td><code>basket_number</code></td><td>Integer</td><td>Sequential within session</td></tr>
            <tr><td><code>allocation</code></td><td>String(20)</td><td><code>ORDER</code> (tied to a customer order) or <code>STOCK</code> (free inventory)</td></tr>
            <tr><td><code>order_id</code></td><td>Integer FK</td><td>References <code>orders.id</code> if allocation = ORDER</td></tr>
            <tr><td><code>status</code></td><td>String(50)</td><td>Indexed. Enum: available, in_use, consumed, reserved, shipped</td></tr>
            <tr><td><code>production_output_id</code></td><td>Integer FK</td><td>References <code>production_outputs.id</code>, indexed</td></tr>
            <tr><td><code>session_id</code></td><td>Integer FK</td><td>References <code>production_sessions.id</code></td></tr>
            <tr><td><code>work_card_id</code></td><td>Integer FK</td><td>References <code>work_cards.id</code></td></tr>
            <tr><td><code>source_qr_codes</code></td><td>Text</td><td>JSON array of input QR codes for full traceability (e.g., a Kalaylama Y1 consumed Kabatel X3 and X4)</td></tr>
            <tr><td><code>produced_at</code></td><td>DateTime</td><td>When produced</td></tr>
            <tr><td><code>consumed_at</code></td><td>DateTime</td><td>When fully consumed (nullable)</td></tr>
            <tr><td><code>created_at</code></td><td>DateTime</td><td>UTC</td></tr>
            <tr><td><code>updated_at</code></td><td>DateTime</td><td>Auto-updated</td></tr>
            <tr><td><code>notes</code></td><td>Text</td><td>Optional notes</td></tr>
        </table>

        <p><strong>Composite indexes:</strong> <code>(production_step, status)</code> for step-based filtering, <code>(product_code, status)</code> for product-based grouping. 4 foreign keys link to orders, production outputs, sessions, and work cards.</p>

        <h3>3.2 materials (from Hammadde module)</h3>
        <p>The raw material inventory table (documented in the Hammadde module). Hammadde Stok reads this table directly via <code>GET /api/materials/list</code>. Each row represents a physical lot of raw material with QR code, weight, supplier, lot number, and status. 8 material types: raw_copper, raw_tin, raw_plastic, raw_catalyst, raw_dye, raw_antirodent, raw_palette, raw_reel.</p>

        <h3>3.3 External Tables Feeding Projeksiyon</h3>

        <table>
            <tr><th>Table</th><th>Module</th><th>What Projeksiyon Reads</th></tr>
            <tr><td><code>work_cards</code></td><td>Production</td><td><code>sevkiyat_week</code> (delivery week), <code>machine_type</code>, <code>material_details</code> JSON, <code>status</code> (excludes CANCELLED)</td></tr>
            <tr><td><code>material_orders</code></td><td>Hammadde</td><td><code>material_type</code>, <code>quantity</code>, <code>expected_date</code>, <code>delivered_date</code>, <code>delivered_quantity</code>, <code>status</code> (excludes CANCELLED)</td></tr>
        </table>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>No dedicated &ldquo;projeksiyon&rdquo; table exists.</strong> The projection is computed on-the-fly from work cards and material orders. This is a deliberate design decision: since Projeksiyon reflects the plan (not a stored state), it always shows the latest version of the plan without requiring synchronization or cache invalidation. The trade-off is computational cost per request, but the query scope (hundreds of work cards and orders, not millions) makes this viable.</p>
        </div>

        <!-- ============================================ -->
        <h2 id="sec-4">4. THE BACKEND ARCHITECTURE</h2>
        <!-- ============================================ -->

        <h3>4.1 Route Files</h3>

        <table>
            <tr><th>File</th><th>Lines</th><th>Prefix</th><th>Endpoints</th><th>Purpose</th></tr>
            <tr><td><code>projeksiyon_routes.py</code></td><td>245</td><td><code>/api/projeksiyon</code></td><td>4</td><td>Stock projection: main data, summary, debug, per-material detail</td></tr>
            <tr><td><code>half_product_routes.py</code></td><td>327</td><td><code>/api/stock</code></td><td>6</td><td>Half-product CRUD: list, by-step, summary, by-QR, update, delete</td></tr>
            <tr><td><code>material_routes.py</code></td><td>(Hammadde)</td><td><code>/api/materials</code></td><td>~4</td><td>Raw material listing (shared with Hammadde module)</td></tr>
        </table>

        <h3>4.2 The Projeksiyon Service (804 lines)</h3>
        <p>The computational heart of the module. <code>ProjeksiyonService</code> orchestrates the entire projection calculation:</p>

        <table>
            <tr><th>Method</th><th>What It Does</th></tr>
            <tr><td><code>get_earliest_data_week_offset()</code></td><td>Scans both work cards and material orders to find the earliest week with data. Ensures cumulative calculations include data from previous years (e.g., 2025 orders still affect 2026 projection).</td></tr>
            <tr><td><code>get_requirements_by_week(weeks)</code></td><td>Reads ALL non-cancelled work cards, extracts material requirements per week per category. Maps 5 machine types to 8 material categories. Produces both aggregate totals and detailed breakdowns by specific material name. Consolidates duplicate material names per week.</td></tr>
            <tr><td><code>get_incoming_by_week(weeks)</code></td><td>Reads ALL non-cancelled material orders. For delivered orders, uses actual delivered date/quantity; for pending/shipped, uses expected date/quantity. Maps to the same 8 categories. Resolves specific material names from supplier catalog.</td></tr>
            <tr><td><code>get_projeksiyon(num_weeks, offset)</code></td><td>Master method. Generates week windows, fetches requirements and incoming for ALL weeks (not just view window), calculates running cumulative per category and per sub-material, captures pre-view cumulative state for frontend shortage detection, returns structured response.</td></tr>
        </table>

        <h3>4.3 API Contract &mdash; Projeksiyon Endpoints (4)</h3>

        <table>
            <tr><th>Method</th><th>Path</th><th>Parameters</th><th>What It Does</th></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon</code></td><td><code>weeks</code> (4&ndash;52, default 10), <code>offset</code> (&minus;260 to +260)</td><td>Main endpoint. Returns weekly breakdown with PLUS/MINUS/cumulative per material, sub-material cumulatives, detail arrays for consumption and incoming, navigation info.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/summary</code></td><td><code>weeks</code> (4&ndash;52, default 8)</td><td>Shortage alert endpoint. Scans all weeks for negative cumulatives, returns list of shortage events with material, week, and cumulative value.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/material/{type}</code></td><td><code>type</code> (8 valid), <code>weeks</code></td><td>Per-material detail. Returns week-by-week data for a single material type with full plus/minus/cumulative. Includes plastic details for the plastic type.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/debug</code></td><td>&mdash;</td><td>Debug endpoint. Shows unique sevkiyat_weeks in DB, cards per week, sample work cards with material_details keys, sample material orders.</td></tr>
        </table>

        <h3>4.4 API Contract &mdash; Half Product Endpoints (6)</h3>

        <table>
            <tr><th>Method</th><th>Path</th><th>What It Does</th></tr>
            <tr><td><code>GET</code></td><td><code>/api/stock/half-products</code></td><td>List all half products with optional <code>production_step</code> and <code>status</code> filters. Paginated (limit/offset).</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/stock/half-products/by-step/{step}</code></td><td>Get items for a specific production step with operator name from session. Used by &Uuml;r&uuml;n Stok page (7 parallel calls).</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/stock/half-products/summary</code></td><td>Aggregated counts and weights per step (available count, available kg, total count) for 6 production steps.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/stock/half-products/{qr_code}</code></td><td>Get single item by QR code.</td></tr>
            <tr><td><code>PUT</code></td><td><code>/api/stock/half-products/{id}</code></td><td>Update allowed fields: <code>remaining_weight_kg</code>, <code>status</code>, <code>notes</code>.</td></tr>
            <tr><td><code>DELETE</code></td><td><code>/api/stock/half-products/{id}</code></td><td>Hard delete. Also deletes linked <code>production_output</code> and decrements QR sequence if this was the last number.</td></tr>
        </table>

        <!-- ============================================ -->
        <h2 id="sec-5">5. THE FRONTEND</h2>
        <!-- ============================================ -->

        <h3>5.1 Page Structure</h3>

        <table>
            <tr><th>Route</th><th>Component</th><th>Lines</th><th>Purpose</th></tr>
            <tr><td><code>/stok/projeksiyon</code></td><td><code>Stok/Projeksiyon/index.tsx</code></td><td><strong>3,323</strong></td><td>One of the largest components in the ERP. Weekly forecast table with expandable sub-material columns + 3 chart types (Line, Heatmap, Radar). Material filtering, week navigation, hidden shortage detection.</td></tr>
            <tr><td><code>/stok/urun-stok</code></td><td><code>Stok/UrunStok/index.tsx</code></td><td>866</td><td>Semi-finished product inventory. 7 Collapse panels (one per production step), 3-level table hierarchy (step &rarr; product group &rarr; individual item), edit/delete, bonded test viewing.</td></tr>
            <tr><td><code>/stok/hammadde-stok</code></td><td><code>Stok/HammaddeStok/index.tsx</code></td><td>676</td><td>Raw material inventory. 8 Collapse panels (one per material type), 3-level table hierarchy (type &rarr; material name &rarr; individual lot), conditional weight coloring, edit/delete.</td></tr>
        </table>

        <p><strong>Total frontend:</strong> 4,865 lines across 3 pages. Projeksiyon alone accounts for 68% of the code.</p>

        <h3>5.2 Shared Patterns</h3>
        <ul>
            <li><strong>No WebSocket:</strong> All three pages use REST API polling or one-time fetches. No real-time subscriptions.</li>
            <li><strong>Turkish locale:</strong> All pages wrap in <code>ConfigProvider locale={trTR}</code> with <code>dayjs</code> timezone conversion to <code>Europe/Istanbul</code>.</li>
            <li><strong>No ProTable:</strong> Unlike other modules, the stock pages use plain Ant Design <code>Table</code> components (except HammaddeSiparis which is in the Hammadde module).</li>
            <li><strong>Client-side grouping:</strong> Both &Uuml;r&uuml;n Stok and Hammadde Stok fetch data and group it client-side (by product_code and material_name respectively).</li>
        </ul>

        <h3>5.3 Projeksiyon &mdash; Frontend Highlights</h3>
        <p>At 3,323 lines, Projeksiyon is one of the largest React components in the ERP. It has two tabs:</p>

        <p><strong>Tab 1 &mdash; Table View:</strong> A dynamic table with week rows and 8 material columns. Each material column shows incoming (green &uarr;), consumption (red &darr;), and cumulative balance (color-coded Tag). Columns are <strong>expandable</strong>: clicking a material header reveals individual sub-material columns (e.g., &ldquo;Filma&#351;in&rdquo; under Copper, &ldquo;HFX 500P&rdquo; under Plastic). Non-expanded materials collapse to 20px color bars with traffic-light indicators. Week navigation shifts the 10-week window via offset parameter. A summary row shows final cumulatives.</p>

        <p><strong>Tab 2 &mdash; Charts View:</strong> Three interchangeable chart types powered by <strong>ReactECharts</strong>:</p>
        <ol>
            <li><strong>Line Chart:</strong> Smooth cumulative lines with area fill. Overview mode (all materials) or detail mode (1&ndash;3 selected materials showing sub-material stacked bars + cumulative overlay).</li>
            <li><strong>Heatmap:</strong> Weeks (x) vs materials/sub-materials (y), colored red-to-green with per-material normalization. Custom HTML axis tooltips show shortage start/increase info.</li>
            <li><strong>Radar Chart:</strong> Merged mode (4 weeks overlapping) or individual mode (paginated spiders). Normalized 0&ndash;100 scale with 50 = zero line. Rich text labels colored by sign.</li>
        </ol>

        <p><strong>Hidden Shortage Detection:</strong> The most sophisticated feature. If the aggregate Copper cumulative is positive but the sub-material &ldquo;Filma&#351;in 8mm&rdquo; is negative, the cell gets a <span class="bad">red border</span> on a <span class="good">green background</span> with a warning tooltip. This appears across all three chart types.</p>

        <h3>5.4 &Uuml;r&uuml;n Stok &mdash; Frontend Highlights</h3>
        <p>7 Collapse panels (Kabatel, Kalaylama, &Idot;ncetel, Buncher, Extruder, E-Beam, Aktarma), each with a color-coded icon and 3 header stats (Total kg, Sipari&#351; kg, Serbest kg). Items grouped by product_code at level 2, individual QR-coded items at level 3. Features: edit modal (weight, allocation, notes), delete with confirmation, and a <strong>bonded test viewer</strong> that fetches test results from the Lab module for any item with a production_output_id.</p>

        <h3>5.5 Hammadde Stok &mdash; Frontend Highlights</h3>
        <p>8 Collapse panels (Bak&inodot;r, Kalay, Plastik, Kataliz&ouml;r, Boya, Antirodent, Palet, Makara). Structurally mirrors &Uuml;r&uuml;n Stok but for raw materials. Units adapt: kg for most materials, &ldquo;adet&rdquo; for palettes and reels. <strong>Conditional weight coloring:</strong> remaining weight shown in <span class="bad">red</span> below 20% of original, <span style="color: #ca8a04; font-weight: 700;">yellow</span> below 95% of original. Single API call fetches all materials; client-side grouping by <code>material_type</code>.</p>

        <h3>5.6 Permission System</h3>
        <table>
            <tr><th>Page</th><th>Route Guard</th><th>Manifest Buttons</th></tr>
            <tr><td>Projeksiyon</td><td><code>canStok</code></td><td><code>access_page</code>, <code>view_projections</code>, <code>create_projection</code>, <code>edit_projection</code></td></tr>
            <tr><td>&Uuml;r&uuml;n Stok</td><td><code>canStok</code></td><td><code>access_page</code>, <code>view_table</code>, <code>view_details</code>, <code>edit_stock</code>, <code>adjust_quantity</code></td></tr>
            <tr><td>Hammadde Stok</td><td><code>canStok</code></td><td><code>access_page</code>, <code>view_table</code>, <code>view_details</code>, <code>edit_stock</code>, <code>adjust_quantity</code></td></tr>
        </table>

        <p>All three pages share the <code>canStok</code> route guard from <code>access.ts</code>. Button-level permissions are defined in the manifest but not currently enforced in the page components &mdash; the route-level guard is the active access control.</p>

        <!-- ============================================ -->
        <h2 id="sec-6">6. THE SUBMODULES</h2>
        <!-- ============================================ -->

        <p>The Stock module has three submodules, ordered by complexity:</p>

        <div class="submod-card">
            <div class="submod-num">6.1</div>
            <div class="submod-body">
                <h4>Projeksiyon (Stock Projection)</h4>
                <p>Week-by-week forecast of material supply and demand. 804-line backend service + 3,323-line frontend &mdash; one of the largest React components in the ERP. Read-only: no CRUD, pure computation.</p>
                <div class="submod-tags">
                    <span class="submod-tag">3,323 LOC FRONTEND</span>
                    <span class="submod-tag">804 LOC SERVICE</span>
                    <span class="submod-tag">4 ENDPOINTS</span>
                    <span class="submod-tag">3 CHART TYPES</span>
                </div>
            </div>
        </div>

        <div class="submod-card">
            <div class="submod-num">6.2</div>
            <div class="submod-body">
                <h4>Hammadde Stok (Raw Material Stock)</h4>
                <p>Live inventory of all raw materials (copper, tin, plastic, catalyst, dye, antirodent, palette, reel). Reads from the Hammadde module&rsquo;s <code>materials</code> table. 8 collapse panels, conditional weight coloring, edit/delete.</p>
                <div class="submod-tags">
                    <span class="submod-tag">676 LOC FRONTEND</span>
                    <span class="submod-tag">8 MATERIAL CATEGORIES</span>
                    <span class="submod-tag">SHARED API</span>
                </div>
            </div>
        </div>

        <div class="submod-card">
            <div class="submod-num">6.3</div>
            <div class="submod-body">
                <h4>&Uuml;r&uuml;n Stok (Product Stock)</h4>
                <p>Live inventory of semi-finished and finished products across all production steps. 7 collapse panels organized by machine type, 3-level grouping, bonded test integration with Lab module.</p>
                <div class="submod-tags">
                    <span class="submod-tag">866 LOC FRONTEND</span>
                    <span class="submod-tag">6 ENDPOINTS</span>
                    <span class="submod-tag">7 PRODUCTION STEPS</span>
                    <span class="submod-tag">LAB INTEGRATION</span>
                </div>
            </div>
        </div>


        <!-- ============================================= -->
        <!--  6.1  PROJEKSÄ°YON (Stock Projection)          -->
        <!-- ============================================= -->

        <h2 id="sec-6-1">6.1 &mdash; Projeksiyon (Stock Projection)</h2>

        <h3>6.1.1 &mdash; Purpose and Business Context</h3>
        <p>Projeksiyon answers the most forward-looking question in the factory: <strong>&ldquo;Week by week, will we have enough of each raw material, or will we run short?&rdquo;</strong> It is a read-only, computed view that blends two data streams &mdash; material consumption from production plans (work cards) and material arrivals from purchase orders &mdash; into a single, navigable weekly forecast spanning up to 5 years in either direction.</p>
        <p>This is not a dashboard with pre-calculated snapshots. Every time the page loads, the backend queries ALL non-cancelled work cards and ALL non-cancelled material orders, computes a running cumulative balance across every week since the earliest data point, and returns the result for the user&rsquo;s 10-week view window. The projection is <strong>always fresh</strong> &mdash; no caching, no stored state, no stale data.</p>
        <p>The page serves two audiences: the <strong>purchasing team</strong> (who need to know when to order more material) and the <strong>production planners</strong> (who need to know if upcoming work cards will cause a shortage). At 3,323 lines of frontend code and 804 lines of backend service, it is one of the largest and most complex components in the Stock module.</p>

        <h3>6.1.2 &mdash; The Two Data Streams</h3>
        <p>Every piece of data in Projeksiyon comes from one of two sources:</p>

        <div class="arch-grid">
            <div class="arch-box" style="border-left: 4px solid #dc2626;">
                <h4>EKS&Idot; (MINUS) &mdash; Material Requirements</h4>
                <p><strong>Source:</strong> <code>work_cards</code> table (Production module)</p>
                <p><strong>Key field:</strong> <code>sevkiyat_week</code> (delivery week, e.g., &ldquo;2026-W12&rdquo;)</p>
                <p><strong>What it extracts:</strong> Each work card carries a <code>material_details</code> JSON. The service maps 5 machine types to 8 material categories:</p>
                <ul>
                    <li><code>kabatel_cekme</code> &rarr; <code>copper_kg</code> (Filma&#351;in)</li>
                    <li><code>kalaylama</code> &rarr; <code>tin_kg</code> (Kalay)</li>
                    <li><code>extruder</code> &rarr; plastic, catalyst, dye, antirodent (from <code>insulation_materials[]</code> and <code>sheath_materials[]</code>)</li>
                    <li><code>aktarma</code> &rarr; reels (from <code>makara_distributions[]</code>) &mdash; note: kangal (coilless) uses plastic packaging and is NOT tracked</li>
                    <li><code>paletleme</code> &rarr; palettes (from <code>palettes[]</code>)</li>
                </ul>
                <p><strong>Includes:</strong> ALL statuses except CANCELLED &mdash; even completed work cards count because the plan happened.</p>
            </div>

            <div class="arch-box" style="border-left: 4px solid #16a34a;">
                <h4>ARTI (PLUS) &mdash; Incoming Materials</h4>
                <p><strong>Source:</strong> <code>material_orders</code> table (Hammadde module)</p>
                <p><strong>Key field:</strong> <code>expected_date</code> or <code>delivered_date</code></p>
                <p><strong>Dynamic switching:</strong> For pending/shipped orders, uses <code>expected_date</code> + <code>quantity</code> (the plan). For delivered orders, switches to <code>delivered_date</code> + <code>delivered_quantity</code> (the actual). This means the projection dynamically reflects reality as deliveries happen.</p>
                <p><strong>Material resolution:</strong> The service resolves specific material names via the <code>supplier_material</code> relationship (e.g., not just &ldquo;plastic&rdquo; but &ldquo;HFX 500P&rdquo;). Defaults to category name if no supplier material linked.</p>
                <p><strong>Includes:</strong> ALL statuses except CANCELLED.</p>
            </div>
        </div>

        <h3>6.1.3 &mdash; The Cumulative Calculation Engine</h3>
        <p>The core of Projeksiyon lives in <code>ProjeksiyonService.get_projeksiyon()</code>. The calculation is not a simple &ldquo;show this week&rsquo;s plus and minus&rdquo; &mdash; it is a <strong>full historical running total</strong>:</p>

        <ol>
            <li><strong>Find earliest data:</strong> <code>get_earliest_data_week_offset()</code> scans both work cards (<code>MIN(sevkiyat_week)</code>) and material orders (<code>MIN(expected_date)</code>, <code>MIN(delivered_date)</code>) to find the very first week that has any data. This might be in a previous year (e.g., 2025 orders still affect 2026 projection).</li>
            <li><strong>Generate ALL weeks:</strong> From the earliest data week through the last week in the user&rsquo;s view (e.g., if earliest data is 2025-W40 and the user is viewing 2026-W05 to W14, the system generates weeks from W40 through W14 &mdash; 27 weeks of computation for a 10-week view).</li>
            <li><strong>Fetch requirements and incoming for ALL weeks:</strong> Two bulk queries: one for work cards grouped by <code>sevkiyat_week</code>, one for material orders mapped to their respective weeks.</li>
            <li><strong>Walk through every week in order:</strong> For each week, compute <code>weekly = plus - minus</code> per material category, and add it to the running <code>cumulative</code> total. Also track sub-material cumulatives (e.g., &ldquo;Filma&#351;in 8mm&rdquo; within Copper).</li>
            <li><strong>Capture pre-view state:</strong> Before processing the first week in the user&rsquo;s view window, snapshot the current cumulative state into <code>pre_view_sub_material_cumulatives</code>. This is critical for the frontend&rsquo;s hidden shortage detection.</li>
            <li><strong>Return only view weeks:</strong> Of all the weeks processed, only the 10 weeks the user is actually viewing are included in the response. But their cumulative values include ALL historical data.</li>
        </ol>

        <div class="warning">
            <p style="margin-bottom: 0;"><strong>Why not just compute the view window?</strong> If you only compute weeks 5&ndash;14 and a massive copper delivery happened in week 2, the cumulative for week 5 would show 0 instead of +5000 kg. Historical context is essential for accurate cumulative balances. The trade-off is more computation per request, but the data volume (hundreds of work cards and orders, not millions) makes this approach viable without caching.</p>
        </div>

        <h3>6.1.4 &mdash; Detail Consolidation</h3>
        <p>Both <code>get_requirements_by_week()</code> and <code>get_incoming_by_week()</code> produce not only aggregate totals per category but also <strong>detailed breakdowns by specific material name</strong>. For example, an Extruder work card might consume 200 kg of &ldquo;HFX 500P&rdquo; and 150 kg of &ldquo;HFFR 302&rdquo; &mdash; both are &ldquo;plastic&rdquo; but tracked individually.</p>
        <p>After processing all cards/orders, the service <strong>consolidates</strong> duplicate names within each week. If two Extruder cards in the same week both consume &ldquo;HFX 500P&rdquo;, their quantities are merged into a single detail entry. This consolidation runs across all 8 detail arrays (copper_details, tin_details, plastic_details, catalyst_details, dye_details, antirodent_details, makara_details, palette_details).</p>

        <h3>6.1.5 &mdash; API Endpoints</h3>
        <table>
            <tr><th>Method</th><th>Path</th><th>Parameters</th><th>Purpose</th></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon</code></td><td><code>weeks</code> (4&ndash;52, default 10), <code>offset</code> (&minus;260 to +260)</td><td>Main endpoint. Returns weekly breakdown with PLUS/MINUS/cumulative per material category, sub-material cumulatives per week, requirement and incoming detail arrays, work card and order counts, navigation metadata, and pre-view sub-material cumulatives for shortage detection.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/summary</code></td><td><code>weeks</code> (4&ndash;52, default 8)</td><td>Shortage alert endpoint. Scans all weeks for any material category with a negative cumulative, returns a flat list of shortage events with material key, label, week, cumulative value, and unit.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/material/{type}</code></td><td><code>type</code> (8 valid types), <code>weeks</code></td><td>Per-material detail. Returns week-by-week plus/minus/cumulative for a single material type. Includes plastic_details breakdown for the plastic type.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/debug</code></td><td>&mdash;</td><td>Debug endpoint. Shows unique <code>sevkiyat_week</code> values in the database, card counts per week, sample work cards with their <code>material_details</code> keys, and sample material orders. Used during development to verify data mapping.</td></tr>
        </table>

        <h3>6.1.6 &mdash; Frontend Architecture (3,323 Lines)</h3>
        <p>The Projeksiyon page is a single React component with two tabs: <strong>Projeksiyon</strong> (table view) and <strong>Grafikler</strong> (charts view). Both tabs consume the same API response.</p>

        <h4>State Management</h4>
        <table>
            <tr><th>State Variable</th><th>Type</th><th>Purpose</th></tr>
            <tr><td><code>projeksiyonData</code></td><td><code>ProjeksiyonResponse | null</code></td><td>The entire API response, shared between both tabs</td></tr>
            <tr><td><code>weekOffset</code></td><td><code>number</code></td><td>Current week offset from H01. Changed by navigation arrows. Triggers API refetch.</td></tr>
            <tr><td><code>expandedMaterials</code></td><td><code>string[]</code></td><td>Which material columns are currently expanded to show sub-materials</td></tr>
            <tr><td><code>knownSubMaterials</code></td><td><code>Record&lt;string, string[]&gt;</code></td><td>Persists discovered sub-material names across navigations so expand arrows don&rsquo;t disappear</td></tr>
            <tr><td><code>graphType</code></td><td><code>'line' | 'heatmap' | 'waterfall'</code></td><td>Active chart type (waterfall is actually radar)</td></tr>
            <tr><td><code>selectedGraphMaterials</code></td><td><code>string[]</code></td><td>Material filter for charts. Empty = &ldquo;T&uuml;m&uuml;&rdquo; (all). 1&ndash;3 = detail mode with sub-material breakdown.</td></tr>
            <tr><td><code>radarViewMode</code></td><td><code>'merged' | 'individual'</code></td><td>Radar chart display mode: 4 weeks overlapping vs. paginated individual spiders</td></tr>
            <tr><td><code>radarPage</code></td><td><code>number</code></td><td>Current page for individual radar mode pagination</td></tr>
            <tr><td><code>activeTab</code></td><td><code>'projeksiyon' | 'grafikler'</code></td><td>Current tab</td></tr>
        </table>

        <h3>6.1.7 &mdash; Tab 1: The Projection Table</h3>
        <p>The table is the primary interface. It displays 10 weeks as rows and 8 material categories as columns. The table is NOT an Ant Design <code>ProTable</code> &mdash; it is a plain <code>Table</code> with heavily customized column rendering.</p>

        <h4>Column Structure</h4>
        <p>Each material column renders three pieces of information per cell:</p>
        <ul>
            <li><strong>Incoming (PLUS):</strong> Green upward arrow with the amount of material arriving that week</li>
            <li><strong>Consumption (MINUS):</strong> Red downward arrow with the amount of material being consumed</li>
            <li><strong>Cumulative:</strong> A color-coded <code>Tag</code> showing the running total. Green if positive (surplus), red if negative (shortage), grey if zero.</li>
        </ul>

        <h4>Expandable Sub-Material Columns</h4>
        <p>This is one of the most distinctive features. Each material column header has a small expand arrow. Clicking it reveals <strong>individual sub-material columns</strong> nested under the parent. For example, expanding &ldquo;Plastik&rdquo; might reveal columns for &ldquo;HFX 500P&rdquo;, &ldquo;HFFR 302&rdquo;, and &ldquo;XLPE&rdquo; &mdash; each showing their own plus/minus/cumulative within that week.</p>
        <p>Sub-material names are discovered from the API response&rsquo;s detail arrays and persisted in <code>knownSubMaterials</code> so they survive week navigation. When a column is NOT expanded, it collapses to a <strong>20px-wide color bar</strong> with a traffic-light indicator (green dot = all positive, red dot = any negative cumulative, yellow dot = mixed). This compact view lets users see all 8 materials at once without horizontal scrolling.</p>

        <h4>Week Navigation</h4>
        <p>Left/right arrows shift the 10-week window by 10 weeks at a time (via <code>weekOffset</code> state). A calendar icon resets to the current week (<code>offset = 0</code>). The API enforces limits of &minus;260 to +260 (5 years each direction). Each navigation triggers a new API call; the backend recalculates from scratch.</p>

        <h4>Summary Row</h4>
        <p>The last row of the table shows the final cumulative for each material across the entire view window. It serves as the &ldquo;bottom line&rdquo; &mdash; after all incoming and consumption for these 10 weeks, this is where each material stands.</p>

        <h3>6.1.8 &mdash; Hidden Shortage Detection</h3>
        <p>This is the most sophisticated feature in the entire Stock module. The problem it solves:</p>

        <div class="finding">
            <p><strong>Scenario:</strong> The aggregate &ldquo;Plastic&rdquo; cumulative for week H12 is <span class="good">+2,500 kg</span>. Everything looks fine. But hidden inside, sub-material &ldquo;HFX 500P&rdquo; is at <span class="bad">&minus;180 kg</span> while &ldquo;HFFR 302&rdquo; has <span class="good">+2,680 kg</span>. The surplus of one plastic masks the shortage of another. You cannot substitute HFFR for HFX &mdash; they are chemically different compounds.</p>
        </div>

        <p><strong>How it works:</strong></p>
        <ol>
            <li>The backend tracks <code>sub_material_cumulatives</code> as a dictionary keyed by <code>category_materialName</code> (e.g., <code>plastic_HFX 500P</code>). This is updated for EVERY week (not just the view window).</li>
            <li>Each week in the response carries its own <code>sub_material_cumulatives</code> snapshot.</li>
            <li>The frontend checks: if the parent category cumulative is &ge; 0 but ANY sub-material within that category has a negative cumulative, this is a <strong>hidden shortage</strong>.</li>
            <li>Visual indicator: the cell gets a <span class="bad">red border</span> on a <span class="good">green background</span> with a warning tooltip listing which specific sub-materials are in deficit.</li>
        </ol>
        <p>This detection works across all three visualization modes (table, line chart, heatmap, radar). In the radar chart, hidden shortages are indicated by a special rich-text label style that combines green text with a red indicator.</p>

        <h3>6.1.9 &mdash; Tab 2: Charts View</h3>
        <p>The charts tab provides three interchangeable visualization types, all powered by <strong>ReactECharts</strong> (<code>echarts-for-react</code>). All share the same data from <code>projeksiyonData</code> and respond to the same week navigation and material filter controls.</p>

        <h4>Material Filter Pills</h4>
        <p>A row of clickable pills at the top allows filtering by material. Three modes:</p>
        <ul>
            <li><strong>T&uuml;m&uuml; (All):</strong> No filter selected. Charts show aggregate cumulative lines for all materials. No sub-material breakdown.</li>
            <li><strong>1&ndash;3 materials selected (Detail Mode):</strong> Charts switch to showing sub-material stacked bars for consumption and incoming, with cumulative overlay lines per sub-material. This is where the hidden shortage detection becomes most visible.</li>
            <li><strong>4+ materials:</strong> Not allowed. The UI enforces a maximum of 3 selections by deselecting the oldest when a 4th is clicked. This prevents chart overcrowding.</li>
        </ul>

        <h4>Chart Type 1: Line Chart</h4>
        <p>Smooth cumulative lines with gradient area fill. In overview mode, each material gets its own line (copper=orange, tin=cyan, plastic=purple, etc.). A dashed red zero-line marks the shortage threshold. In detail mode, sub-materials get stacked bar charts for consumption (negative, red) and incoming (positive, green), with individual cumulative overlay lines.</p>
        <p>The tooltip is extensively customized: it shows the week label, date range, sections for &ldquo;K&Uuml;M&Uuml;LAT&Idot;F&rdquo; (cumulative), &ldquo;KULLANILAN (Bu Hafta)&rdquo; (consumption), &ldquo;&Idot;HT&Idot;YA&Ccedil; (Eksik)&rdquo; (shortages), and &ldquo;GELEN (Bu Hafta)&rdquo; (incoming). Shortages use a 2-column grid layout when there are more than 6 items.</p>

        <h4>Chart Type 2: Heatmap</h4>
        <p>A grid with weeks on the x-axis and materials/sub-materials on the y-axis. Each cell is colored on a red-to-green gradient based on cumulative value. The coloring uses <strong>per-material normalization</strong> &mdash; each material row is normalized independently so a +5000 kg copper surplus and a +50 adet palette surplus both appear equally green.</p>
        <p>Custom HTML axis tooltips appear on hover over material labels. These tooltips show detailed shortage information: which weeks this material first goes negative, whether the shortage is increasing or decreasing, and which specific sub-materials are affected. Shortage information is pre-calculated and stored in <code>heatmapShortageInfoRef</code> for efficient event handling.</p>

        <h4>Chart Type 3: Radar Chart</h4>
        <p>Operates in two modes:</p>
        <ul>
            <li><strong>Merged mode:</strong> Last 4 weeks overlapping on a single radar. Each week gets a different color (grey, amber, purple, cyan). Materials are positioned around the perimeter with rich-text labels showing the material name and cumulative value, colored green/red by sign. A dashed circle at the 50 mark represents the zero line (scale is normalized 0&ndash;100).</li>
            <li><strong>Individual mode:</strong> Paginated display showing 4 weeks per page as separate spider diagrams side by side. Each has its own radar with the week label below. Left/right arrows paginate through weeks.</li>
        </ul>
        <p>In both modes, hidden shortages are visualized using a special label format: the material name appears with an amber/warning color and the value shows green with a red warning indicator.</p>

        <h3>6.1.10 &mdash; Dashboard Statistics Cards</h3>
        <p>Above the charts, 4 statistic cards provide a quick summary:</p>
        <ul>
            <li><strong>Toplam Gelen (Total Incoming):</strong> Sum of all PLUS across all materials and weeks</li>
            <li><strong>Toplam &Idot;htiya&ccedil; (Total Consumption):</strong> Sum of all MINUS across all materials and weeks</li>
            <li><strong>Net Bakiye (Net Balance):</strong> Total incoming minus total consumption. Green if positive, red if negative.</li>
            <li><strong>Stok Sa&gbreve;l&inodot;&gbreve;&inodot; (Health Score):</strong> A percentage calculated as <code>(totalPlus / totalMinus) &times; 50</code>, capped at 0&ndash;100. Rendered as a Progress bar. Below 50% = red, 50&ndash;80% = yellow, above 80% = green.</li>
        </ul>

        <h3>6.1.11 &mdash; Extruder Material Extraction Logic</h3>
        <p>The most complex material mapping is for Extruder work cards. A single Extruder card can consume multiple materials simultaneously because cable extrusion involves layered coatings:</p>

        <ol>
            <li><strong>Insulation materials</strong> (<code>insulation_materials[]</code>): Each entry has <code>material_name</code> (plastic type), <code>plastic_kg</code>, <code>catalyst_name</code>, <code>catalyst_kg</code>, and <code>dyes[]</code> array with <code>dye_name</code> and <code>dye_kg</code>.</li>
            <li><strong>Sheath materials</strong> (<code>sheath_materials[]</code>): Same structure as insulation but also includes <code>antirodent_name</code> and <code>antirodent_kg</code> (only the outer sheath can have rodent repellent).</li>
        </ol>
        <p>The service walks through both arrays, extracting individual material names and quantities. This means a single Extruder work card can produce detail entries for 3&ndash;4 different plastics, 2 catalysts, 2 dyes, and 1 antirodent &mdash; all mapped to their respective category detail arrays and consolidated if the same material name appears in multiple cards for the same week.</p>

        <h3>6.1.12 &mdash; Week Key System</h3>
        <p>All temporal data in Projeksiyon uses ISO week keys in the format <code>YYYY-WNN</code> (e.g., &ldquo;2026-W12&rdquo;). The service provides utility functions:</p>
        <ul>
            <li><code>get_week_key(date)</code>: Converts a Python <code>date</code> to its ISO week key</li>
            <li><code>week_key_to_offset(week_key)</code>: Converts a week key to an integer offset from H01 of the current year. Used to compare weeks across year boundaries (e.g., 2025-W52 = offset &minus;1 from 2026-W01).</li>
            <li><code>generate_weeks(num_weeks, offset)</code>: Produces week metadata including week_key, week_label (H01&ndash;H52), date range in Turkish (e.g., &ldquo;06-12 Oca&rdquo;), and ISO start/end dates.</li>
        </ul>
        <p>The week labels displayed in the UI use <code>HNN</code> format (e.g., H01, H12, H52) with Turkish month abbreviations in the date range (Oca, &#350;ub, Mar, Nis, May, Haz, Tem, A&#287;u, Eyl, Eki, Kas, Ara).</p>

        <h3>6.1.13 &mdash; What Changes the Projection</h3>
        <p>Since the projection is computed on-the-fly, any change to its source data immediately affects the output:</p>
        <table>
            <tr><th>Action</th><th>Effect on Projection</th></tr>
            <tr><td>New work card created</td><td>MINUS increases for the card&rsquo;s <code>sevkiyat_week</code></td></tr>
            <tr><td>Work card&rsquo;s <code>sevkiyat_week</code> changed</td><td>MINUS moves from old week to new week</td></tr>
            <tr><td>Work card cancelled</td><td>MINUS disappears (CANCELLED excluded from query)</td></tr>
            <tr><td>New material order created</td><td>PLUS appears in the <code>expected_date</code> week</td></tr>
            <tr><td>Material order&rsquo;s expected date changed</td><td>PLUS moves from old week to new week</td></tr>
            <tr><td>Material order quantity changed</td><td>PLUS amount changes for that week</td></tr>
            <tr><td>Material order delivered</td><td>PLUS switches from <code>expected_date</code>/<code>quantity</code> to <code>delivered_date</code>/<code>delivered_quantity</code> &mdash; week and amount may both shift</td></tr>
            <tr><td>Material order cancelled</td><td>PLUS disappears entirely</td></tr>
            <tr><td>Production physically completes</td><td><strong>No effect</strong> &mdash; completed work cards are still included</td></tr>
        </table>

        <h3>6.1.14 &mdash; Permission Model</h3>
        <p>Projeksiyon uses the <code>canStok</code> route guard from <code>access.ts</code>. The permission manifest defines 4 buttons: <code>access_page</code>, <code>view_projections</code>, <code>create_projection</code>, <code>edit_projection</code>. However, since Projeksiyon is entirely read-only (no CRUD operations), the create and edit permissions are vestigial &mdash; there is nothing to create or edit. The effective access control is simply whether the user can access the Stock pages.</p>

        <h3>6.1.15 &mdash; What This Submodule Does NOT Do</h3>
        <ul>
            <li>It does <strong>not</strong> store any data &mdash; no dedicated database table exists</li>
            <li>It does <strong>not</strong> support CRUD &mdash; the projection is computed, not edited</li>
            <li>It does <strong>not</strong> use WebSocket &mdash; data is fetched once per page load or navigation</li>
            <li>It does <strong>not</strong> cache results &mdash; every request computes from scratch</li>
            <li>It does <strong>not</strong> account for current physical stock &mdash; it only tracks planned consumption vs. planned/actual arrivals</li>
            <li>It does <strong>not</strong> send alerts &mdash; shortage detection is visual only (the <code>/summary</code> endpoint exists but is not consumed by any notification system)</li>
            <li>It does <strong>not</strong> track kangal (coilless cable packaging) &mdash; kangal uses plastic packaging which is not a tracked raw material</li>
        </ul>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>The design philosophy:</strong> Projeksiyon deliberately avoids storing its own state. By computing everything on-the-fly from work cards and material orders, it guarantees that the projection always reflects the absolute latest version of the plan. There is no synchronization problem, no stale cache, no &ldquo;last refreshed 2 hours ago&rdquo; warning. The price is computation per request, but the data scale (hundreds of records, not millions) makes this a good trade-off. If the factory grows to tens of thousands of work cards, a materialized view or caching layer can be added without changing the API contract.</p>
        </div>


        <!-- ============================================= -->
        <!--  6.2  HAMMADDE STOK (Raw Material Stock)       -->
        <!-- ============================================= -->

        <h2 id="sec-6-2">6.2 &mdash; Hammadde Stok (Raw Material Stock)</h2>

        <h3>6.2.1 &mdash; Purpose and Business Context</h3>
        <p>Hammadde Stok answers the question <strong>&ldquo;What raw materials do we physically have in the warehouse right now, and how much of each is still available?&rdquo;</strong></p>
        <p>This page exists because of a specific business need: the Hammadde module already has <strong>Hammaddeler Listesi</strong> (Materials List) &mdash; a flat, 14-column admin table that shows every individual material record with photos, WebSocket real-time updates, bilingual search, and granular edit forms. But Hammaddeler Listesi is a <em>record-level</em> view. A stock manager doesn&rsquo;t want to scroll through 500 individual QR-coded entries to answer &ldquo;how many kilograms of HFX 500P plastic do we have?&rdquo; They need an <em>aggregated category-level</em> view that groups materials by type and name, shows totals, and highlights what&rsquo;s available vs. what&rsquo;s in use.</p>
        <p>The data that populates this page comes from two upstream flows:</p>
        <ul>
            <li><strong>Hammadde Giri&#351;i (Material Entry)</strong> creates the records &mdash; every time raw material arrives at the factory, an operator scans it through one of four entry archetypes (copper, tin, lot-based, count-based), and it enters the <code>materials</code> table with <code>status = 'received'</code> and <code>remaining_weight = weight</code>.</li>
            <li><strong>&Uuml;retim (Production)</strong> consumes the records &mdash; when Production modules (especially Kabatel &Ccedil;ekme / wire drawing) use a raw material, they select it by QR code and deduct from its <code>remaining_weight</code>. A 1,000 kg copper rod (A1) that goes through wire drawing comes back as 980 kg. Production also changes <code>status</code>: <code>received</code> &rarr; <code>in_use</code> (material is currently on a machine) &rarr; <code>consumed</code> (fully depleted). This is exactly what the &ldquo;Kalan&rdquo; (Remaining) column and the conditional coloring (yellow/red) are designed to show.</li>
        </ul>
        <p>So Hammadde Stok sits at the intersection: Hammadde Giri&#351;i fills it, Production drains it, and this page visualizes the current balance. It reads directly from the <code>materials</code> table (owned by the Hammadde module) via the shared <code>/api/materials/list</code> endpoint &mdash; it has no backend routes of its own. All grouping and aggregation happens client-side.</p>
        <p>The page is implemented as a single React component (<code>HammaddeStok</code>) in <code>src/pages/Stok/HammaddeStok/index.tsx</code> (676 lines), using Ant Design&rsquo;s <code>Collapse</code> with nested <code>Table</code> components, wrapped in a <code>ConfigProvider</code> with Turkish locale (<code>trTR</code>).</p>

        <h3>6.2.2 &mdash; CRUD Flow</h3>

        <p><strong>Read (Primary Operation):</strong></p>
        <ol>
            <li>Page loads &rarr; <code>useEffect([], [])</code> triggers <code>fetchMaterials()</code> on mount</li>
            <li>Single <code>GET /api/materials/list</code> call fetches ALL raw materials as a flat array, regardless of type</li>
            <li>Response passes through <code>processAndGroupMaterials()</code> which: filters by <code>material_type</code> into 8 buckets, groups within each bucket by <code>material_name</code>, calculates aggregate totals (total, reserved, available), and stores everything in the <code>sectionData</code> state object</li>
            <li>User clicks a Collapse panel to see the grouped table for that category</li>
            <li>User clicks the expand arrow on a group row to see individual lots with QR codes, weights, supplier, dates, and status</li>
            <li>User can click the &ldquo;Yenile&rdquo; (Refresh) button in the page header to re-fetch all data at any time</li>
        </ol>

        <p><strong>Update (Edit Modal):</strong></p>
        <ol>
            <li>Click the <code>EditOutlined</code> icon on any individual item row (Level 3)</li>
            <li>Modal opens with title &ldquo;D&uuml;zenle: {QR_CODE}&rdquo; (e.g., &ldquo;D&uuml;zenle: A7&rdquo;)</li>
            <li>Form pre-fills from the selected item&rsquo;s current values via <code>form.setFieldsValue()</code></li>
            <li>Two fields available (see 6.2.10 for full details):
                <ul>
                    <li><code>remaining_weight</code> &mdash; <code>InputNumber</code>, min=0, step=0.1. <strong>Hidden</strong> for palette/reel types</li>
                    <li><code>status</code> &mdash; <code>Select</code> dropdown with 5 options</li>
                </ul>
            </li>
            <li>On submit: <code>PUT /api/materials/update/{id}</code> with the form values</li>
            <li>On success: <code>message.success('G&uuml;ncellendi')</code> &rarr; modal closes &rarr; form resets &rarr; <code>fetchMaterials()</code> refetches all data</li>
            <li>On failure: <code>message.error('G&uuml;ncellenemedi')</code></li>
        </ol>

        <p><strong>Delete (Hard Delete with Confirmation):</strong></p>
        <ol>
            <li>Click the <code>DeleteOutlined</code> icon (styled with <code>color: '#ff4d4f'</code>) on any individual item row</li>
            <li><code>Modal.confirm()</code> opens with title &ldquo;Silme Onay&#305;&rdquo;, content &ldquo;{QR_CODE} kodlu malzemeyi silmek istedi&#287;inize emin misiniz?&rdquo;, a red &ldquo;Sil&rdquo; (Delete) button, and an &ldquo;&#304;ptal&rdquo; (Cancel) button</li>
            <li>On confirm: <code>DELETE /api/materials/{id}/hard-delete</code> &mdash; this is a <strong>permanent, irreversible</strong> deletion. The material record and all associated <code>material_photos</code> records are removed from the database</li>
            <li>On success: <code>message.success('Silindi')</code> &rarr; <code>fetchMaterials()</code> refetches</li>
            <li>On failure: <code>message.error('Silinemedi')</code></li>
        </ol>

        <p><strong>Create:</strong> Not available on this page. Material creation happens exclusively through the Hammadde Giri&#351;i (Material Entry) page in the Hammadde module. This page only provides read, update, and delete operations.</p>

        <h3>6.2.3 &mdash; Data Source and API</h3>
        <p>Hammadde Stok consumes three API endpoints, all owned by the Hammadde module (<code>material_routes.py</code>), not the Stock module:</p>
        <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
            <thead>
                <tr style="background: var(--bg-secondary);">
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Method</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Path</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">What It Returns</th>
                </tr>
            </thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>GET</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>/api/materials/list</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">ALL raw materials as a flat JSON array. Each object includes: <code>id</code>, <code>qr_code</code>, <code>material_type</code>, <code>material_name</code>, <code>supplier_name</code>, <code>lot_number</code>, <code>weight</code> (original measured weight at entry), <code>remaining_weight</code> (current weight after production consumption), <code>form_weight</code> (supplier&rsquo;s declared weight), <code>quantity</code> (label count for lot-based materials), <code>received_date</code> (ISO datetime), <code>status</code> (string: received/available/in_use/consumed/rejected)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>PUT</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>/api/materials/update/{id}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Updates <code>remaining_weight</code> and/or <code>status</code> on a single material record. Called from the edit modal.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>DELETE</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>/api/materials/{id}/hard-delete</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Permanently removes the material and its associated photos from the database. Called from the delete confirmation modal.</td></tr>
            </tbody>
        </table>
        <p>The API response is a flat array &mdash; no server-side grouping, filtering, or pagination. The frontend receives every material regardless of type and handles all grouping logic client-side. This means the entire raw material inventory loads in a single request.</p>

        <h3>6.2.4 &mdash; State Management Architecture</h3>
        <p>The component manages 5 pieces of state:</p>
        <ul>
            <li><strong><code>allMaterials</code></strong> (<code>RawMaterial[]</code>) &mdash; the raw API response, stored for potential re-processing</li>
            <li><strong><code>loading</code></strong> (<code>boolean</code>) &mdash; true during the <code>fetchMaterials()</code> call, drives the &ldquo;Yenile&rdquo; button spinner and the loading indicator inside each panel</li>
            <li><strong><code>sectionData</code></strong> (<code>Record&lt;string, SectionData&gt;</code>) &mdash; the core data structure, keyed by material type. Each entry holds: <code>groups</code> (array of <code>MaterialGroupSummary</code>), <code>loading</code>, <code>expandedKeys</code> (which group rows are expanded), and <code>totalItems</code> (count of individual materials in this category). Initialized with all 8 category keys and empty defaults.</li>
            <li><strong><code>activePanels</code></strong> (<code>string[]</code>) &mdash; which Collapse panels are open. Passed to <code>Collapse</code> via <code>activeKey</code>.</li>
            <li><strong><code>editModalVisible</code></strong> + <strong><code>editingItem</code></strong> &mdash; controls the edit modal visibility and which material is being edited</li>
        </ul>
        <p>The <code>SectionData</code> structure preserves <code>expandedKeys</code> across data refetches. When the user edits or deletes a material and the page refetches, the <code>processAndGroupMaterials()</code> function reads the previous <code>expandedKeys</code> via <code>sectionData[cat.key]?.expandedKeys || []</code> and carries them into the new state. This means open group rows stay open after an update &mdash; the user does not lose their scroll position or expanded state.</p>

        <h3>6.2.5 &mdash; The 8 Material Category Panels</h3>
        <p>The page renders an Ant Design <code>Collapse</code> component with 8 panels, one per material category. The categories are defined in a constant <code>MATERIAL_CATEGORIES</code> array, each with a <code>key</code>, <code>label</code> (Turkish name), <code>icon</code> (Ant Design icon component), and <code>color</code>. The categories match the Hammadde Giri&#351;i page&rsquo;s card colors exactly:</p>

        <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
            <thead>
                <tr style="background: var(--bg-secondary);">
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Category</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Key</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Icon</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Color</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Unit</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">QR Prefix</th>
                </tr>
            </thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Bak&#305;r (Copper)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_copper</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>MenuOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#cd7f32 (bronze)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">A</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Kalay (Tin)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_tin</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>GoldOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#c0c0c0 (silver)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">B</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Plastik (Plastic)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_plastic</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>DockerOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#3498db (blue)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">C</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Kataliz&ouml;r (Catalyst)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_catalyst</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>ExperimentOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#9b59b6 (purple)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">D</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Boya (Dye)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_dye</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>BgColorsOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#e74c3c (red)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">E</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Antirodent</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_antirodent</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>BugOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#27ae60 (green)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">F</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Palet (Palette)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_palette</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>BorderInnerOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#f39c12 (orange)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">adet</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">I</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Makara (Reel)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_reel</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>PicCenterOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#1abc9c (teal)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">adet</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">H</td></tr>
            </tbody>
        </table>
        <p>The categories and their visual identity are shared with Hammadde Giri&#351;i &mdash; a user sees the same colors and icons across both modules for consistency.</p>

        <h3>6.2.6 &mdash; Panel Header: Inline Statistics Dashboard</h3>
        <p>Each panel header is not just a label &mdash; it is a mini dashboard visible even when collapsed. From left to right it shows: the color-coded category icon, the category name, a record count tag (e.g., &ldquo;47 kay&#305;t&rdquo;), and three aggregate statistics pushed to the right:</p>
        <ul>
            <li><strong>Toplam (Total):</strong> Sum of <code>remaining_weight</code> for kg-based materials (falls back to <code>weight</code> if remaining is null), sum of <code>weight</code> (count) for palette/reel. Turkish locale formatting (e.g., &ldquo;12.456,3 kg&rdquo;).</li>
            <li><strong>Kullan&#305;mda (In Use):</strong> Blue tag. Sum from items where <code>status === 'in_use'</code> &mdash; materials currently on a production machine.</li>
            <li><strong>Serbest (Available):</strong> Green tag. Sum from items where <code>status === 'received'</code> or <code>'available'</code> &mdash; materials ready for production to consume.</li>
        </ul>
        <p>The <code>getCategoryTotals()</code> function computes these by iterating all groups and summing <code>total_quantity</code>, <code>reserved_quantity</code>, and <code>available_quantity</code>. Unit is &ldquo;adet&rdquo; for palette/reel, &ldquo;kg&rdquo; for everything else.</p>

        <h3>6.2.7 &mdash; Three-Level Table Hierarchy</h3>
        <p>The page implements a three-level drill-down that lets users navigate from high-level category totals down to individual lot details:</p>

        <p><strong>Level 1 &mdash; Category Panel (Collapse):</strong> The 8 Collapse panels themselves. Each panel header shows category name + icon + aggregate statistics. Opening a panel reveals the Level 2 table. Multiple panels can be open simultaneously &mdash; the <code>activePanels</code> state is an array of keys.</p>

        <p><strong>Level 2 &mdash; Material Name Group Table:</strong> Inside each panel, materials are grouped by <code>material_name</code>. For example, under &ldquo;Plastik&rdquo;, you see groups: &ldquo;HFX 500P&rdquo;, &ldquo;HFFR 302&rdquo;, &ldquo;XLPE 2003&rdquo;, &ldquo;PVC 70&rdquo;. Each group row shows: <strong>Malzeme Ad&#305;</strong> (bold name + lot count, e.g., &ldquo;HFX 500P (12 lot)&rdquo;), <strong>Toplam</strong> (aggregate weight/quantity), <strong>Kullan&#305;mda</strong> (blue tag, in-use total), <strong>Serbest</strong> (green tag, available total). If a material has no name, it falls into &ldquo;{Category} (&#304;simsiz)&rdquo;.</p>

        <p><strong>Level 3 &mdash; Individual Lots (Expanded Row):</strong> Expanding a group row reveals the individual material entries. The detail table shows 7&ndash;8 columns:</p>
        <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
            <thead>
                <tr style="background: var(--bg-secondary);">
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Column</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Behavior</th>
                </tr>
            </thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">QR Kod</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Blue tag showing the deterministic QR code (A1, B3, C12, etc.). Pinned left.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">&Ouml;l&ccedil;&uuml;len / Miktar</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Original weight at entry. Title adapts: &ldquo;&Ouml;l&ccedil;&uuml;len&rdquo; for kg types, &ldquo;Miktar&rdquo; for palette/reel.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Kalan (Remaining)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Current remaining weight after Production consumption. <strong>Absent</strong> for palette/reel. Uses <code>remaining_weight ?? weight</code> fallback. <strong>Color-coded</strong> (see 6.2.8).</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Durum (Status)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Color-coded tag: green=Teslim Al&#305;nd&#305; (received), blue=Mevcut (available), orange=Kullan&#305;mda (in_use by Production), grey=T&uuml;kendi (consumed), red=Reddedildi (rejected by Lab)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Tedarik&ccedil;i</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Supplier name from Tedarik&ccedil;i Y&ouml;netimi, or &ldquo;-&rdquo; if none</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Lot No</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Lot/batch number from Hammadde Giri&#351;i, or &ldquo;-&rdquo; if none</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Giri&#351; Tarihi</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Entry date, converted from UTC to Europe/Istanbul timezone. DD.MM.YY format.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">&#304;&#351;lem (Actions)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Edit and Delete buttons. Pinned right.</td></tr>
            </tbody>
        </table>

        <h3>6.2.8 &mdash; Conditional Weight Coloring</h3>
        <p>The &ldquo;Kalan&rdquo; (Remaining) column is one of the most operationally important visual features on this page. It uses conditional coloring to provide instant visual feedback about material consumption levels. The logic computes two boolean flags for each row:</p>
        <ul>
            <li><code>isReduced = currentWeight &lt; originalWeight * 0.95</code> &mdash; the material has been partially consumed (more than 5% used)</li>
            <li><code>isLow = currentWeight &lt; originalWeight * 0.2</code> &mdash; the material is critically low (less than 20% remaining)</li>
        </ul>
        <p>The rendering rules:</p>
        <ul>
            <li><strong>Normal (no color, normal weight):</strong> <code>remaining_weight &ge; 95%</code> of original &mdash; material is barely touched or freshly entered</li>
            <li><strong style="color: #faad14;">Yellow (#faad14) + bold (fontWeight: 600):</strong> <code>remaining_weight &lt; 95%</code> but &ge; 20% of original &mdash; partially consumed, draw attention</li>
            <li><strong style="color: #ff4d4f;">Red (#ff4d4f) + bold (fontWeight: 600):</strong> <code>remaining_weight &lt; 20%</code> of original &mdash; critically low, needs reorder</li>
        </ul>
        <p>Concrete example: A 1,000 kg copper wire rod (QR: A1) shows normal text until it drops below 950 kg. At 949 kg it turns yellow. At 199 kg it turns red. The <code>currentWeight</code> is computed as <code>remaining_weight ?? weight ?? 0</code> for backward compatibility with older records that don&rsquo;t have <code>remaining_weight</code> set.</p>
        <p>For palette and reel materials, this column is <strong>completely absent</strong> from the table &mdash; not hidden, but conditionally excluded from the columns array using a spread with empty array: <code>...(!isPaletteOrReel ? [{ ... }] : [])</code>. Counted items don&rsquo;t have a remaining weight concept &mdash; they are either available or consumed as whole units.</p>

        <h3>6.2.9 &mdash; Unit Adaptation: kg vs adet</h3>
        <p>The page dynamically adapts its behavior based on whether a material is measured by weight or counted as discrete pieces. This distinction affects <strong>five different places</strong> in the UI:</p>
        <ol>
            <li><strong>Panel header statistics:</strong> Show &ldquo;kg&rdquo; or &ldquo;adet&rdquo; after aggregate numbers</li>
            <li><strong>Group table columns:</strong> Unit suffix on Toplam, Kullan&#305;mda, Serbest values</li>
            <li><strong>Detail table column title:</strong> &ldquo;&Ouml;l&ccedil;&uuml;len&rdquo; (Measured) for kg types vs &ldquo;Miktar&rdquo; (Quantity) for adet types</li>
            <li><strong>Detail table &ldquo;Kalan&rdquo; column:</strong> Completely hidden for palette/reel</li>
            <li><strong>Edit modal:</strong> The &ldquo;Kalan A&#287;&#305;rl&#305;k (kg)&rdquo; field is hidden for palette/reel types</li>
        </ol>
        <p>The determination is made by checking <code>materialType === 'raw_palette' || materialType === 'raw_reel'</code>. These are the only two count-based categories &mdash; all six others use kg. For quantity calculations in the grouping logic, palette/reel materials read from <code>item.weight</code> (which stores the count), while kg-based materials read from <code>item.remaining_weight ?? item.weight</code>.</p>

        <h3>6.2.10 &mdash; Client-Side Grouping Logic</h3>
        <p>The <code>processAndGroupMaterials()</code> function is the core data transformation engine. It takes the flat API response and produces the hierarchical <code>sectionData</code> structure. The function runs in four stages:</p>
        <ol>
            <li><strong>Category filter:</strong> For each of the 8 categories, filter <code>materials.filter(m =&gt; m.material_type === cat.key)</code></li>
            <li><strong>Name grouping:</strong> Within each category, build a <code>Record&lt;string, RawMaterial[]&gt;</code> keyed by <code>material_name</code>. If <code>material_name</code> is null/empty, the key becomes &ldquo;{label} (&#304;simsiz)&rdquo; (e.g., &ldquo;Bak&#305;r (&#304;simsiz)&rdquo;)</li>
            <li><strong>Group aggregation:</strong> For each group, create a <code>MaterialGroupSummary</code> object:
                <ul>
                    <li><code>total_quantity</code>: Sum of <code>remaining_weight ?? weight ?? 0</code> for kg types, or <code>weight ?? 0</code> for adet types, across ALL items regardless of status</li>
                    <li><code>reserved_quantity</code>: Sum from items where <code>status === 'in_use'</code></li>
                    <li><code>available_quantity</code>: Sum from items where <code>status === 'received' || status === 'available'</code></li>
                    <li>Items with other statuses (<code>consumed</code>, <code>rejected</code>) are counted in <code>total_quantity</code> but not in reserved or available &mdash; they effectively represent consumed or discarded stock</li>
                </ul>
            </li>
            <li><strong>State preservation:</strong> Carry forward the previous <code>expandedKeys</code> from the existing <code>sectionData</code>, so open group rows remain open after a data refresh</li>
        </ol>

        <h3>6.2.11 &mdash; The Edit Modal</h3>
        <p>The edit modal is deliberately minimal &mdash; a single variant, unlike Hammaddeler Listesi&rsquo;s three variants (copper/tin, lot-based, palette/reel). It provides only two fields:</p>
        <ul>
            <li><strong>Kalan A&#287;&#305;rl&#305;k (Remaining Weight):</strong> A numeric input pre-filled with the material&rsquo;s current <code>remaining_weight</code>. This is the field Production affects when consuming material, and this modal lets a stock manager manually correct it if the system value drifts from physical reality. <strong>Hidden</strong> for palette/reel since those are whole units.</li>
            <li><strong>Durum (Status):</strong> Dropdown with 5 options: Teslim Al&#305;nd&#305; (received), Mevcut (available), Kullan&#305;mda (in_use), T&uuml;kendi (consumed), Reddedildi (rejected). This lets a manager manually override the lifecycle state &mdash; e.g., marking a damaged material as rejected, or correcting a status that Production failed to update.</li>
        </ul>
        <p>Unlike Hammaddeler Listesi, this modal does <strong>not</strong> allow editing QR codes, lot numbers, supplier names, or photos. Those belong to the Hammadde module&rsquo;s full edit flow. This modal is strictly for stock-level corrections: &ldquo;how much is actually left?&rdquo; and &ldquo;what state is it really in?&rdquo;</p>

        <h3>6.2.12 &mdash; Loading and Empty States</h3>
        <p>The page handles two empty-data scenarios:</p>
        <ul>
            <li><strong>Loading state:</strong> While data is being fetched, each panel shows a spinner with &ldquo;Y&uuml;kleniyor...&rdquo;. The &ldquo;Yenile&rdquo; (Refresh) button in the page header also shows a loading state.</li>
            <li><strong>Empty category:</strong> If a category has no materials (e.g., no antirodent currently in stock), the panel shows &ldquo;Bu kategoride stok bulunamad&#305;&rdquo; (No stock found in this category).</li>
        </ul>

        <h3>6.2.13 &mdash; Timezone Handling</h3>
        <p>All dates from the API are stored as UTC in the database. The frontend converts them to Turkey timezone for display using <code>dayjs</code> with the <code>utc</code> and <code>timezone</code> plugins:</p>
        <ul>
            <li>The timezone constant is defined at module level: <code>const TURKEY_TZ = 'Europe/Istanbul'</code></li>
            <li>Date rendering: <code>dayjs.utc(date).tz(TURKEY_TZ).format('DD.MM.YY')</code></li>
            <li>This ensures a material entered at 23:30 UTC on January 15 shows as January 16 in the Turkish display (UTC+3), correctly reflecting the local date of entry</li>
        </ul>

        <h3>6.2.14 &mdash; Connection to Other Modules</h3>
        <p>Hammadde Stok does not exist in isolation &mdash; it is essentially a <strong>read-only window</strong> into data that is created, modified, and consumed by other modules. Understanding those connections is key to understanding this page:</p>

        <p><strong>Upstream: Who fills the inventory?</strong></p>
        <ul>
            <li><strong>Hammadde Giri&#351;i (Material Entry)</strong> &mdash; the sole creator. Every single row visible on this page was created through one of the four entry archetypes in Hammadde Giri&#351;i. When a copper wire rod arrives, an operator weighs it, scans photos, assigns QR code A{n}, and it enters the <code>materials</code> table with <code>status = 'received'</code> and <code>remaining_weight = weight</code>. That record immediately becomes visible here under the &ldquo;Bak&#305;r&rdquo; panel. Hammadde Stok cannot create, only view.</li>
            <li><strong>Hammadde Sipari&#351; (Material Orders)</strong> &mdash; the reason materials arrive in the first place. When a purchase order is fulfilled and materials are delivered, the entry operator can link the material to the order group code (R1, R2, etc.). This traceability exists in the data but is <strong>not displayed</strong> on this page &mdash; it&rsquo;s visible on Hammaddeler Listesi&rsquo;s &ldquo;Sipari&#351; No&rdquo; column instead.</li>
            <li><strong>Tedarik&ccedil;i Y&ouml;netimi (Supplier Management)</strong> &mdash; defines the supplier names that appear in the detail rows. The supplier association is set at entry time and is read-only here.</li>
        </ul>

        <p><strong>Downstream: Who drains the inventory?</strong></p>
        <ul>
            <li><strong>&Uuml;retim / Production (especially Kabatel &Ccedil;ekme)</strong> &mdash; the primary consumer. When Production starts a work card, it selects raw materials by QR code. For wire drawing (Kabatel &Ccedil;ekme), an operator picks a copper rod (e.g., A7) and feeds it into the machine. Production then updates the material record: <code>status</code> changes from <code>received</code>/<code>available</code> to <code>in_use</code>, and <code>remaining_weight</code> decreases as material is consumed. When the rod is fully used, <code>status</code> becomes <code>consumed</code>. This is the entire reason the &ldquo;Kalan&rdquo; column exists with its yellow/red coloring &mdash; it visualizes how much Production has consumed. Similarly, plastic granules, tin, catalysts, and dyes are consumed by their respective production steps (extrusion, tinning, etc.).</li>
            <li><strong>Lab (indirect)</strong> &mdash; Lab tests may result in a material being <code>rejected</code>, which changes its status and effectively removes it from the &ldquo;Serbest&rdquo; (Available) count on this page.</li>
        </ul>

        <p><strong>Sibling views over the same data:</strong></p>
        <ul>
            <li><strong>Hammaddeler Listesi (in Hammadde module)</strong> &mdash; reads from the exact same <code>/api/materials/list</code> endpoint. It is the full-power admin view: 14 columns, lazy-loaded photos, WebSocket real-time sync, bilingual search, three edit form variants, QR label printing, 12 granular permissions. This page is the <em>record-level</em> view; Hammadde Stok is the <em>stock-level</em> view. Together they cover different user needs over identical data.</li>
            <li><strong>Projeksiyon (in Stock module)</strong> &mdash; also uses material data, but for a completely different purpose. Projeksiyon computes what the stock <em>will be</em> in future weeks by combining current inventory + incoming orders &minus; production requirements. Hammadde Stok shows what the stock <em>is right now</em>. They are complementary: one is a live snapshot, the other is a weekly forecast.</li>
        </ul>

        <h3>6.2.15 &mdash; Permission Model</h3>
        <p>The page uses the <code>canStok</code> route guard from <code>access.ts</code> for page-level access. The permission manifest in <code>permissionManifest.ts</code> defines 5 buttons for this page:</p>
        <ul>
            <li><code>access_page</code> &mdash; can access the Hammadde Stok page</li>
            <li><code>view_table</code> &mdash; can see the category tables</li>
            <li><code>view_details</code> &mdash; can expand groups to see individual lots</li>
            <li><code>edit_stock</code> &mdash; can open the edit modal</li>
            <li><code>adjust_quantity</code> &mdash; can modify remaining weight values</li>
        </ul>
        <p>However, unlike Hammaddeler Listesi which enforces permissions at the button level (e.g., disabling the print button without <code>print_qr</code> permission), this page does <strong>not</strong> enforce button-level checks in the frontend. The edit and delete buttons are always rendered for any user who has page access. Permission enforcement happens at the API level only.</p>

        <h3>6.2.16 &mdash; What This Submodule Does NOT Do</h3>
        <ul>
            <li>It does <strong>not</strong> have its own backend routes &mdash; it consumes the Hammadde module&rsquo;s <code>material_routes.py</code> endpoints</li>
            <li>It does <strong>not</strong> support material creation &mdash; that happens exclusively in Hammadde Giri&#351;i</li>
            <li>It does <strong>not</strong> use WebSocket for real-time updates &mdash; data is fetched once on mount and refreshed manually or after edit/delete operations. Compare with Hammaddeler Listesi which subscribes to <code>materials</code> and <code>all</code> WebSocket rooms</li>
            <li>It does <strong>not</strong> have server-side filtering or pagination &mdash; all 8-way category filtering, name-based grouping, and quantity aggregation is client-side</li>
            <li>It does <strong>not</strong> show material photos &mdash; no delivery or test photos are displayed. These are only visible in Hammaddeler Listesi</li>
            <li>It does <strong>not</strong> show order linkage &mdash; the &ldquo;Sipari&#351; No&rdquo; (order group code) column exists in Hammaddeler Listesi but not here</li>
            <li>It does <strong>not</strong> support printing &mdash; no QR label reprint functionality. That is in Hammaddeler Listesi</li>
            <li>It does <strong>not</strong> have a client-side search bar &mdash; browsing is done by expanding category panels and group rows</li>
            <li>It does <strong>not</strong> track consumption history &mdash; it shows the current snapshot only, not a timeline of weight changes</li>
            <li>It does <strong>not</strong> have soft-delete &mdash; the delete operation uses <code>/hard-delete</code>, permanently removing the record</li>
        </ul>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>Hammadde Stok vs Hammaddeler Listesi &mdash; same data, different purpose:</strong> Both pages read from the same <code>/api/materials/list</code> endpoint and display the same <code>materials</code> table data. The difference is perspective. Hammaddeler Listesi (in the Hammadde module) is the full-power admin view: 14 columns, lazy photos, WebSocket, bilingual search, three edit form variants, printing, 12 granular permissions. Hammadde Stok (in the Stock module) is the <strong>stock manager&rsquo;s view</strong>: grouped by category and material name, with aggregate totals front and center, optimized for answering &ldquo;how much do we have?&rdquo; rather than &ldquo;what is the full history of this lot?&rdquo; The edit modal here is deliberately minimal (weight + status only) because the full edit belongs in the Hammadde module.</p>
        </div>

        <!-- ====== 6.3 ÃRÃN STOK ====== -->
        <h2 id="sec-6-3">6.3 &mdash; ÃrÃ¼n Stok (Product Stock)</h2>
        <p class="subtitle">Live inventory of semi-finished and finished products, organized by production step &mdash; the output side of the factory floor.</p>

        <h3 id="urun-stok-purpose">6.3.1 &mdash; Purpose and Business Context</h3>
        <p>ÃrÃ¼n Stok answers the question: <strong>"What did the factory produce and where is it now?"</strong></p>
        <p>While Hammadde Stok tracks raw <em>inputs</em> waiting to be consumed, ÃrÃ¼n Stok tracks the <em>outputs</em>: every basket and reel that came off a production machine. Each item in this page was physically created during a <strong>Production Session</strong> &mdash; an operator ran a machine, recorded baskets of output, printed QR labels, and those baskets landed here. The page exists because:</p>
        <ul>
            <li><strong>Ãretim Listesi</strong> (Production List) creates these items &mdash; when a production session records output baskets, each basket is simultaneously written to <code>production_outputs</code> and <code>half_product_stock</code>. This page is the <strong>read-only window</strong> into that accumulated inventory.</li>
            <li><strong>Ãretim GeÃ§miÅi</strong> (Production History) shows the same items from a session-centric perspective (which session produced what). ÃrÃ¼n Stok shows them from a <strong>stock-centric</strong> perspective (how much of each product code exists right now, regardless of which session made it).</li>
            <li><strong>Order Module</strong> determines <strong>allocation</strong> &mdash; when a work card is opened for an order, baskets produced within the order's required quantity are marked <code>ORDER</code>. Any excess production becomes <code>STOCK</code> (free inventory). This allocation split is a core business concept visible in every group row.</li>
            <li><strong>Lab Module</strong> (Test YÃ¶netimi) bonds quality tests to specific production outputs. ÃrÃ¼n Stok lets stock managers view bonded test results directly from each item &mdash; the test icon on each row opens a modal showing test interval, name, standard number, and pass/fail status fetched from the Lab system.</li>
            <li><strong>Source QR Traceability</strong> &mdash; each item stores <code>source_qr_codes</code>, a JSON array of input QR codes consumed to produce it. This chain (A1 copper &rarr; X1 kabatel &rarr; Y1 kalaylama &rarr; ...) is the factory's traceability backbone.</li>
        </ul>

        <h3 id="urun-stok-crud">6.3.2 &mdash; CRUD Flow</h3>
        <p><strong>Create:</strong> This page does <strong>not</strong> create items. Half-product stock records are exclusively created by the <strong>Production module</strong> during active production sessions. When an operator records a basket output, the backend writes to both <code>production_outputs</code> and <code>half_product_stock</code> tables simultaneously. There is no "Add" button on this page.</p>
        <p><strong>Read:</strong> On mount, the component fires <strong>7 parallel API requests</strong> &mdash; one for each production step (Kabatel, Kalaylama, Ä°ncetel, Buncher, Extruder, E-Beam, Aktarma). Each request hits <code>GET /api/stock/half-products/by-step/{step}?status_filter=available</code>. The backend queries the <code>half_product_stock</code> table filtered by <code>production_step</code> and <code>status</code>, joins with <code>production_sessions</code> to get operator name, and returns sorted results (newest first). The frontend then groups by <code>product_code</code>, calculates per-group totals, and builds the Collapse panel hierarchy.</p>
        <p><strong>Update:</strong> Per-item edit via modal. Clicking the edit icon opens a form with three fields: <code>remaining_weight_kg</code> (required, InputNumber with min=0 and step=0.1), <code>allocation</code> (Select: ORDER or STOCK), and <code>notes</code> (TextArea). Submits <code>PUT /api/stock/half-products/{id}</code>. The backend whitelists only <code>remaining_weight_kg</code>, <code>status</code>, and <code>notes</code> for update (note: allocation is sent from frontend but the backend's <code>allowed_fields</code> list does not include it &mdash; potential inconsistency). After success, full data refresh.</p>
        <p><strong>Delete:</strong> Confirmation modal with item QR code displayed. Calls <code>DELETE /api/stock/half-products/{id}</code>. The backend performs a <strong>cascading delete</strong>: (1) finds the linked <code>ProductionOutput</code> via <code>production_output_id</code> or fallback <code>output_code</code> matching and deletes it, (2) checks if the deleted item's QR number was the highest in its prefix sequence (e.g., X150 is the highest X-prefix) &mdash; if so, decrements <code>HalfProductSequence.last_number</code> to allow reuse, (3) deletes the stock record itself. This cascade ensures that deleting from stock doesn't leave orphaned production output records or broken QR sequences.</p>

        <h3 id="urun-stok-api">6.3.3 &mdash; Data Source and API Architecture</h3>
        <p>Unlike Hammadde Stok which borrows a single endpoint from the Hammadde module, ÃrÃ¼n Stok has its <strong>own dedicated backend</strong> at <code>api/stock/half_product_routes.py</code> with 6 endpoints:</p>
        <div style="overflow-x:auto">
        <table style="width:100%; border-collapse: collapse; margin: 12px 0">
            <thead><tr style="background: var(--bg-secondary)">
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Endpoint</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Method</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Purpose</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Used by frontend?</th>
            </tr></thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/by-step/{step}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">GET</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Primary data: all items for a step, with operator name. Joins <code>ProductionSession</code>.</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Yes (7 parallel calls on mount)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/{id}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">PUT</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Update weight, status, notes</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Yes (edit modal)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/{id}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">DELETE</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Cascade delete: stock + production output + sequence reset</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Yes (delete confirmation)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">GET</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">General listing with pagination, optional step/status filter</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">No (available for other consumers)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/summary</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">GET</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Per-step counts and weights (available/total)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">No</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/{qr_code}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">GET</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Lookup by QR code</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">No</td></tr>
            </tbody>
        </table>
        </div>
        <p>Additionally, the <strong>bonded tests</strong> feature calls <code>GET /api/production/test-requests/bonded-tests/output/{output_id}</code> from the Production module's <code>test_integration_routes.py</code>. This cross-module call fetches Lab tests bonded to a specific production output, grouped by test interval (<code>Ã¼retim_baÅÄ±</code>, <code>her_sepet_sonu</code>, <code>Ã¼retim_sonu</code>).</p>

        <h3 id="urun-stok-db">6.3.4 &mdash; Database Schema: <code>half_product_stock</code> Table</h3>
        <p>This is the <strong>dedicated</strong> table for this submodule &mdash; unlike Hammadde Stok which reads from the Hammadde module's <code>materials</code> table, ÃrÃ¼n Stok has its own table managed by <code>models/half_product_stock.py</code>.</p>
        <div style="overflow-x:auto">
        <table style="width:100%; border-collapse: collapse; margin: 12px 0">
            <thead><tr style="background: var(--bg-secondary)">
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Column</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Type</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Business Meaning</th>
            </tr></thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>qr_code</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(50), unique</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Deterministic QR: X=Kabatel, Y=Kalaylama, Z=Ä°ncetel, T=Buncher, U=Extruder, G=E-Beam. Globally sequential per prefix.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>product_code</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(100)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Technical product identifier (e.g., KC_18, KL_18). Grouping key on frontend.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>production_step</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(50)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Which machine step produced this: <code>kabatel_cekme</code>, <code>kalaylama</code>, <code>incetel</code>, <code>buncher</code>, <code>extruder</code>, <code>ebeam</code>, <code>aktarma</code>.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>initial_weight_kg</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Float</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Weight when the basket came off the machine. Never changes.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>remaining_weight_kg</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Float</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Current weight after downstream consumption. Decreases as the next production step consumes this basket.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>basket_number</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Integer</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Sequential basket number within the production session.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>allocation</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(20)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>ORDER</code> = produced to fulfill a customer order. <code>STOCK</code> = excess production, free inventory.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>order_id</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">FK &rarr; orders.id</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Which customer order this basket is allocated to (null if STOCK).</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>status</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(50)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>available</code> &rarr; <code>in_use</code> &rarr; <code>consumed</code>. Also <code>reserved</code>, <code>shipped</code>, <code>defective</code>.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>production_output_id</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">FK &rarr; production_outputs.id</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Links to the production output record. Used for bonded test lookup and cascade delete.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>session_id</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">FK &rarr; production_sessions.id</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Which production session created this basket. Used to fetch operator name.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>work_card_id</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">FK &rarr; work_cards.id</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Which work card (from the Order module) drove this production.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>source_qr_codes</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Text (JSON)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">JSON array of input QR codes consumed to produce this. E.g., <code>["A1","A3"]</code> for a Kabatel basket made from copper lots A1 and A3. This is the traceability chain.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>produced_at</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">DateTime</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">When this basket was produced. Stored UTC, displayed as Europe/Istanbul.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>consumed_at</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">DateTime, nullable</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">When this basket was fully consumed by the next production step.</td></tr>
            </tbody>
        </table>
        </div>
        <p>Key relationships in the ORM: <code>order</code> (Order), <code>production_output</code> (ProductionOutput), <code>session</code> (ProductionSession), <code>work_card</code> (WorkCardDB). Composite indexes on <code>(production_step, status)</code> and <code>(product_code, status)</code> optimize the primary query pattern.</p>
        <p>The companion model <code>HalfProductSequence</code> (table <code>half_product_sequences</code>) tracks the last-used number for each prefix: <code>{'X': 150}</code> means X150 was the last Kabatel output. The prefix-to-machine mapping: <code>kabatel_cekme &rarr; X</code>, <code>kalaylama &rarr; Y</code>, <code>incetel &rarr; Z</code>, <code>buncher &rarr; T</code>, <code>extruder &rarr; U</code>, <code>ebeam &rarr; G</code>.</p>

        <h3 id="urun-stok-state">6.3.5 &mdash; State Management Architecture</h3>
        <p>The component uses 8 state variables:</p>
        <ul>
            <li><code>loading</code> (boolean) &mdash; global loading flag during the parallel fetch of all 7 steps</li>
            <li><code>sectionData</code> (Record&lt;string, SectionData&gt;) &mdash; the main data store. Initialized with all 7 production step keys, each containing: <code>groups</code> (ProductGroupSummary[]), <code>loading</code>, <code>expandedKeys</code>, <code>totalItems</code>, and <code>grandTotals</code> (total/siparis/serbest). This is the heart of the page.</li>
            <li><code>activePanels</code> (string[]) &mdash; which Collapse panels are currently open</li>
            <li><code>editModalVisible</code> + <code>editingItem</code> &mdash; edit modal state</li>
            <li><code>testsModalVisible</code> + <code>testsLoading</code> + <code>selectedTests</code> + <code>selectedOutputCode</code> &mdash; bonded tests modal state</li>
        </ul>
        <p>Data flow: <code>fetchAllData()</code> fires 7 parallel <code>request()</code> calls via <code>Promise.all()</code>. Each response is grouped by <code>product_code</code> on the client, with per-group allocation split (ORDER kg vs STOCK kg) and per-step grand totals calculated. The grouped results replace the entire <code>sectionData</code> state, preserving <code>expandedKeys</code> from the previous state so row expansions survive a refresh.</p>

        <h3 id="urun-stok-panels">6.3.6 &mdash; The 7 Production Step Panels</h3>
        <p>The page uses an Ant Design <code>Collapse</code> component with 7 panels, one for each production step. Unlike Hammadde Stok's 8 material categories (static names like "BakÄ±r", "PVC"), these panels follow the <strong>cable manufacturing pipeline</strong>:</p>
        <div style="overflow-x:auto">
        <table style="width:100%; border-collapse: collapse; margin: 12px 0">
            <thead><tr style="background: var(--bg-secondary)">
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Key</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Label</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">QR Prefix</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">What it produces</th>
            </tr></thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>kabatel_cekme</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Kabatel</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">X (X1, X2...)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Raw copper drawn into 1.8mm wire</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>kalaylama</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Kalaylama</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Y</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Tinned wire</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>incetel</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Ä°ncetel</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Z</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Fine wire (thinner gauge)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>buncher</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Buncher</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">T</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Bundled wire strands</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>extruder</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Extruder</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">U</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Insulated cable</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>ebeam</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">E-Beam</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">G</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Electron-beam cross-linked cable</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>aktarma</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Aktarma</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">AK</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Material transfer / rewinding</td></tr>
            </tbody>
        </table>
        </div>
        <p>Each panel has a distinctive icon and color. The icon set uses Ant Design icons: ScissorOutlined (Kabatel), FireOutlined (Kalaylama), CompressOutlined (Ä°ncetel), ApartmentOutlined (Buncher), BuildOutlined (Extruder), ThunderboltOutlined (E-Beam), SwapOutlined (Aktarma).</p>

        <h3 id="urun-stok-header-stats">6.3.7 &mdash; Panel Header: Three-Column Statistics</h3>
        <p>Each panel header displays three right-aligned stat columns showing the <strong>allocation split</strong>:</p>
        <ul>
            <li><strong>Toplam (Total)</strong> &mdash; grand total kg of all available items in this production step</li>
            <li><strong>SipariÅ (Order)</strong> &mdash; total kg allocated to customer orders (green tag)</li>
            <li><strong>Serbest (Free)</strong> &mdash; total kg of excess production / free stock (orange tag)</li>
        </ul>
        <p>The item count is also displayed as a tag next to the step label. When a step has no data, the stat columns remain visible but at reduced opacity, maintaining layout consistency across all panels.</p>

        <h3 id="urun-stok-hierarchy">6.3.8 &mdash; Two-Level Table Hierarchy</h3>
        <p>Inside each panel, data is displayed in a <strong>two-level hierarchy</strong> (compared to Hammadde Stok's three levels):</p>
        <p><strong>Level 1 &mdash; Group Row (by product_code):</strong> Each row represents all baskets of a specific product code within this production step. Shows:</p>
        <ul>
            <li><strong>ÃrÃ¼n Kodu</strong> (Product Code) with item count</li>
            <li><strong>Toplam</strong> (Total kg) &mdash; sum of all remaining weights</li>
            <li><strong>SipariÅ</strong> (Order kg) &mdash; sum of ORDER-allocated items (green tag)</li>
            <li><strong>Serbest</strong> (Free kg) &mdash; sum of STOCK-allocated items (orange tag)</li>
        </ul>
        <p>Clicking the expand icon reveals...</p>
        <p><strong>Level 2 &mdash; Individual Items:</strong> Each row is a single basket/reel with its full detail. Columns:</p>
        <div style="overflow-x:auto">
        <table style="width:100%; border-collapse: collapse; margin: 12px 0">
            <thead><tr style="background: var(--bg-secondary)">
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Column</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Description</th>
            </tr></thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">QR Kod</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">The deterministic QR code (e.g., X5, Y12). Blue tag. Fixed left column.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">AÄÄ±rlÄ±k</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Current remaining weight in kg (Turkish locale formatting).</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Tahsis (Allocation)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">ORDER (green) or Stok (orange) tag.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Durum (Status)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Mevcut (available/green), TÃ¼ketildi (consumed/default), Rezerve (reserved/blue), HatalÄ± (defective/red).</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Ä°Å KartÄ±</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Work card ID as blue tag, linking this basket to its originating order task.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Ãretim Tarihi</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Production date/time. UTC &rarr; Europe/Istanbul conversion using dayjs plugins.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Kaynak (Source)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Input QR codes (parsed from JSON). Shows first 2 codes + "..." if more. This is the traceability link to upstream materials.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Test</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Experiment icon button if <code>production_output_id</code> exists. Opens bonded tests modal.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Ä°Ålem (Actions)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Edit and Delete buttons. Fixed right column.</td></tr>
            </tbody>
        </table>
        </div>

        <h3 id="urun-stok-allocation">6.3.9 &mdash; The Allocation System: ORDER vs STOCK</h3>
        <p>This is a key concept that ÃrÃ¼n Stok exposes but does <strong>not</strong> control. The allocation is determined at <strong>production time</strong>, not at stock viewing time:</p>
        <ul>
            <li>When a production session runs against a work card, the backend tracks <strong>cumulative production</strong> against the order's required quantity.</li>
            <li>Every basket produced while cumulative output is <strong>below</strong> the required quantity is marked <code>ORDER</code> and linked to the <code>order_id</code>.</li>
            <li>Once cumulative output <strong>exceeds</strong> the required quantity, subsequent baskets are marked <code>STOCK</code> with null <code>order_id</code>.</li>
        </ul>
        <p>ÃrÃ¼n Stok displays this allocation split at every level: per-item (tag), per-group (two separate kg columns), and per-step (panel header stats). This gives stock managers immediate visibility into how much inventory is committed to orders versus how much is free for new orders or general use.</p>

        <h3 id="urun-stok-bonded-tests">6.3.10 &mdash; Bonded Tests Modal: Lab Connection</h3>
        <p>Items that have a <code>production_output_id</code> (virtually all items created through normal production flow) show an experiment icon in their row. Clicking it opens a modal that fetches <code>/api/production/test-requests/bonded-tests/output/{output_id}</code> and displays all quality tests bonded to that specific production output.</p>
        <p>The response groups tests by interval:</p>
        <ul>
            <li><strong>Ãretim BaÅÄ±</strong> (Production Start) &mdash; tests run at the beginning of a session</li>
            <li><strong>Her Sepet Sonu</strong> (Every Basket End) &mdash; per-basket tests, the most granular</li>
            <li><strong>Ãretim Sonu</strong> (Production End) &mdash; end-of-session validation tests</li>
        </ul>
        <p>Each test row shows: test ID (purple tag), test name, standard number (if any), interval label, and status with color-coded icon (green check for passed, red X for failed, yellow clock for pending). The data comes from the Lab module's test request system &mdash; this is a <strong>cross-module read</strong> that bridges Stock and Quality Control.</p>

        <h3 id="urun-stok-source-traceability">6.3.11 &mdash; Source QR Traceability</h3>
        <p>The <code>source_qr_codes</code> field stores a JSON array of QR codes that were consumed to produce this item. The frontend parses this JSON and displays the first 2 codes with an ellipsis if there are more. For example:</p>
        <ul>
            <li>A Kabatel basket X5 might show source <code>["A1", "A3"]</code> &mdash; the raw copper lots it consumed</li>
            <li>A Kalaylama reel Y12 might show source <code>["X5", "X6"]</code> &mdash; the Kabatel outputs it consumed</li>
        </ul>
        <p>This creates a <strong>full material chain</strong>: raw copper (A-prefix) &rarr; kabatel wire (X-prefix) &rarr; tinned wire (Y-prefix) &rarr; fine wire (Z-prefix) &rarr; bundled wire (T-prefix) &rarr; insulated cable (U-prefix) &rarr; cross-linked cable (G-prefix). Each link is stored in <code>source_qr_codes</code>, making any basket traceable back to its raw material origin.</p>

        <h3 id="urun-stok-grouping">6.3.12 &mdash; Client-Side Grouping Logic</h3>
        <p>After the 7 parallel API responses arrive, <code>fetchAllData()</code> processes each step's data:</p>
        <ol>
            <li>Iterate over items, group into a <code>Record&lt;string, HalfProductStock[]&gt;</code> map by <code>product_code</code> (or "Unknown" fallback)</li>
            <li>For each group, calculate <code>total_kg</code>, <code>siparis_kg</code> (ORDER allocation), and <code>serbest_kg</code> (STOCK allocation) by summing <code>remaining_weight_kg</code></li>
            <li>Accumulate grand totals per step</li>
            <li>Sort groups alphabetically by product code</li>
            <li>Build the <code>SectionData</code> object, preserving existing <code>expandedKeys</code> so that expanded rows survive a data refresh</li>
        </ol>
        <p>Compared to Hammadde Stok's <code>processAndGroupMaterials()</code> function which groups by category then by material name (3 levels), ÃrÃ¼n Stok groups only by product_code within each step panel (2 levels), because the step panel itself acts as the top-level grouping.</p>

        <h3 id="urun-stok-edit-modal">6.3.13 &mdash; The Edit Modal</h3>
        <p>The edit modal allows modification of three fields: <code>remaining_weight_kg</code> (required numeric input with 0.1 step), <code>allocation</code> (ORDER/STOCK dropdown), and <code>notes</code> (free-text area). Compared to Hammadde Stok's 2-field modal (weight + status), this adds the allocation field. On submit, form values are sent to <code>PUT /api/stock/half-products/{id}</code>, then all data is refreshed.</p>
        <p>Note: The backend's <code>allowed_fields</code> whitelist for the PUT endpoint is <code>['remaining_weight_kg', 'status', 'notes']</code> &mdash; it does not include <code>allocation</code>. The frontend sends allocation in the payload, but the backend silently ignores it. This means allocation is effectively <strong>read-only</strong> from this page, only changeable at production time.</p>

        <h3 id="urun-stok-loading-empty">6.3.14 &mdash; Loading and Empty States</h3>
        <p>During the parallel fetch, each panel's content area shows a centered <code>Spin</code> spinner with "YÃ¼kleniyor..." text. After loading completes, panels with no items for that production step display Ant Design's <code>Empty</code> component with the message "Bu kategoride stok bulunamadÄ±".</p>

        <h3 id="urun-stok-timezone">6.3.15 &mdash; Timezone Handling</h3>
        <p>Identical pattern to Hammadde Stok: <code>dayjs</code> with <code>utc</code> and <code>timezone</code> plugins. All <code>produced_at</code> timestamps are stored UTC in the database and converted to <code>Europe/Istanbul</code> timezone on the frontend using <code>dayjs.utc(date).tz(TURKEY_TZ).format('DD.MM.YY HH:mm')</code>.</p>

        <h3 id="urun-stok-connections">6.3.16 &mdash; Connection to Other Modules</h3>
        <p>ÃrÃ¼n Stok is the most <strong>interconnected</strong> of the three Stock submodules. It touches every major module:</p>
        <ul>
            <li><strong>Production &rarr; Ãretim Listesi (upstream writer):</strong> Every record in <code>half_product_stock</code> was created during a production session. The <code>session_id</code> and <code>production_output_id</code> columns directly link back to the Production module's data. The backend even joins with <code>ProductionSession</code> to return operator names.</li>
            <li><strong>Production &rarr; Ãretim GeÃ§miÅi (parallel view):</strong> Production History shows the same production outputs but organized by session and time. ÃrÃ¼n Stok reorganizes the same underlying data by <em>product code and step</em>, providing an inventory-centric rather than session-centric view.</li>
            <li><strong>Production &rarr; Downstream consumption:</strong> When the <em>next</em> production step consumes a basket (e.g., Kalaylama consumes X-coded Kabatel output), the basket's <code>remaining_weight_kg</code> decreases, <code>status</code> changes to <code>in_use</code> or <code>consumed</code>, and <code>consumed_at</code> is filled. These items stop appearing on this page because the default filter is <code>status_filter=available</code>.</li>
            <li><strong>Order Module (allocation source):</strong> The <code>allocation</code> (ORDER/STOCK) and <code>order_id</code> are set at production time based on cumulative output vs. order requirements. The <code>work_card_id</code> column traces each basket to its originating work card from the Order module.</li>
            <li><strong>Lab Module &rarr; Test YÃ¶netimi (quality bridge):</strong> The bonded tests modal fetches test results from the Lab's <code>test_integration_routes.py</code>. Tests are bonded to production outputs by the Lab system during or after production. ÃrÃ¼n Stok is the <strong>only Stock submodule</strong> that directly reads Lab data.</li>
            <li><strong>Hammadde Module (source material):</strong> The <code>source_qr_codes</code> field contains references to raw material QR codes (A-prefix for copper, etc.) from the Hammadde module. While ÃrÃ¼n Stok doesn't query the <code>materials</code> table, the traceability chain connects the two modules at the data level.</li>
        </ul>

        <h3 id="urun-stok-not">6.3.17 &mdash; What This Submodule Does NOT Do</h3>
        <ul>
            <li>It does <strong>not</strong> create inventory &mdash; that happens exclusively in the Production module during active sessions.</li>
            <li>It does <strong>not</strong> show consumed or shipped items &mdash; the default filter <code>status_filter=available</code> hides completed lifecycle items.</li>
            <li>It does <strong>not</strong> have a search bar &mdash; navigation is done by expanding step panels and group rows.</li>
            <li>It does <strong>not</strong> support bulk operations &mdash; no multi-select, no batch allocation change, no batch delete.</li>
            <li>It does <strong>not</strong> actually modify allocation &mdash; while the edit modal presents an allocation dropdown, the backend silently ignores it (not in <code>allowed_fields</code>).</li>
            <li>It does <strong>not</strong> use WebSocket or real-time updates &mdash; data is fetched on mount and manually via the Refresh button.</li>
            <li>It does <strong>not</strong> display the <code>initial_weight_kg</code> &mdash; only <code>remaining_weight_kg</code> is shown, so there is no consumption percentage visualization (unlike Hammadde Stok's color-coded weight column).</li>
            <li>It does <strong>not</strong> have conditional weight coloring &mdash; unlike Hammadde Stok which colors weights yellow/red based on consumption ratio, this page shows all weights in plain text.</li>
            <li>It does <strong>not</strong> include the <code>aktarma</code> step in the backend's <code>ProductionStep</code> enum or <code>MACHINE_TO_PREFIX</code> mapping &mdash; the frontend defines 7 steps but the backend enum only has 6, suggesting Aktarma is a newer addition.</li>
        </ul>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>ÃrÃ¼n Stok vs Hammadde Stok &mdash; same shell, different engine:</strong> The visual layout is nearly identical (Collapse panels, grouped tables, edit modal, refresh button), but the underlying data model is fundamentally different. Hammadde Stok reads from the Hammadde module's <code>materials</code> table with a single API call and groups by material category/name. ÃrÃ¼n Stok reads from its own <code>half_product_stock</code> table with 7 parallel API calls, groups by product_code, and adds the ORDER/STOCK allocation split, Lab test integration, source QR traceability, and production session linkage. Hammadde Stok is a read-only window into raw inputs. ÃrÃ¼n Stok is a read-and-manage window into production outputs with deep cross-module connections to Production, Lab, and Order modules.</p>
        </div>

        <!-- ============================================ -->
        <h2 id="sec-7" style="margin-top: 64px;">7. CONCLUSION</h2>
        <!-- ============================================ -->

        <div class="abstract">
            <p style="margin-bottom: 0;"><strong>Stock &amp; Inventory is not a module that creates data &mdash; it is the module that makes data from every other module visible, comparable, and actionable.</strong> Raw materials entered through Hammadde, production outputs recorded through &Uuml;retim, purchase orders tracked through Hammadde Sipari&#351;, work card requirements from the Order module &mdash; all of this converges here into three complementary views that answer the factory&rsquo;s most fundamental material questions.</p>
        </div>

        <h3>7.1 What This Document Covered</h3>

        <p>This deep dive analyzed the Stock &amp; Inventory module across three submodules, each with a fundamentally different data strategy:</p>

        <table>
            <tr><th>Section</th><th>Submodule</th><th>Depth</th><th>Key Insight</th></tr>
            <tr><td>6.1</td><td>Projeksiyon</td><td>Exhaustive</td><td>Computed-on-the-fly weekly forecast with no database table of its own; merges work card requirements (MINUS) with material order deliveries (PLUS) across 8 categories; hidden shortage detection within aggregate surpluses; material-specific heatmap normalization</td></tr>
            <tr><td>6.2</td><td>Hammadde Stok</td><td>Full</td><td>Pure frontend view over Hammadde module&rsquo;s <code>materials</code> table; single API call with client-side grouping into 8 categories; conditional weight coloring for consumption tracking; minimal edit modal for stock-level corrections only</td></tr>
            <tr><td>6.3</td><td>&Uuml;r&uuml;n Stok</td><td>Full</td><td>Own dedicated backend with 6 endpoints and own <code>half_product_stock</code> table; 7 parallel API calls by production step; ORDER/STOCK allocation split; bonded Lab test integration; source QR traceability chain; cascade delete with sequence reset</td></tr>
        </table>

        <h3>7.2 Architectural Principles</h3>

        <p>Three design principles define this module and distinguish it from the rest of the ERP system:</p>

        <div class="arch-grid">
            <div class="arch-box">
                <h4>Visibility, Not Ownership</h4>
                <p>Stock &amp; Inventory owns almost no data. Hammadde Stok reads from the Hammadde module&rsquo;s <code>materials</code> table. Projeksiyon computes from <code>work_cards</code> and <code>material_orders</code> owned by Order and Hammadde respectively. Only &Uuml;r&uuml;n Stok has its own table, and even that is populated exclusively by the Production module. The Stock module&rsquo;s job is to <em>present</em> data that other modules create.</p>
            </div>
            <div class="arch-box">
                <h4>Three Lenses, One Reality</h4>
                <p>The same physical factory inventory is visible through three different lenses: what raw materials exist <em>now</em> (Hammadde Stok), what production outputs exist <em>now</em> (&Uuml;r&uuml;n Stok), and what materials <em>will</em> exist in future weeks (Projeksiyon). No single view tells the complete story. Together they form a comprehensive material visibility layer that spans from the current warehouse snapshot to the multi-week forecast horizon.</p>
            </div>
            <div class="arch-box">
                <h4>Computation Over Storage</h4>
                <p>Projeksiyon is the defining example: no dedicated database table, no caching, no materialized views. Every request recomputes the full projection from live data. This means projections are always consistent with the latest work cards and delivery records, at the cost of heavier computation per request. The same principle applies to Hammadde Stok&rsquo;s client-side grouping and &Uuml;r&uuml;n Stok&rsquo;s parallel aggregation &mdash; totals are always computed fresh, never stored.</p>
            </div>
            <div class="arch-box">
                <h4>Cross-Module Read Pattern</h4>
                <p>Every submodule reads from at least one external module. Hammadde Stok reads Hammadde. Projeksiyon reads Hammadde Sipari&#351; + Order (work cards). &Uuml;r&uuml;n Stok reads Production (sessions, outputs) and Lab (bonded tests). This makes Stock the most dependency-heavy module in the system &mdash; it cannot function if any upstream module is broken.</p>
            </div>
        </div>

        <h3>7.3 The Numbers</h3>

        <div class="stat-grid">
            <div class="stat-box">
                <div class="value" style="color: var(--positive);">~1,050</div>
                <div class="label">LINES BACKEND</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: var(--negative);">~4,800</div>
                <div class="label">LINES FRONTEND</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: var(--accent);">5</div>
                <div class="label">UPSTREAM MODULES</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: var(--turquoise);">0</div>
                <div class="label">OWN WRITE ENDPOINTS</div>
            </div>
        </div>

        <p style="font-size: 12px; opacity: 0.7; margin-top: -8px;">* Projeksiyon has zero persistent storage. Hammadde Stok has zero own endpoints. The only write-capable endpoints belong to &Uuml;r&uuml;n Stok (PUT + DELETE), and even those modify a table populated entirely by another module.</p>

        <h3>7.4 How Stock Reads the Factory</h3>

        <div class="flow">
            <span class="flow-step">Hammadde Module</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Hammadde Stok</span>
        </div>
        <div class="flow" style="margin-top: 8px;">
            <span class="flow-step">&Uuml;retim (Production)</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">&Uuml;r&uuml;n Stok</span>
            <span class="flow-arrow">&larr;</span>
            <span class="flow-step">Lab (bonded tests)</span>
        </div>
        <div class="flow" style="margin-top: 8px;">
            <span class="flow-step">Hammadde Sipari&#351; (PLUS)</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Projeksiyon</span>
            <span class="flow-arrow">&larr;</span>
            <span class="flow-step">Work Cards (MINUS)</span>
        </div>

        <p>At first glance, Stock appears to be a passive, read-only module &mdash; it reads from everywhere and writes almost nowhere. But this is misleading. &Uuml;r&uuml;n Stok plays a <strong>critical upstream role</strong> in the production planning loop: the Order module&rsquo;s work card calculator engine queries available product stock (items with <code>STOCK</code> allocation and <code>available</code> status) and <strong>deducts free inventory before generating new work cards</strong>. This is precisely why the <code>allocation</code> (ORDER vs STOCK) and <code>status</code> (available, in_use, consumed, reserved) fields exist &mdash; not just for display, but as input data that determines how much new production is actually needed.</p>

        <p>This creates a <strong>circular dependency</strong>, not a linear pipeline:</p>

        <div class="flow">
            <span class="flow-step">Order</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Work Cards</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Production</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">&Uuml;r&uuml;n Stok</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Order (deduct available)</span>
            <span class="flow-arrow">&rarr; ...</span>
        </div>

        <p>The entire ERP system operates as this loop. There is no true &ldquo;starting module&rdquo; &mdash; every module depends on data from another, which in turn depends on a third, which circles back. Stock sits at a critical junction in this loop: it receives data from Production and Hammadde, but it also <strong>feeds back</strong> into Order by providing the available inventory that shapes how many work cards get generated. If &Uuml;r&uuml;n Stok shows 50&nbsp;kg of free Kabatel wire, the calculator subtracts that before distributing production tasks. Without accurate stock data, the factory either overproduces (wasting resources) or underproduces (missing delivery dates).</p>

        <p>This also means Stock is the first module to break when upstream data is inconsistent. If a material order&rsquo;s <code>delivered_date</code> is wrong, Projeksiyon&rsquo;s forecast shifts. If Production doesn&rsquo;t update <code>remaining_weight_kg</code>, Hammadde Stok shows stale weights. If a production output is deleted outside of &Uuml;r&uuml;n Stok, orphaned stock records appear. Stock doesn&rsquo;t just display data &mdash; it exposes the integrity of the entire system.</p>

        <h3>7.5 Final Word</h3>

        <div class="abstract">
            <p style="margin-bottom: 0;">The Stock &amp; Inventory module is the factory&rsquo;s material nervous system. It does not move materials, produce cables, or fulfill orders &mdash; but it tells everyone in the organization what exists, what is committed, what is free, and what will be available next week. More critically, it feeds this information back into the production planning loop: the Order module&rsquo;s calculator engine reads &Uuml;r&uuml;n Stok to deduct available half-products before generating work cards, closing the circle that connects ordering, production, and inventory. Projeksiyon alerts purchasing before a shortage becomes critical. Hammadde Stok tells the warehouse what&rsquo;s physically on the shelves. &Uuml;r&uuml;n Stok tells production planners what semi-finished goods are ready for the next step &mdash; and tells the Order module what doesn&rsquo;t need to be produced at all. Three pages, two database tables, five upstream dependencies, and one critical feedback loop &mdash; without this module, the factory either operates blind or runs in circles producing what it already has.</p>
        </div>

    </main>
</body>
</html>
