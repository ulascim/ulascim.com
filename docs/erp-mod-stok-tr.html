<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="apple-touch-icon" href="../apple-touch-icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok &amp; Envanter Modülü | Kablo Fabrikası ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f3f3f3;
            --fg: #000000;
            --gray-100: #f3f4f6;
            --gray-300: #d1d5db;
            --positive: #16a34a;
            --negative: #dc2626;
            --accent: #2563eb;
            --turquoise: #00b5ad;
        }
        body { font-family: 'IBM Plex Mono', monospace; background: var(--bg); color: var(--fg); font-size: 12px; line-height: 1.3; }
        .nav { position: sticky; top: 0; z-index: 50; border-bottom: 2px solid var(--fg); background: var(--bg); }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 64px; height: 56px; display: flex; align-items: center; }
        .nav-left { display: flex; align-items: center; gap: 12px; }
        .nav-logo { font-size: 18px; font-weight: 700; letter-spacing: 2px; text-decoration: none; color: var(--fg); }
        .nav-right { margin-left: auto; }
        .nav-link-small { color: var(--fg); text-decoration: underline; font-size: 11px; }
        .nav-divider { color: var(--fg); font-size: 14px; font-weight: 300; }
        .report { max-width: 1400px; margin: 0 auto; padding: 24px 64px; }
        .report h1 { font-size: 28px; margin-bottom: 8px; letter-spacing: 2px; }
        .report h2 { font-size: 18px; margin-top: 36px; margin-bottom: 12px; border-bottom: 2px solid #000; padding-bottom: 4px; scroll-margin-top: 72px; }
        .report h3 { font-size: 14px; margin-top: 20px; margin-bottom: 8px; }
        .report h4 { font-size: 12px; margin-top: 14px; margin-bottom: 6px; }
        .report p { font-size: 13px; line-height: 1.6; margin-bottom: 12px; }
        .report ul { font-size: 13px; margin: 12px 0; padding-left: 20px; }
        .report li { margin-bottom: 6px; line-height: 1.5; }
        .report ol { font-size: 13px; margin: 12px 0; padding-left: 20px; }
        .report ol li { margin-bottom: 6px; line-height: 1.5; }
        .report .subtitle { font-size: 14px; color: #666; margin-bottom: 4px; }
        .report .authors { font-size: 12px; color: #888; margin-bottom: 32px; }
        .report code { background: #e5e5e0; padding: 1px 5px; font-size: 12px; }
        .report pre { background: #1a1a2e; color: #e0e0e0; padding: 16px; margin: 12px 0; overflow-x: auto; font-size: 12px; line-height: 1.5; border: 2px solid #000; }
        .report .abstract { background: #f5f5f0; padding: 16px; margin: 20px 0; border-left: 3px solid #000; }
        .report .finding { background: #fffbe6; padding: 12px; margin: 12px 0; border: 1px solid #e6d600; }
        .report .warning { background: #fee2e2; padding: 12px; margin: 12px 0; border: 1px solid #dc2626; }
        .report .discovery { background: #e6ffe6; padding: 12px; margin: 12px 0; border: 1px solid #0a0; }
        .report .insight { background: #eff6ff; padding: 12px; margin: 12px 0; border: 1px solid #2563eb; }
        .report .philosophy { background: #faf5ff; padding: 12px; margin: 12px 0; border: 1px solid #7c3aed; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 16px 0; }
        .stat-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0; }
        .stat-box { background: #f3f4f6; padding: 12px; text-align: center; border: 2px solid #000; }
        .stat-box .value { font-size: 24px; font-weight: bold; }
        .stat-box .label { font-size: 10px; color: #666; margin-top: 2px; }
        .report table { width: auto; border-collapse: collapse; border: 2px solid #000; margin: 16px 0; }
        .report tr:first-child { background: #f3f4f6; border-bottom: 2px solid #000; }
        .report th { padding: 4px 10px; text-align: left; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; white-space: nowrap; border-right: 2px solid #000; background: #f3f4f6; }
        .report th:last-child { border-right: none; }
        .report tr:not(:first-child) { border-bottom: 1px solid #d1d5db; }
        .report tr:last-child { border-bottom: none; }
        .report td { padding: 4px 10px; font-size: 0.75rem; border-right: 2px solid #000; }
        .report td:last-child { border-right: none; }
        .report tr:not(:first-child):hover { background: rgba(0,0,0,0.02); }
        .flow { display: flex; align-items: center; gap: 8px; margin: 16px 0; flex-wrap: wrap; }
        .flow-step { padding: 8px 14px; border: 2px solid #000; font-size: 12px; font-weight: 700; text-align: center; min-width: 100px; }
        .flow-arrow { font-size: 18px; font-weight: 700; }
        .flow-box { padding: 8px 14px; border: 2px solid #000; font-size: 12px; font-weight: 700; text-align: center; min-width: 100px; }
        .flow-box.done { background: #dcfce7; border-color: #16a34a; }
        .flow-box.active { background: #dbeafe; border-color: #2563eb; }
        .flow-box.pending { background: #f3f4f6; }
        .arch-box { background: #fff; border: 2px solid #000; padding: 16px; margin: 12px 0; }
        .arch-box h4 { font-size: 14px; margin-bottom: 8px; margin-top: 0; }
        .arch-box p { font-size: 12px; line-height: 1.5; }
        .arch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin: 16px 0; }
        .back-link { display: inline-block; font-size: 12px; color: #666; text-decoration: none; margin-bottom: 24px; padding: 8px 0; }
        .back-link:hover { color: #000; }
        .back-link::before { content: "\2190  "; }
        .good { color: #16a34a; font-weight: 700; }
        .bad { color: #dc2626; font-weight: 700; }
        .code-block { background: #1a1a2e; color: #e0e0e0; padding: 16px; margin: 12px 0; overflow-x: auto; font-size: 12px; line-height: 1.5; border: 2px solid #000; }

        .submod-card { background: #fff; border: 2px solid #000; padding: 16px; margin: 10px 0; display: flex; align-items: flex-start; gap: 16px; }
        .submod-num { background: #000; color: #fff; font-size: 13px; font-weight: 700; min-width: 36px; height: 36px; padding: 0 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .submod-body { flex: 1; }
        .submod-body h4 { font-size: 14px; margin: 0 0 4px 0; }
        .submod-body p { font-size: 12px; color: #555; margin: 0 0 6px 0; line-height: 1.4; }
        .submod-tags { display: flex; gap: 6px; flex-wrap: wrap; }
        .submod-tag { font-size: 10px; padding: 2px 6px; background: #f3f4f6; border: 1px solid #d1d5db; }

        @media (max-width: 768px) {
            .report { padding: 16px; }
            .nav-container { padding: 0 16px; }
            .stat-grid, .stat-grid-3 { grid-template-columns: repeat(2, 1fr); }
            .flow { flex-direction: column; align-items: stretch; }
            .flow-arrow { transform: rotate(90deg); text-align: center; }
            .arch-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <div class="nav-left">
                <a href="erp-system.html" class="nav-logo">ERP SYSTEM</a>
            </div>
            <div class="nav-right">
                <a href="erp-mod-stok-tr.html" class="nav-link-small" style="font-weight: 700;">TR</a>
                <span class="nav-divider">|</span>
                <a href="erp-mod-stok.html" class="nav-link-small">EN</a>
            </div>
        </div>
    </nav>

    <main class="report">
        <a href="erp-deep-dives-tr.html" class="back-link">Mod&uuml;llere D&ouml;n</a>
        <h1>STOK &amp; ENVANTER &mdash; &Ccedil;İFT MANTIKLI MALZEME G&Ouml;R&Uuml;N&Uuml;RL&Uuml;ĞÜ</h1>
        <p class="subtitle">İki paralel sistem, iki farklı soruyu yanıtlıyor: &ldquo;Şu an elimizde ne var?&rdquo; ve &ldquo;Gelecekte elimizde ne olacak?&rdquo; &mdash; canlı envanter ve dinamik projeksiyon tahmini, yerleşik bir çapraz doğrulama mekanizması olarak yan yana çalışıyor.</p>
        <p class="authors">Şubat 2026 &bull; Solen Kablo &bull; Canlı Belge</p>

        <div class="abstract">
            <p style="margin-bottom: 0;"><strong>Stok &amp; Envanter modülü temel bir ikilik üzerine çalışır.</strong> Üç sayfasından ikisi &mdash; Ürün Stok ve Hammadde Stok &mdash; fabrikanın bu andaki fiziksel gerçekliğini gösterir: her sepet bakır tel, her makara ekstrüde kablo, depodaki her kilogram ham plastik. Bunlar, Üretim her çıktı kaydettiğinde veya bir malzeme tüketildiğinde değişir. Üçüncü sayfa &mdash; Projeksiyon &mdash; fiziksel gerçekliği tamamen göz ardı eder ve bunun yerine <em>planı</em> gösterir: iş kartlarından (EKSİ) ne kadar malzeme gerekeceğinin ve satın alma siparişlerinden (ARTI) ne kadar geleceğinin haftalık tahmini. Projeksiyon plan değişikliklerine dinamik olarak tepki verir &mdash; bir malzeme siparişi teslim edildiğinde, beklenen tarih/miktardan gerçek teslim tarihi/miktarına geçiş yapar ve projeksiyonu buna göre kaydırır. Ayrıca iş kartları oluşturulduğunda, değiştirildiğinde veya iptal edildiğinde güncellenir. Bu ikilik kasıtlıdır &mdash; canlı envanterin projeksiyonu doğruladığı ve projeksiyonun canlı envanterin henüz göremediği gelecekteki açıkları önceden uyardığı yerleşik bir çapraz doğrulama mekanizması oluşturur.</p>
        </div>

        <div class="stat-grid">
            <div class="stat-box">
                <div class="value" style="color: var(--accent);">3</div>
                <div class="label">ALT MOD&Uuml;L</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: var(--turquoise);">~14</div>
                <div class="label">API ENDPOINT</div>
            </div>
            <div class="stat-box">
                <div class="value">2</div>
                <div class="label">VERİTABANI TABLOSU</div>
            </div>
            <div class="stat-box">
                <div class="value" style="color: var(--positive);">5800+</div>
                <div class="label">SATIR KOD</div>
            </div>
        </div>

        <!-- TABLE OF CONTENTS -->
        <div style="background: #fff; border: 2px solid #000; padding: 20px 28px; margin: 24px 0;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; letter-spacing: 1px;">İÇİNDEKİLER</h3>
            <div style="columns: 2; column-gap: 32px; font-size: 12px; line-height: 2;">
                <a href="#sec-1" style="text-decoration: none; color: var(--fg); display: block;"><strong>1.</strong> Stok &amp; Envanter Ne Yapar</a>
                <a href="#sec-2" style="text-decoration: none; color: var(--fg); display: block;"><strong>2.</strong> Veri Akışı</a>
                <a href="#sec-3" style="text-decoration: none; color: var(--fg); display: block;"><strong>3.</strong> Veritabanı Katmanı</a>
                <a href="#sec-4" style="text-decoration: none; color: var(--fg); display: block;"><strong>4.</strong> Backend Mimarisi</a>
                <a href="#sec-5" style="text-decoration: none; color: var(--fg); display: block;"><strong>5.</strong> Frontend</a>
                <a href="#sec-6" style="text-decoration: none; color: var(--fg); display: block;"><strong>6.</strong> Alt Mod&uuml;ller</a>
                <a href="#sec-6-1" style="text-decoration: none; color: #555; display: block; padding-left: 16px;">6.1 Projeksiyon (Stok Tahmini)</a>
                <a href="#sec-6-2" style="text-decoration: none; color: #555; display: block; padding-left: 16px;">6.2 Hammadde Stok</a>
                <a href="#sec-6-3" style="text-decoration: none; color: #555; display: block; padding-left: 16px;">6.3 Ürün Stok</a>
                <a href="#sec-7" style="text-decoration: none; color: var(--fg); display: block;"><strong>7.</strong> Sonuç</a>
            </div>
        </div>

        <!-- ============================================ -->
        <h2 id="sec-1">1. STOK &amp; ENVANTER NE YAPAR</h2>
        <!-- ============================================ -->

        <p>Stok &amp; Envanter modülü, herhangi bir üretim operasyonundaki en temel iki soruyu yanıtlar:</p>

        <ol>
            <li><strong>&ldquo;Şu an elimizde ne var?&rdquo;</strong> &mdash; Ürün Stok (yarı mamul/mamul ürünler) ve Hammadde Stok (hammaddeler) tarafından yanıtlanır. Bu sayfalar fabrikanın envanterinin t=0 anındaki canlı, fiziksel durumunu gösterir. Her sepet çekilmiş bakır tel (X kodlu), her makara kalaylanmış tel (Y kodlu), her kilogram ham plastik &mdash; gerçek zamanlı ağırlıklar, durumlar, tahsisler ve tam üretim izlenebilirliğiyle birlikte görünür.</li>
            <li><strong>&ldquo;Gelecekte elimizde ne olacak?&rdquo;</strong> &mdash; Projeksiyon (Stok Tahmini) tarafından yanıtlanır. Bu sayfa 8 malzeme kategorisinde (bakır, kalay, plastik, katalizör, boya, antirodent, makara, palet) haftalık bir tahmin gösterir; planlanan iş kartlarının ne kadar malzeme tüketeceğini (EKSİ) ile satın alma siparişlerinden ne kadar geleceğini (ARTI) hesaplayarak, açıkları haftalarca önceden ortaya çıkaran kümülatif bir bakiye üretir.</li>
        </ol>

        <p>Bu iki sistem <strong>temelden farklı veri kaynakları</strong> üzerinde çalışır:</p>

        <table>
            <tr><th>Boyut</th><th>Canlı Envanter (Ürün + Hammadde Stok)</th><th>Projeksiyon</th></tr>
            <tr><td><strong>Veri kaynağı</strong></td><td><code>half_product_stock</code> tablosu + <code>materials</code> tablosu</td><td><code>work_cards</code> (EKSİ) + <code>material_orders</code> (ARTI)</td></tr>
            <tr><td><strong>Zaman ekseni</strong></td><td>Şimdi (t=0)</td><td>Geleceğe doğru haftalar (H01&ndash;H52+)</td></tr>
            <tr><td><strong>Ne zaman değişir</strong></td><td>Üretim çıktı kaydeder, malzeme tüketilir/alınır</td><td>Plan değişir: iş kartı oluşturulur/değiştirilir/iptal edilir, malzeme siparişi teslim edilir (gerçek tarih &amp; miktara geçer), sipariş tarihi/miktarı değişir, sipariş iptal edilir</td></tr>
            <tr><td><strong>Ne zaman DEĞİŞMEZ</strong></td><td>&mdash;</td><td>Üretim fiziksel olarak tamamlandığında (tamamlanmış iş kartları hâlâ planda sayılır)</td></tr>
            <tr><td><strong>CRUD</strong></td><td>Tam (görüntüle, ağırlık/durum düzenle, sil)</td><td>Salt okunur (projeksiyon hesaplanır, düzenlenmez)</td></tr>
        </table>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>Çapraz doğrulama mekanizması:</strong> Projeksiyon H15 haftası için bakır fazlası gösteriyorsa ama Hammadde Stok bakırın <em>şu an</em> azaldığını gösteriyorsa, bir şeyler yanlıştır &mdash; belki bir malzeme siparişi kaydedildi ama fiziksel teslimat gerçekleşmedi. Tersine, Hammadde Stok bol plastik gösteriyorsa ama Projeksiyon H20&rsquo;de açık öngörüyorsa, mevcut stok yaklaşan üretim tarafından tüketilecek demektir. Hiçbir sistem tek başına hikayenin tamamını anlatamaz; birlikte kapsamlı bir malzeme görünürlük katmanı oluştururlar.</p>
        </div>

        <!-- ============================================ -->
        <h2 id="sec-2">2. VERİ AKIŞI</h2>
        <!-- ============================================ -->

        <h3>2.1 Projeksiyon Veri Akışı</h3>
        <p>Projeksiyon, haftalık tahminini <code>ProjeksiyonService</code> (804 satır) içinde birleştirilen iki bağımsız veri kaynağından hesaplar:</p>

        <div class="flow">
            <span class="flow-step">İş Kartları (sevkiyat_week)</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">material_details JSON</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Hafta başına malzeme EKSİ</span>
        </div>
        <div class="flow">
            <span class="flow-step">Malzeme Siparişleri (expected_date)</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">miktar + malzeme_tipi</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Hafta başına malzeme ARTI</span>
        </div>
        <div class="flow">
            <span class="flow-step">ARTI &minus; EKSİ</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Haftalık değişim</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Kümülatif bakiye</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Açık tespiti</span>
        </div>

        <h4>EKSİ Tarafı: İş Kartı Malzeme Gereksinimleri</h4>
        <p>Her iş kartı, hangi hammaddeleri tüketeceğini belirten bir <code>material_details</code> JSON&rsquo;u taşır. Servis, makine türlerini malzeme kategorilerine eşler:</p>
        <table>
            <tr><th>Makine Türü</th><th>Çıkarılan Malzeme</th><th>JSON Yolu</th></tr>
            <tr><td>Kabatel Çekme</td><td>Bakır (kg)</td><td><code>material_details.copper_kg</code></td></tr>
            <tr><td>Kalaylama</td><td>Kalay (kg)</td><td><code>material_details.tin_kg</code></td></tr>
            <tr><td>Extruder</td><td>Plastik, Katalizör, Boya, Antirodent (kg)</td><td><code>quantities.*</code>, <code>insulation_materials[]</code>, <code>sheath_materials[]</code></td></tr>
            <tr><td>Aktarma</td><td>Makara (adet)</td><td><code>makara_distributions[].count</code></td></tr>
            <tr><td>Paletleme</td><td>Palet (adet)</td><td><code>palettes[].quantity</code></td></tr>
        </table>

        <p><code>CANCELLED</code> dışındaki tüm iş kartları dahil edilir &mdash; tamamlanmış olanlar bile, çünkü Projeksiyon tam plan geçmişini izler. Gelen tarafında, bir sipariş teslim edildiğinde servis <code>expected_date</code>/<code>quantity</code>&rsquo;den <code>delivered_date</code>/<code>delivered_quantity</code>&rsquo;ye geçiş yapar, böylece projeksiyon gerçek teslim zamanlamasını ve miktarlarını dinamik olarak yansıtır.</p>

        <h4>ARTI Tarafı: Gelen Malzeme Siparişleri</h4>
        <p>Her malzeme siparişinin bir <code>material_type</code>, <code>quantity</code> ve <code>expected_date</code> alanı vardır. Teslim edilen siparişlerde sistem bunun yerine <code>delivered_date</code> ve <code>delivered_quantity</code> kullanır. Malzeme adları, mevcut olduğunda tedarikçinin malzeme kataloğundan çözümlenir. <code>CANCELLED</code> dışındaki tüm siparişler dahil edilir.</p>

        <h4>Kümülatif Hesaplama</h4>
        <p>Servis, <strong>en erken veri noktasından</strong> (bir önceki yılda olabilir) son görünen haftaya kadar tüm haftaları üretir. <code>haftalık = artı - eksi</code> hesaplar ve 8 malzeme kategorisinin her biri için kümülatif bir bakiye tutar. Kullanıcının görüntüleme penceresinde (varsayılan 10 hafta), gizli açık tespiti için <strong>alt-malzeme kümülatifleri</strong> de (örn. Plastik kategorisi içindeki &ldquo;HFX 500P&rdquo; gibi bireysel plastik türleri) izlenir.</p>

        <h3>2.2 Canlı Envanter Veri Akışı</h3>
        <p>Canlı envanter sayfaları doğrudan fiziksel envanter tablolarından okur:</p>

        <div class="flow">
            <span class="flow-step">Üretim çıktı kaydeder</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">half_product_stock satırı oluşur</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Ürün Stok gösterir</span>
        </div>
        <div class="flow">
            <span class="flow-step">Malzeme giriş formu</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">materials satırı oluşur</span>
            <span class="flow-arrow">&rarr;</span>
            <span class="flow-step">Hammadde Stok gösterir</span>
        </div>

        <p>Ürün Stok 7 paralel API çağrısı yapar (her üretim adımı için birer tane: Kabatel, Kalaylama, İncetel, Buncher, Extruder, E-Beam, Aktarma), Hammadde Stok ise tüm malzemeleri tek bir çağrıda alır ve istemci tarafında 8 kategoriye gruplar.</p>

        <!-- ============================================ -->
        <h2 id="sec-3">3. VERİTABANI KATMANI</h2>
        <!-- ============================================ -->

        <p>Stok modülü, canlı envanter için iki birincil tabloya ve Projeksiyon hesaplamasını besleyen iki harici tabloya (diğer modüllerden) dayanır.</p>

        <h3>3.1 half_product_stock (20 sütun) &mdash; Yarı Mamul &amp; Mamul Ürünler</h3>
        <p>Herhangi bir makine tarafından üretilen her sepet, makara veya bobin burada kaydedilir. Her kayıt deterministik bir QR koda sahiptir (Kabatel için X1, Kalaylama için Y1, İncetel için Z1, Buncher için T1, Extruder için U1, E-Beam için G1).</p>

        <table>
            <tr><th>Sütun</th><th>Tip</th><th>Detay</th></tr>
            <tr><td><code>id</code></td><td>Integer PK</td><td>Otomatik artış</td></tr>
            <tr><td><code>qr_code</code></td><td>String(50)</td><td>Benzersiz, indeksli. Deterministik: X1, X2, Y1, Y2, vb.</td></tr>
            <tr><td><code>product_code</code></td><td>String(100)</td><td>İndeksli. Örn: KC_18 (Kabatel 1.8mm), KL_18 (Kalaylama 1.8mm)</td></tr>
            <tr><td><code>product_name</code></td><td>String(200)</td><td>Okunabilir ad</td></tr>
            <tr><td><code>production_step</code></td><td>String(50)</td><td>İndeksli. Enum: kabatel_cekme, kalaylama, incetel, buncher, extruder, ebeam</td></tr>
            <tr><td><code>initial_weight_kg</code></td><td>Float</td><td>İlk üretildiğindeki ağırlık</td></tr>
            <tr><td><code>remaining_weight_kg</code></td><td>Float</td><td>Mevcut ağırlık (bir sonraki adımda tüketildikçe azalır)</td></tr>
            <tr><td><code>basket_number</code></td><td>Integer</td><td>Oturum içinde sıralı</td></tr>
            <tr><td><code>allocation</code></td><td>String(20)</td><td><code>ORDER</code> (müşteri siparişine bağlı) veya <code>STOCK</code> (serbest envanter)</td></tr>
            <tr><td><code>order_id</code></td><td>Integer FK</td><td>allocation = ORDER ise <code>orders.id</code>&rsquo;ye referans</td></tr>
            <tr><td><code>status</code></td><td>String(50)</td><td>İndeksli. Enum: available, in_use, consumed, reserved, shipped</td></tr>
            <tr><td><code>production_output_id</code></td><td>Integer FK</td><td><code>production_outputs.id</code>&rsquo;ye referans, indeksli</td></tr>
            <tr><td><code>session_id</code></td><td>Integer FK</td><td><code>production_sessions.id</code>&rsquo;ye referans</td></tr>
            <tr><td><code>work_card_id</code></td><td>Integer FK</td><td><code>work_cards.id</code>&rsquo;ye referans</td></tr>
            <tr><td><code>source_qr_codes</code></td><td>Text</td><td>Tam izlenebilirlik için girdi QR kodlarının JSON dizisi (örn. bir Kalaylama Y1, Kabatel X3 ve X4&rsquo;ü tüketmiş)</td></tr>
            <tr><td><code>produced_at</code></td><td>DateTime</td><td>Üretim zamanı</td></tr>
            <tr><td><code>consumed_at</code></td><td>DateTime</td><td>Tamamen tüketilme zamanı (nullable)</td></tr>
            <tr><td><code>created_at</code></td><td>DateTime</td><td>UTC</td></tr>
            <tr><td><code>updated_at</code></td><td>DateTime</td><td>Otomatik güncelleme</td></tr>
            <tr><td><code>notes</code></td><td>Text</td><td>İsteğe bağlı notlar</td></tr>
        </table>

        <p><strong>Bileşik indeksler:</strong> Adım bazlı filtreleme için <code>(production_step, status)</code>, ürün bazlı gruplama için <code>(product_code, status)</code>. 4 yabancı anahtar siparişlere, üretim çıktılarına, oturumlara ve iş kartlarına bağlanır.</p>

        <h3>3.2 materials (Hammadde modülünden)</h3>
        <p>Hammadde envanter tablosu (Hammadde modülünde belgelenmiştir). Hammadde Stok bu tabloyu doğrudan <code>GET /api/materials/list</code> üzerinden okur. Her satır QR kodu, ağırlığı, tedarikçisi, lot numarası ve durumuyla bir fiziksel hammadde lotunu temsil eder. 8 malzeme türü: raw_copper, raw_tin, raw_plastic, raw_catalyst, raw_dye, raw_antirodent, raw_palette, raw_reel.</p>

        <h3>3.3 Projeksiyon&rsquo;u Besleyen Harici Tablolar</h3>

        <table>
            <tr><th>Tablo</th><th>Modül</th><th>Projeksiyon Ne Okur</th></tr>
            <tr><td><code>work_cards</code></td><td>Üretim</td><td><code>sevkiyat_week</code> (teslim haftası), <code>machine_type</code>, <code>material_details</code> JSON, <code>status</code> (CANCELLED hariç)</td></tr>
            <tr><td><code>material_orders</code></td><td>Hammadde</td><td><code>material_type</code>, <code>quantity</code>, <code>expected_date</code>, <code>delivered_date</code>, <code>delivered_quantity</code>, <code>status</code> (CANCELLED hariç)</td></tr>
        </table>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>Ayrı bir &ldquo;projeksiyon&rdquo; tablosu yoktur.</strong> Projeksiyon, iş kartları ve malzeme siparişlerinden anlık olarak hesaplanır. Bu bilinçli bir tasarım kararıdır: Projeksiyon planı yansıttığı için (depolanmış bir durumu değil), senkronizasyon veya önbellek geçersiz kılma gerektirmeden her zaman planın en güncel halini gösterir. Ödün, istek başına hesaplama maliyetidir, ancak sorgu kapsamı (milyonlarca değil yüzlerce iş kartı ve sipariş) bunu uygulanabilir kılar.</p>
        </div>

        <!-- ============================================ -->
        <h2 id="sec-4">4. BACKEND MİMARİSİ</h2>
        <!-- ============================================ -->

        <h3>4.1 Route Dosyaları</h3>

        <table>
            <tr><th>Dosya</th><th>Satır</th><th>Prefix</th><th>Endpoint</th><th>Amaç</th></tr>
            <tr><td><code>projeksiyon_routes.py</code></td><td>245</td><td><code>/api/projeksiyon</code></td><td>4</td><td>Stok projeksiyonu: ana veri, özet, debug, malzeme bazlı detay</td></tr>
            <tr><td><code>half_product_routes.py</code></td><td>327</td><td><code>/api/stock</code></td><td>6</td><td>Yarı mamul CRUD: liste, adım bazlı, özet, QR bazlı, güncelle, sil</td></tr>
            <tr><td><code>material_routes.py</code></td><td>(Hammadde)</td><td><code>/api/materials</code></td><td>~4</td><td>Hammadde listeleme (Hammadde modülüyle paylaşılır)</td></tr>
        </table>

        <h3>4.2 Projeksiyon Servisi (804 satır)</h3>
        <p>Modülün hesaplama kalbi. <code>ProjeksiyonService</code> tüm projeksiyon hesaplamasını yönetir:</p>

        <table>
            <tr><th>Metot</th><th>Ne Yapar</th></tr>
            <tr><td><code>get_earliest_data_week_offset()</code></td><td>Veri içeren en erken haftayı bulmak için hem iş kartlarını hem malzeme siparişlerini tarar. Kümülatif hesaplamaların önceki yıllardan gelen verileri de içermesini sağlar (örn. 2025 siparişleri 2026 projeksiyonunu hâlâ etkiler).</td></tr>
            <tr><td><code>get_requirements_by_week(weeks)</code></td><td>İptal edilmemiş TÜM iş kartlarını okur, hafta ve kategori bazında malzeme gereksinimlerini çıkarır. 5 makine türünü 8 malzeme kategorisine eşler. Hem toplu hem de belirli malzeme adına göre detaylı kırılımlar üretir. Hafta başına tekrarlanan malzeme adlarını birleştirir.</td></tr>
            <tr><td><code>get_incoming_by_week(weeks)</code></td><td>İptal edilmemiş TÜM malzeme siparişlerini okur. Teslim edilenler için gerçek teslim tarihi/miktarı; bekleyen/sevk edilenler için beklenen tarih/miktar kullanır. Aynı 8 kategoriye eşler. Tedarikçi kataloğundan belirli malzeme adlarını çözümler.</td></tr>
            <tr><td><code>get_projeksiyon(num_weeks, offset)</code></td><td>Ana metot. Hafta pencerelerini üretir, TÜM haftalar için (yalnızca görüntüleme penceresi değil) gereksinimleri ve gelenleri çeker, kategori ve alt-malzeme başına kümülatif hesaplar, frontend açık tespiti için görüntüleme öncesi kümülatif durumu yakalar, yapılandırılmış yanıt döndürür.</td></tr>
        </table>

        <h3>4.3 API Sözleşmesi &mdash; Projeksiyon Endpoint&rsquo;leri (4)</h3>

        <table>
            <tr><th>Metot</th><th>Yol</th><th>Parametreler</th><th>Ne Yapar</th></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon</code></td><td><code>weeks</code> (4&ndash;52, varsayılan 10), <code>offset</code> (&minus;260 ile +260)</td><td>Ana endpoint. Malzeme başına ARTI/EKSİ/kümülatif, alt-malzeme kümülatifleri, tüketim ve gelen detay dizileri, navigasyon bilgisi ile haftalık kırılım döndürür.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/summary</code></td><td><code>weeks</code> (4&ndash;52, varsayılan 8)</td><td>Açık uyarı endpoint&rsquo;i. Tüm haftalarda negatif kümülatifleri tarar, malzeme, hafta ve kümülatif değerle açık olaylarının listesini döndürür.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/material/{type}</code></td><td><code>type</code> (8 geçerli), <code>weeks</code></td><td>Malzeme bazlı detay. Tek bir malzeme türü için tam artı/eksi/kümülatif ile haftalık veri döndürür. Plastik türü için plastik detaylarını içerir.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/debug</code></td><td>&mdash;</td><td>Debug endpoint&rsquo;i. DB&rsquo;deki benzersiz sevkiyat_week&rsquo;leri, hafta başına kart sayısı, material_details anahtarlarıyla örnek iş kartları, örnek malzeme siparişlerini gösterir.</td></tr>
        </table>

        <h3>4.4 API Sözleşmesi &mdash; Yarı Mamul Endpoint&rsquo;leri (6)</h3>

        <table>
            <tr><th>Metot</th><th>Yol</th><th>Ne Yapar</th></tr>
            <tr><td><code>GET</code></td><td><code>/api/stock/half-products</code></td><td>İsteğe bağlı <code>production_step</code> ve <code>status</code> filtreleriyle tüm yarı mamulleri listeler. Sayfalanmış (limit/offset).</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/stock/half-products/by-step/{step}</code></td><td>Oturumdan operatör adıyla belirli bir üretim adımı için öğeleri getirir. Ürün Stok sayfası tarafından kullanılır (7 paralel çağrı).</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/stock/half-products/summary</code></td><td>6 üretim adımı için adım başına toplu sayılar ve ağırlıklar (mevcut sayı, mevcut kg, toplam sayı).</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/stock/half-products/{qr_code}</code></td><td>QR koduna göre tek öğe getirir.</td></tr>
            <tr><td><code>PUT</code></td><td><code>/api/stock/half-products/{id}</code></td><td>İzin verilen alanları günceller: <code>remaining_weight_kg</code>, <code>status</code>, <code>notes</code>.</td></tr>
            <tr><td><code>DELETE</code></td><td><code>/api/stock/half-products/{id}</code></td><td>Kalıcı silme. Bağlı <code>production_output</code>&rsquo;u da siler ve bu son numaraysa QR sırasını azaltır.</td></tr>
        </table>

        <!-- ============================================ -->
        <h2 id="sec-5">5. FRONTEND</h2>
        <!-- ============================================ -->

        <h3>5.1 Sayfa Yapısı</h3>

        <table>
            <tr><th>Route</th><th>Bileşen</th><th>Satır</th><th>Amaç</th></tr>
            <tr><td><code>/stok/projeksiyon</code></td><td><code>Stok/Projeksiyon/index.tsx</code></td><td><strong>3.323</strong></td><td>Tüm ERP&rsquo;deki en büyük bileşen. Genişletilebilir alt-malzeme sütunlarıyla haftalık tahmin tablosu + 3 grafik türü (Çizgi, Isı Haritası, Radar). Malzeme filtreleme, hafta navigasyonu, gizli açık tespiti.</td></tr>
            <tr><td><code>/stok/urun-stok</code></td><td><code>Stok/UrunStok/index.tsx</code></td><td>866</td><td>Yarı mamul envanter. 7 Collapse paneli (her üretim adımı için birer tane), 3 seviyeli tablo hiyerarşisi (adım &rarr; ürün grubu &rarr; bireysel öğe), düzenle/sil, bağlı test görüntüleme.</td></tr>
            <tr><td><code>/stok/hammadde-stok</code></td><td><code>Stok/HammaddeStok/index.tsx</code></td><td>676</td><td>Hammadde envanter. 8 Collapse paneli (her malzeme türü için birer tane), 3 seviyeli tablo hiyerarşisi (tür &rarr; malzeme adı &rarr; bireysel lot), koşullu ağırlık renklendirmesi, düzenle/sil.</td></tr>
        </table>

        <p><strong>Toplam frontend:</strong> 3 sayfada 4.865 satır. Projeksiyon tek başına kodun %68&rsquo;ini oluşturur.</p>

        <h3>5.2 Ortak Kalıplar</h3>
        <ul>
            <li><strong>WebSocket yok:</strong> Üç sayfanın tamamı REST API polling veya tek seferlik fetch kullanır. Gerçek zamanlı abonelik yoktur.</li>
            <li><strong>Türkçe yerel ayar:</strong> Tüm sayfalar <code>ConfigProvider locale={trTR}</code> içinde <code>dayjs</code> ile <code>Europe/Istanbul</code> zaman dilimi dönüşümüyle sarılır.</li>
            <li><strong>ProTable yok:</strong> Diğer modüllerden farklı olarak stok sayfaları düz Ant Design <code>Table</code> bileşenleri kullanır (Hammadde modülünde bulunan HammaddeSipariş hariç).</li>
            <li><strong>İstemci tarafı gruplama:</strong> Hem Ürün Stok hem Hammadde Stok verileri çeker ve istemci tarafında gruplar (sırasıyla product_code ve material_name&rsquo;e göre).</li>
        </ul>

        <h3>5.3 Projeksiyon &mdash; Frontend Öne Çıkanlar</h3>
        <p>3.323 satırıyla Projeksiyon, ERP&rsquo;deki en büyük React bileşenlerinden biridir. İki sekmesi vardır:</p>

        <p><strong>Sekme 1 &mdash; Tablo Görünümü:</strong> Hafta satırları ve 8 malzeme sütunuyla dinamik bir tablo. Her malzeme sütunu gelen (yeşil &uarr;), tüketim (kırmızı &darr;) ve kümülatif bakiye (renk kodlu Tag) gösterir. Sütunlar <strong>genişletilebilir</strong>: bir malzeme başlığına tıklamak bireysel alt-malzeme sütunlarını açar (örn. Bakır altında &ldquo;Filamaşin&rdquo;, Plastik altında &ldquo;HFX 500P&rdquo;). Genişletilmeyen malzemeler trafik ışığı göstergeleriyle 20px renk çubuklarına daraltılır. Hafta navigasyonu offset parametresiyle 10 haftalık pencereyi kaydırır. Özet satırı son kümülatifleri gösterir.</p>

        <p><strong>Sekme 2 &mdash; Grafik Görünümü:</strong> <strong>ReactECharts</strong> ile çalışan üç değiştirilebilir grafik türü:</p>
        <ol>
            <li><strong>Çizgi Grafik:</strong> Alan dolgusuyla yumuşak kümülatif çizgiler. Genel bakış modu (tüm malzemeler) veya detay modu (1&ndash;3 seçili malzeme için alt-malzeme yığılmış çubuklar + kümülatif üst katman).</li>
            <li><strong>Isı Haritası:</strong> Haftalar (x) vs malzemeler/alt-malzemeler (y), malzeme başına normalizasyonla kırmızıdan yeşile renklendirilmiş. Özel HTML eksen tooltip&rsquo;ları açık başlangıcı/artışı bilgisi gösterir.</li>
            <li><strong>Radar Grafik:</strong> Birleştirilmiş mod (4 hafta üst üste) veya bireysel mod (sayfalanmış örümcek ağları). 50 = sıfır çizgisi ile normalleştirilmiş 0&ndash;100 ölçeği. İşarete göre renklendirilmiş zengin metin etiketleri.</li>
        </ol>

        <p><strong>Gizli Açık Tespiti:</strong> En sofistike özellik. Toplam Bakır kümülatifi pozitifken alt-malzeme &ldquo;Filamaşin 8mm&rdquo; negatifse, hücre bir uyarı tooltip&rsquo;uyla <span class="good">yeşil arka plan</span> üzerinde <span class="bad">kırmızı kenarlık</span> alır. Bu, üç grafik türünün tamamında görünür.</p>

        <h3>5.4 Ürün Stok &mdash; Frontend Öne Çıkanlar</h3>
        <p>7 Collapse paneli (Kabatel, Kalaylama, İncetel, Buncher, Extruder, E-Beam, Aktarma), her biri renk kodlu bir ikon ve 3 başlık istatistiğiyle (Toplam kg, Sipariş kg, Serbest kg). 2. seviyede product_code&rsquo;a göre gruplanmış öğeler, 3. seviyede bireysel QR kodlu öğeler. Özellikler: düzenleme modalı (ağırlık, tahsis, notlar), onaylı silme ve production_output_id&rsquo;si olan herhangi bir öğe için Lab modülünden test sonuçlarını çeken <strong>bağlı test görüntüleyici</strong>.</p>

        <h3>5.5 Hammadde Stok &mdash; Frontend Öne Çıkanlar</h3>
        <p>8 Collapse paneli (Bakır, Kalay, Plastik, Katalizör, Boya, Antirodent, Palet, Makara). Yapısal olarak Ürün Stok&rsquo;u yansıtır ancak hammaddeler içindir. Birimler uyarlanır: çoğu malzeme için kg, palet ve makara için &ldquo;adet&rdquo;. <strong>Koşullu ağırlık renklendirmesi:</strong> kalan ağırlık orijinalin %20&rsquo;sinin altında <span class="bad">kırmızı</span>, orijinalin %95&rsquo;inin altında <span style="color: #ca8a04; font-weight: 700;">sarı</span> gösterilir. Tek bir API çağrısı tüm malzemeleri çeker; <code>material_type</code>&rsquo;a göre istemci tarafı gruplama.</p>

        <h3>5.6 Yetki Sistemi</h3>
        <table>
            <tr><th>Sayfa</th><th>Route Guard</th><th>Manifest Butonları</th></tr>
            <tr><td>Projeksiyon</td><td><code>canStok</code></td><td><code>access_page</code>, <code>view_projections</code>, <code>create_projection</code>, <code>edit_projection</code></td></tr>
            <tr><td>Ürün Stok</td><td><code>canStok</code></td><td><code>access_page</code>, <code>view_table</code>, <code>view_details</code>, <code>edit_stock</code>, <code>adjust_quantity</code></td></tr>
            <tr><td>Hammadde Stok</td><td><code>canStok</code></td><td><code>access_page</code>, <code>view_table</code>, <code>view_details</code>, <code>edit_stock</code>, <code>adjust_quantity</code></td></tr>
        </table>

        <p>Üç sayfanın tamamı <code>access.ts</code>&rsquo;den <code>canStok</code> route guard&rsquo;ını paylaşır. Buton düzeyi izinler manifest&rsquo;te tanımlıdır ancak şu an sayfa bileşenlerinde uygulanmamaktadır &mdash; route düzeyi guard aktif erişim kontrolüdür.</p>

        <!-- ============================================ -->
        <h2 id="sec-6">6. ALT MODÜLLER</h2>
        <!-- ============================================ -->

        <p>Stok modülünün karmaşıklık sırasına göre üç alt modülü vardır:</p>

        <div class="submod-card">
            <div class="submod-num">6.1</div>
            <div class="submod-body">
                <h4>Projeksiyon (Stok Tahmini)</h4>
                <p>Malzeme arz ve talebinin haftalık tahmini. 804 satırlık backend servisi + 3.323 satırlık frontend &mdash; ERP&rsquo;deki en büyük React bileşenlerinden biri. Salt okunur: CRUD yok, saf hesaplama.</p>
                <div class="submod-tags">
                    <span class="submod-tag">3.323 SATIR FRONTEND</span>
                    <span class="submod-tag">804 SATIR SERVİS</span>
                    <span class="submod-tag">4 ENDPOINT</span>
                    <span class="submod-tag">3 GRAFİK TÜRÜ</span>
                </div>
            </div>
        </div>

        <div class="submod-card">
            <div class="submod-num">6.2</div>
            <div class="submod-body">
                <h4>Hammadde Stok</h4>
                <p>Tüm hammaddelerin canlı envanteri (bakır, kalay, plastik, katalizör, boya, antirodent, palet, makara). Hammadde modülünün <code>materials</code> tablosundan okur. 8 collapse paneli, koşullu ağırlık renklendirmesi, düzenle/sil.</p>
                <div class="submod-tags">
                    <span class="submod-tag">676 SATIR FRONTEND</span>
                    <span class="submod-tag">8 MALZEME KATEGORİSİ</span>
                    <span class="submod-tag">PAYLAŞILAN API</span>
                </div>
            </div>
        </div>

        <div class="submod-card">
            <div class="submod-num">6.3</div>
            <div class="submod-body">
                <h4>Ürün Stok</h4>
                <p>Tüm üretim adımlarındaki yarı mamul ve mamul ürünlerin canlı envanteri. Makine türüne göre düzenlenmiş 7 collapse paneli, 3 seviyeli gruplama, Lab modülüyle bağlı test entegrasyonu.</p>
                <div class="submod-tags">
                    <span class="submod-tag">866 SATIR FRONTEND</span>
                    <span class="submod-tag">6 ENDPOINT</span>
                    <span class="submod-tag">7 ÜRETİM ADIMI</span>
                    <span class="submod-tag">LAB ENTEGRASYONU</span>
                </div>
            </div>
        </div>


        <!-- ============================================= -->
        <!--  6.1  PROJEKSİYON (Stok Tahmini)              -->
        <!-- ============================================= -->

        <h2 id="sec-6-1">6.1 &mdash; Projeksiyon (Stok Tahmini)</h2>

        <h3>6.1.1 &mdash; Amaç ve İş Bağlamı</h3>
        <p>Projeksiyon, fabrikadaki en ileri görüşlü soruyu yanıtlar: <strong>&ldquo;Hafta hafta, her hammaddeden yeterince olacak mı, yoksa açık mı verecek?&rdquo;</strong> İki veri akışını &mdash; üretim planlarından (iş kartları) gelen malzeme tüketimini ve satın alma siparişlerinden gelen malzeme varışlarını &mdash; her iki yönde 5 yıla kadar uzanan, gezinilebilir tek bir haftalık tahmine harmanlayan salt okunur, hesaplanmış bir görünümdür.</p>
        <p>Bu, önceden hesaplanmış anlık görüntülerle bir dashboard değildir. Sayfa her yüklendiğinde, backend iptal edilmemiş TÜM iş kartlarını ve iptal edilmemiş TÜM malzeme siparişlerini sorgular, en erken veri noktasından itibaren her hafta boyunca kümülatif bir bakiye hesaplar ve kullanıcının 10 haftalık görüntüleme penceresi için sonucu döndürür. Projeksiyon <strong>her zaman taze</strong>dir &mdash; önbellekleme yok, depolanmış durum yok, bayat veri yok.</p>
        <p>Sayfa iki kitleye hizmet eder: <strong>satın alma ekibi</strong> (daha fazla malzeme sipariş etme zamanını bilmesi gereken) ve <strong>üretim planlayıcıları</strong> (yaklaşan iş kartlarının açık yaratıp yaratmayacağını bilmesi gereken). 3.323 satır frontend kodu ve 804 satır backend servisiyle, Stok modülündeki en büyük ve en karmaşık bileşenlerden biridir.</p>

        <h3>6.1.2 &mdash; İki Veri Akışı</h3>
        <p>Projeksiyon&rsquo;daki her veri parçası iki kaynaktan birinden gelir:</p>

        <div class="arch-grid">
            <div class="arch-box" style="border-left: 4px solid #dc2626;">
                <h4>EKSİ (MINUS) &mdash; Malzeme Gereksinimleri</h4>
                <p><strong>Kaynak:</strong> <code>work_cards</code> tablosu (Üretim modülü)</p>
                <p><strong>Anahtar alan:</strong> <code>sevkiyat_week</code> (teslim haftası, örn. &ldquo;2026-W12&rdquo;)</p>
                <p><strong>Ne çıkarır:</strong> Her iş kartı bir <code>material_details</code> JSON&rsquo;u taşır. Servis 5 makine türünü 8 malzeme kategorisine eşler:</p>
                <ul>
                    <li><code>kabatel_cekme</code> &rarr; <code>copper_kg</code> (Filamaşin)</li>
                    <li><code>kalaylama</code> &rarr; <code>tin_kg</code> (Kalay)</li>
                    <li><code>extruder</code> &rarr; plastik, katalizör, boya, antirodent (<code>insulation_materials[]</code> ve <code>sheath_materials[]</code>&rsquo;den)</li>
                    <li><code>aktarma</code> &rarr; makara (<code>makara_distributions[]</code>&rsquo;den) &mdash; not: kangal plastik ambalaj kullanır ve İZLENMEZ</li>
                    <li><code>paletleme</code> &rarr; palet (<code>palettes[]</code>&rsquo;den)</li>
                </ul>
                <p><strong>Dahil eder:</strong> CANCELLED dışındaki TÜM durumlar &mdash; tamamlanmış iş kartları bile sayılır çünkü plan gerçekleşmiştir.</p>
            </div>

            <div class="arch-box" style="border-left: 4px solid #16a34a;">
                <h4>ARTI (PLUS) &mdash; Gelen Malzemeler</h4>
                <p><strong>Kaynak:</strong> <code>material_orders</code> tablosu (Hammadde modülü)</p>
                <p><strong>Anahtar alan:</strong> <code>expected_date</code> veya <code>delivered_date</code></p>
                <p><strong>Dinamik geçiş:</strong> Bekleyen/sevk edilen siparişler için <code>expected_date</code> + <code>quantity</code> (plan) kullanır. Teslim edilen siparişler için <code>delivered_date</code> + <code>delivered_quantity</code>&rsquo;ye (gerçek) geçer. Bu, projeksiyonun teslimatlar gerçekleştikçe gerçekliği dinamik olarak yansıtması anlamına gelir.</p>
                <p><strong>Malzeme çözümleme:</strong> Servis, <code>supplier_material</code> ilişkisi üzerinden belirli malzeme adlarını çözümler (örn. sadece &ldquo;plastik&rdquo; değil &ldquo;HFX 500P&rdquo;). Tedarikçi malzemesi bağlı değilse kategori adına düşer.</p>
                <p><strong>Dahil eder:</strong> CANCELLED dışındaki TÜM durumlar.</p>
            </div>
        </div>

        <h3>6.1.3 &mdash; Kümülatif Hesaplama Motoru</h3>
        <p>Projeksiyon&rsquo;un çekirdeği <code>ProjeksiyonService.get_projeksiyon()</code>&rsquo;da yaşar. Hesaplama basit bir &ldquo;bu haftanın artı ve eksisini göster&rdquo; değildir &mdash; <strong>tam tarihsel kümülatif toplam</strong>dır:</p>

        <ol>
            <li><strong>En erken veriyi bul:</strong> <code>get_earliest_data_week_offset()</code> hem iş kartlarını (<code>MIN(sevkiyat_week)</code>) hem malzeme siparişlerini (<code>MIN(expected_date)</code>, <code>MIN(delivered_date)</code>) tarayarak herhangi bir verisi olan en ilk haftayı bulur. Bu bir önceki yılda olabilir (örn. 2025 siparişleri hâlâ 2026 projeksiyonunu etkiler).</li>
            <li><strong>TÜM haftaları üret:</strong> En erken veri haftasından kullanıcının görüntüleme penceresindeki son haftaya kadar (örn. en erken veri 2025-W40 ve kullanıcı 2026-W05&ndash;W14 görüntülüyorsa, sistem W40&rsquo;tan W14&rsquo;e kadar haftalar üretir &mdash; 10 haftalık bir görünüm için 27 haftalık hesaplama).</li>
            <li><strong>TÜM haftalar için gereksinimleri ve gelenleri çek:</strong> İki toplu sorgu: biri <code>sevkiyat_week</code>&rsquo;e göre gruplanmış iş kartları, biri ilgili haftalarına eşlenmiş malzeme siparişleri.</li>
            <li><strong>Her haftayı sırayla işle:</strong> Her hafta için malzeme kategorisi başına <code>haftalık = artı - eksi</code> hesapla ve kümülatif toplama ekle. Ayrıca alt-malzeme kümülatiflerini de izle (örn. Bakır içindeki &ldquo;Filamaşin 8mm&rdquo;).</li>
            <li><strong>Görüntüleme öncesi durumu yakala:</strong> Kullanıcının görüntüleme penceresindeki ilk haftayı işlemeden önce, mevcut kümülatif durumun anlık görüntüsünü <code>pre_view_sub_material_cumulatives</code>&rsquo;e al. Bu, frontend&rsquo;in gizli açık tespiti için kritiktir.</li>
            <li><strong>Yalnızca görüntüleme haftalarını döndür:</strong> İşlenen tüm haftalardan yalnızca kullanıcının gerçekten görüntülediği 10 hafta yanıta dahil edilir. Ancak kümülatif değerleri TÜM tarihsel veriyi içerir.</li>
        </ol>

        <div class="warning">
            <p style="margin-bottom: 0;"><strong>Neden sadece görüntüleme penceresini hesaplamıyoruz?</strong> Yalnızca 5&ndash;14 haftalarını hesaplarsanız ve 2. haftada büyük bir bakır teslimatı olduysa, 5. haftanın kümülatifi +5000 kg yerine 0 gösterir. Doğru kümülatif bakiyeler için tarihsel bağlam esastır. Ödün, istek başına daha fazla hesaplamadır, ancak veri hacmi (milyonlarca değil yüzlerce kayıt) bu yaklaşımı önbellekleme olmadan uygulanabilir kılar.</p>
        </div>

        <h3>6.1.4 &mdash; Detay Konsolidasyonu</h3>
        <p>Hem <code>get_requirements_by_week()</code> hem <code>get_incoming_by_week()</code> kategori başına toplu toplamların yanı sıra <strong>belirli malzeme adına göre detaylı kırılımlar</strong> da üretir. Örneğin, bir Extruder iş kartı 200 kg &ldquo;HFX 500P&rdquo; ve 150 kg &ldquo;HFFR 302&rdquo; tüketebilir &mdash; ikisi de &ldquo;plastik&rdquo;tir ancak bireysel olarak izlenir.</p>
        <p>Tüm kartları/siparişleri işledikten sonra, servis her hafta içindeki tekrarlanan adları <strong>birleştirir</strong>. Aynı haftadaki iki Extruder kartı da &ldquo;HFX 500P&rdquo; tüketiyorsa, miktarları tek bir detay girişinde birleştirilir. Bu konsolidasyon 8 detay dizisinin tamamında çalışır.</p>

        <h3>6.1.5 &mdash; API Endpoint&rsquo;leri</h3>
        <table>
            <tr><th>Metot</th><th>Yol</th><th>Parametreler</th><th>Amaç</th></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon</code></td><td><code>weeks</code> (4&ndash;52, varsayılan 10), <code>offset</code> (&minus;260 ile +260)</td><td>Ana endpoint. Malzeme kategorisi başına ARTI/EKSİ/kümülatif, hafta başına alt-malzeme kümülatifleri, gereksinim ve gelen detay dizileri, iş kartı ve sipariş sayıları, navigasyon metadata&rsquo;sı ve açık tespiti için görüntüleme öncesi alt-malzeme kümülatifleri ile haftalık kırılım döndürür.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/summary</code></td><td><code>weeks</code> (4&ndash;52, varsayılan 8)</td><td>Açık uyarı endpoint&rsquo;i. Negatif kümülatifi olan herhangi bir malzeme kategorisi için tüm haftaları tarar, malzeme anahtarı, etiketi, hafta, kümülatif değer ve birimle açık olaylarının düz bir listesini döndürür.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/material/{type}</code></td><td><code>type</code> (8 geçerli tür), <code>weeks</code></td><td>Malzeme bazlı detay. Tek bir malzeme türü için haftalık artı/eksi/kümülatif döndürür. Plastik türü için plastik detay kırılımını içerir.</td></tr>
            <tr><td><code>GET</code></td><td><code>/api/projeksiyon/debug</code></td><td>&mdash;</td><td>Debug endpoint&rsquo;i. Veritabanındaki benzersiz <code>sevkiyat_week</code> değerlerini, hafta başına kart sayısını, <code>material_details</code> anahtarlarıyla örnek iş kartlarını ve örnek malzeme siparişlerini gösterir.</td></tr>
        </table>

        <h3>6.1.6 &mdash; Frontend Mimarisi (3.323 Satır)</h3>
        <p>Projeksiyon sayfası iki sekmeli tek bir React bileşenidir: <strong>Projeksiyon</strong> (tablo görünümü) ve <strong>Grafikler</strong> (grafik görünümü). Her iki sekme de aynı API yanıtını kullanır.</p>

        <h4>Durum Yönetimi</h4>
        <table>
            <tr><th>Durum Değişkeni</th><th>Tip</th><th>Amaç</th></tr>
            <tr><td><code>projeksiyonData</code></td><td><code>ProjeksiyonResponse | null</code></td><td>Tüm API yanıtı, her iki sekme arasında paylaşılır</td></tr>
            <tr><td><code>weekOffset</code></td><td><code>number</code></td><td>H01&rsquo;den mevcut hafta ofseti. Navigasyon oklarıyla değişir. API yeniden çağrısını tetikler.</td></tr>
            <tr><td><code>expandedMaterials</code></td><td><code>string[]</code></td><td>Hangi malzeme sütunlarının alt-malzemeleri göstermek için genişletildiği</td></tr>
            <tr><td><code>knownSubMaterials</code></td><td><code>Record&lt;string, string[]&gt;</code></td><td>Keşfedilen alt-malzeme adlarını navigasyonlar boyunca kalıcı kılar, böylece genişletme okları kaybolmaz</td></tr>
            <tr><td><code>graphType</code></td><td><code>'line' | 'heatmap' | 'waterfall'</code></td><td>Aktif grafik türü (waterfall aslında radar)</td></tr>
            <tr><td><code>selectedGraphMaterials</code></td><td><code>string[]</code></td><td>Grafikler için malzeme filtresi. Boş = &ldquo;Tümü&rdquo;. 1&ndash;3 = alt-malzeme kırılımlı detay modu.</td></tr>
            <tr><td><code>radarViewMode</code></td><td><code>'merged' | 'individual'</code></td><td>Radar grafik görüntüleme modu: 4 hafta üst üste vs. sayfalanmış bireysel örümcek ağları</td></tr>
            <tr><td><code>radarPage</code></td><td><code>number</code></td><td>Bireysel radar modu sayfalama için mevcut sayfa</td></tr>
            <tr><td><code>activeTab</code></td><td><code>'projeksiyon' | 'grafikler'</code></td><td>Mevcut sekme</td></tr>
        </table>

        <h3>6.1.7 &mdash; Sekme 1: Projeksiyon Tablosu</h3>
        <p>Tablo birincil arayüzdür. 10 haftayı satır, 8 malzeme kategorisini sütun olarak gösterir. Tablo bir Ant Design <code>ProTable</code> DEĞİLDİR &mdash; yoğun şekilde özelleştirilmiş sütun renderlamasıyla düz bir <code>Table</code>&rsquo;dır.</p>

        <h4>Sütun Yapısı</h4>
        <p>Her malzeme sütunu hücre başına üç bilgi renderlar:</p>
        <ul>
            <li><strong>Gelen (ARTI):</strong> O hafta gelen malzeme miktarıyla yeşil yukarı ok</li>
            <li><strong>Tüketim (EKSİ):</strong> Tüketilen malzeme miktarıyla kırmızı aşağı ok</li>
            <li><strong>Kümülatif:</strong> Bakiyeyi gösteren renk kodlu <code>Tag</code>. Pozitifse (fazla) yeşil, negatifse (açık) kırmızı, sıfırsa gri.</li>
        </ul>

        <h4>Genişletilebilir Alt-Malzeme Sütunları</h4>
        <p>En ayırt edici özelliklerden biri. Her malzeme sütun başlığında küçük bir genişletme oku vardır. Tıklamak, ana kategorinin altına yerleştirilmiş <strong>bireysel alt-malzeme sütunlarını</strong> açar. Örneğin, &ldquo;Plastik&rdquo;i genişletmek &ldquo;HFX 500P&rdquo;, &ldquo;HFFR 302&rdquo; ve &ldquo;XLPE&rdquo; sütunlarını açabilir &mdash; her biri o hafta içinde kendi artı/eksi/kümülatifini gösterir.</p>
        <p>Alt-malzeme adları API yanıtının detay dizilerinden keşfedilir ve <code>knownSubMaterials</code>&rsquo;de kalıcı kılınır, böylece hafta navigasyonunda kaybolmazlar. Bir sütun genişletilmediğinde, trafik ışığı göstergesiyle (yeşil nokta = hepsi pozitif, kırmızı nokta = herhangi biri negatif, sarı nokta = karışık) <strong>20px genişliğinde renk çubuğuna</strong> daraltılır.</p>

        <h4>Hafta Navigasyonu</h4>
        <p>Sol/sağ oklar 10 haftalık pencereyi bir seferde 10 hafta kaydırır (<code>weekOffset</code> durumu üzerinden). Bir takvim ikonu mevcut haftaya sıfırlar (<code>offset = 0</code>). API &minus;260 ile +260 sınırlarını zorlar (her yönde 5 yıl). Her navigasyon yeni bir API çağrısı tetikler; backend sıfırdan yeniden hesaplar.</p>

        <h4>Özet Satırı</h4>
        <p>Tablonun son satırı, tüm görüntüleme penceresi boyunca her malzeme için son kümülatifi gösterir.</p>

        <h3>6.1.8 &mdash; Gizli Açık Tespiti</h3>
        <p>Tüm Stok modülündeki en sofistike özellik. Çözdüğü problem:</p>

        <div class="finding">
            <p><strong>Senaryo:</strong> H12 haftası için toplam &ldquo;Plastik&rdquo; kümülatifi <span class="good">+2.500 kg</span>. Her şey yolunda görünüyor. Ama gizlice, alt-malzeme &ldquo;HFX 500P&rdquo; <span class="bad">&minus;180 kg</span>&rsquo;da, &ldquo;HFFR 302&rdquo; ise <span class="good">+2.680 kg</span>&rsquo;da. Bir plastiğin fazlası diğerinin açığını maskeliyor. HFFR&rsquo;yi HFX yerine kullanamazsınız &mdash; kimyasal olarak farklı bileşiklerdir.</p>
        </div>

        <p><strong>Nasıl çalışır:</strong></p>
        <ol>
            <li>Backend, <code>category_materialName</code> anahtarlı bir sözlük olarak <code>sub_material_cumulatives</code>&rsquo;i izler (örn. <code>plastic_HFX 500P</code>). Bu, yalnızca görüntüleme penceresi değil, HER hafta için güncellenir.</li>
            <li>Yanıttaki her hafta kendi <code>sub_material_cumulatives</code> anlık görüntüsünü taşır.</li>
            <li>Frontend kontrol eder: ana kategori kümülatifi &ge; 0 ama o kategori içindeki HERHANGİ bir alt-malzeme negatif kümülatife sahipse, bu bir <strong>gizli açık</strong>tır.</li>
            <li>Görsel gösterge: hücre, hangi belirli alt-malzemelerin açıkta olduğunu listeleyen bir uyarı tooltip&rsquo;uyla <span class="good">yeşil arka plan</span> üzerinde <span class="bad">kırmızı kenarlık</span> alır.</li>
        </ol>
        <p>Bu tespit üç görselleştirme modunun tamamında (tablo, çizgi grafik, ısı haritası, radar) çalışır.</p>

        <h3>6.1.9 &mdash; Sekme 2: Grafik Görünümü</h3>
        <p>Grafikler sekmesi, tamamı <strong>ReactECharts</strong> (<code>echarts-for-react</code>) ile çalışan üç değiştirilebilir görselleştirme türü sunar. Hepsi <code>projeksiyonData</code>&rsquo;dan aynı veriyi paylaşır.</p>

        <h4>Malzeme Filtre Tabletleri</h4>
        <p>Üstteki tıklanabilir tabletler malzemeye göre filtrelemeye izin verir. Üç mod:</p>
        <ul>
            <li><strong>Tümü:</strong> Filtre seçili değil. Grafikler tüm malzemeler için toplam kümülatif çizgileri gösterir.</li>
            <li><strong>1&ndash;3 malzeme seçili (Detay Modu):</strong> Grafikler tüketim ve gelen için alt-malzeme yığılmış çubuklar + alt-malzeme başına kümülatif üst katman çizgileri göstermeye geçer.</li>
            <li><strong>4+ malzeme:</strong> İzin verilmez. UI 4. seçildiğinde en eskisini kaldırarak maksimum 3 seçimi zorlar.</li>
        </ul>

        <h4>Grafik Türü 1: Çizgi Grafik</h4>
        <p>Gradyan alan dolgusuyla yumuşak kümülatif çizgiler. Genel bakış modunda her malzeme kendi çizgisini alır. Kesikli kırmızı sıfır çizgisi açık eşiğini işaretler. Detay modunda alt-malzemeler tüketim (negatif, kırmızı) ve gelen (pozitif, yeşil) için yığılmış çubuk grafikleri alır.</p>

        <h4>Grafik Türü 2: Isı Haritası</h4>
        <p>X ekseninde haftalar, y ekseninde malzemeler/alt-malzemeler olan bir ızgara. Her hücre kümülatif değere göre kırmızıdan yeşile gradyanla renklendirilir. Renklendirme <strong>malzeme başına normalizasyon</strong> kullanır &mdash; her malzeme satırı bağımsız olarak normalleştirilir. Özel HTML eksen tooltip&rsquo;ları detaylı açık bilgisi gösterir.</p>

        <h4>Grafik Türü 3: Radar Grafik</h4>
        <p>İki modda çalışır:</p>
        <ul>
            <li><strong>Birleşik mod:</strong> Son 4 hafta tek bir radar üzerinde üst üste. Her hafta farklı bir renk alır (gri, amber, mor, camgöbeği). Malzemeler çevrede zengin metin etiketleriyle konumlanır. 50 işaretinde kesikli daire sıfır çizgisini temsil eder (ölçek 0&ndash;100 normalleştirilmiş).</li>
            <li><strong>Bireysel mod:</strong> Sayfa başına 4 hafta ayrı örümcek diyagramları olarak sayfalanmış görüntüleme. Sol/sağ oklar haftalar arasında sayfalandırır.</li>
        </ul>

        <h3>6.1.10 &mdash; Dashboard İstatistik Kartları</h3>
        <p>Grafiklerin üzerinde 4 istatistik kartı hızlı bir özet sağlar:</p>
        <ul>
            <li><strong>Toplam Gelen:</strong> Tüm malzemeler ve haftalar genelinde tüm ARTI toplamı</li>
            <li><strong>Toplam İhtiyaç:</strong> Tüm malzemeler ve haftalar genelinde tüm EKSİ toplamı</li>
            <li><strong>Net Bakiye:</strong> Toplam gelen eksi toplam tüketim. Pozitifse yeşil, negatifse kırmızı.</li>
            <li><strong>Stok Sağlığı:</strong> <code>(toplamArtı / toplamEksi) &times; 50</code> olarak hesaplanan, 0&ndash;100 ile sınırlanmış yüzde. Progress çubuğu olarak renderlanır.</li>
        </ul>

        <h3>6.1.11 &mdash; Extruder Malzeme Çıkarma Mantığı</h3>
        <p>En karmaşık malzeme eşlemesi Extruder iş kartları içindir. Tek bir Extruder kartı aynı anda birden fazla malzeme tüketebilir çünkü kablo ekstrüzyonu katmanlı kaplamalar içerir:</p>
        <ol>
            <li><strong>Yalıtım malzemeleri</strong> (<code>insulation_materials[]</code>): Her girişin <code>material_name</code> (plastik türü), <code>plastic_kg</code>, <code>catalyst_name</code>, <code>catalyst_kg</code> ve <code>dye_name</code> ve <code>dye_kg</code> içeren <code>dyes[]</code> dizisi vardır.</li>
            <li><strong>Kılıf malzemeleri</strong> (<code>sheath_materials[]</code>): Yalıtımla aynı yapı ama ayrıca <code>antirodent_name</code> ve <code>antirodent_kg</code> içerir (sadece dış kılıfta kemirgen kovucu olabilir).</li>
        </ol>
        <p>Servis her iki diziyi gezer, bireysel malzeme adlarını ve miktarlarını çıkarır. Tek bir Extruder kartı 3&ndash;4 farklı plastik, 2 katalizör, 2 boya ve 1 antirodent için detay girişleri üretebilir &mdash; hepsi ilgili kategori detay dizilerine eşlenir ve aynı malzeme adı aynı haftada birden fazla kartta görünürse konsolide edilir.</p>

        <h3>6.1.12 &mdash; Hafta Anahtar Sistemi</h3>
        <p>Projeksiyon&rsquo;daki tüm zamansal veriler <code>YYYY-WNN</code> formatında ISO hafta anahtarları kullanır (örn. &ldquo;2026-W12&rdquo;). Servis yardımcı fonksiyonlar sağlar:</p>
        <ul>
            <li><code>get_week_key(date)</code>: Python <code>date</code>&rsquo;ini ISO hafta anahtarına dönüştürür</li>
            <li><code>week_key_to_offset(week_key)</code>: Bir hafta anahtarını mevcut yılın H01&rsquo;inden tamsayı ofsetine dönüştürür. Yıl sınırları ötesinde haftaları karşılaştırmak için kullanılır.</li>
            <li><code>generate_weeks(num_weeks, offset)</code>: week_key, hafta etiketi (H01&ndash;H52), Türkçe tarih aralığı (örn. &ldquo;06-12 Oca&rdquo;) ve ISO başlangıç/bitiş tarihlerini içeren hafta metadata&rsquo;sı üretir.</li>
        </ul>

        <h3>6.1.13 &mdash; Projeksiyonu Ne Değiştirir</h3>
        <p>Projeksiyon anlık olarak hesaplandığından, kaynak verisindeki herhangi bir değişiklik çıktıyı anında etkiler:</p>
        <table>
            <tr><th>Eylem</th><th>Projeksiyon Üzerindeki Etkisi</th></tr>
            <tr><td>Yeni iş kartı oluşturuldu</td><td>Kartın <code>sevkiyat_week</code>&rsquo;i için EKSİ artar</td></tr>
            <tr><td>İş kartının <code>sevkiyat_week</code>&rsquo;i değişti</td><td>EKSİ eski haftadan yeni haftaya taşınır</td></tr>
            <tr><td>İş kartı iptal edildi</td><td>EKSİ kaybolur (CANCELLED sorgudan hariç)</td></tr>
            <tr><td>Yeni malzeme siparişi oluşturuldu</td><td><code>expected_date</code> haftasında ARTI görünür</td></tr>
            <tr><td>Malzeme siparişinin beklenen tarihi değişti</td><td>ARTI eski haftadan yeni haftaya taşınır</td></tr>
            <tr><td>Malzeme sipariş miktarı değişti</td><td>O haftanın ARTI miktarı değişir</td></tr>
            <tr><td>Malzeme siparişi teslim edildi</td><td>ARTI, <code>expected_date</code>/<code>quantity</code>&rsquo;den <code>delivered_date</code>/<code>delivered_quantity</code>&rsquo;ye geçer &mdash; hafta ve miktar ikisi de kayabilir</td></tr>
            <tr><td>Malzeme siparişi iptal edildi</td><td>ARTI tamamen kaybolur</td></tr>
            <tr><td>Üretim fiziksel olarak tamamlandı</td><td><strong>Etkisi yok</strong> &mdash; tamamlanmış iş kartları hâlâ dahil edilir</td></tr>
        </table>

        <h3>6.1.14 &mdash; Yetki Modeli</h3>
        <p>Projeksiyon, <code>access.ts</code>&rsquo;den <code>canStok</code> route guard&rsquo;ını kullanır. Yetki manifest&rsquo;i 4 buton tanımlar: <code>access_page</code>, <code>view_projections</code>, <code>create_projection</code>, <code>edit_projection</code>. Ancak Projeksiyon tamamen salt okunur olduğundan (CRUD işlemi yok), oluşturma ve düzenleme yetkileri artıktır. Etkin erişim kontrolü basitçe kullanıcının Stok sayfalarına erişip erişemeyeceğidir.</p>

        <h3>6.1.15 &mdash; Bu Alt Modülün Yapmadıkları</h3>
        <ul>
            <li>Herhangi bir veri <strong>depolamaz</strong> &mdash; ayrı bir veritabanı tablosu yoktur</li>
            <li>CRUD <strong>desteklemez</strong> &mdash; projeksiyon hesaplanır, düzenlenmez</li>
            <li>WebSocket <strong>kullanmaz</strong> &mdash; veri sayfa yüklendiğinde veya navigasyonda bir kez çekilir</li>
            <li>Sonuçları <strong>önbelleklemez</strong> &mdash; her istek sıfırdan hesaplar</li>
            <li>Mevcut fiziksel stoku <strong>hesaba katmaz</strong> &mdash; yalnızca planlanan tüketim ve planlanan/gerçek varışları izler</li>
            <li>Uyarı <strong>göndermez</strong> &mdash; açık tespiti yalnızca görseldir</li>
            <li>Kangal (makarasız kablo paketleme) <strong>izlemez</strong> &mdash; kangal izlenmeyen plastik ambalaj kullanır</li>
        </ul>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>Tasarım felsefesi:</strong> Projeksiyon kasıtlı olarak kendi durumunu depolamaktan kaçınır. Her şeyi iş kartları ve malzeme siparişlerinden anlık olarak hesaplayarak, projeksiyonun her zaman planın mutlak en güncel halini yansıtmasını garanti eder. Senkronizasyon sorunu yok, bayat önbellek yok, &ldquo;son güncelleme 2 saat önce&rdquo; uyarısı yok. Bedel istek başına hesaplamadır, ancak veri ölçeği (milyonlarca değil yüzlerce kayıt) bunu iyi bir ödünleşim yapar.</p>
        </div>


        <!-- ============================================= -->
        <!--  6.2  HAMMADDE STOK                            -->
        <!-- ============================================= -->

        <h2 id="sec-6-2">6.2 &mdash; Hammadde Stok</h2>

        <h3>6.2.1 &mdash; Amaç ve İş Bağlamı</h3>
        <p>Hammadde Stok, <strong>&ldquo;Depoda şu an fiziksel olarak hangi hammaddeler var ve her birinden ne kadar hâlâ kullanılabilir?&rdquo;</strong> sorusunu yanıtlar.</p>
        <p>Bu sayfa belirli bir iş ihtiyacı nedeniyle var: Hammadde modülünde zaten <strong>Hammaddeler Listesi</strong> var &mdash; her bireysel malzeme kaydını fotoğraflar, WebSocket gerçek zamanlı güncellemeler, iki dilli arama ve ayrıntılı düzenleme formlarıyla gösteren düz, 14 sütunlu bir yönetici tablosu. Ama Hammaddeler Listesi bir <em>kayıt düzeyinde</em> görünümdür. Bir stok yöneticisi &ldquo;ne kadar HFX 500P plastik var?&rdquo; sorusunu yanıtlamak için 500 bireysel QR kodlu girişi kaydırmak istemez. Malzemeleri türe ve ada göre gruplayan, toplamları gösteren ve neyin serbest neyin kullanımda olduğunu vurgulayan <em>toplu kategori düzeyinde</em> bir görünüme ihtiyaç duyar.</p>
        <p>Bu sayfayı dolduran veriler iki yukarı akış sürecinden gelir:</p>
        <ul>
            <li><strong>Hammadde Girişi</strong> kayıtları oluşturur &mdash; fabrikaya hammadde geldiğinde bir operatör dört giriş arketipinden biriyle (bakır, kalay, lot bazlı, sayım bazlı) tarar ve <code>materials</code> tablosuna <code>status = 'received'</code> ve <code>remaining_weight = weight</code> ile girer.</li>
            <li><strong>Üretim (Production)</strong> kayıtları tüketir &mdash; Üretim modülleri (özellikle Kabatel Çekme / tel çekme) bir hammadde kullandığında QR koduna göre seçer ve <code>remaining_weight</code>&rsquo;ten düşer. Tel çekiminden geçen 1.000 kg&rsquo;lık bir bakır filamaşin (A1) 980 kg olarak döner. Üretim ayrıca <code>status</code>&rsquo;u değiştirir: <code>received</code> &rarr; <code>in_use</code> (malzeme şu an makinede) &rarr; <code>consumed</code> (tamamen tükenmiş). &ldquo;Kalan&rdquo; sütununun ve koşullu renklendirmenin (sarı/kırmızı) tam olarak göstermeye tasarlandığı şey budur.</li>
        </ul>
        <p>Yani Hammadde Stok kesişim noktasında durur: Hammadde Girişi doldurur, Üretim boşaltır ve bu sayfa mevcut bakiyeyi görselleştirir. Doğrudan <code>materials</code> tablosundan (Hammadde modülüne ait) paylaşılan <code>/api/materials/list</code> endpoint&rsquo;i aracılığıyla okur &mdash; kendine ait backend route&rsquo;u yoktur. Tüm gruplama ve toplama istemci tarafında gerçekleşir.</p>
        <p>Sayfa, <code>src/pages/Stok/HammaddeStok/index.tsx</code> dosyasında tek bir React bileşeni (<code>HammaddeStok</code>, 676 satır) olarak uygulanmıştır. Ant Design&rsquo;ın <code>Collapse</code> bileşenini iç içe <code>Table</code>&rsquo;larla kullanır, Türkçe yerel ayarıyla (<code>trTR</code>) <code>ConfigProvider</code> içine sarılmıştır.</p>

        <h3>6.2.2 &mdash; CRUD Akışı</h3>

        <p><strong>Okuma (Birincil İşlem):</strong></p>
        <ol>
            <li>Sayfa yüklenir &rarr; <code>useEffect([], [])</code> mount&rsquo;ta <code>fetchMaterials()</code>&rsquo;i tetikler</li>
            <li>Tek bir <code>GET /api/materials/list</code> çağrısı türden bağımsız olarak TÜM hammaddeleri düz bir dizi olarak çeker</li>
            <li>Yanıt <code>processAndGroupMaterials()</code>&rsquo;dan geçer: <code>material_type</code>&rsquo;a göre 8 kovaya filtreler, her kova içinde <code>material_name</code>&rsquo;e göre gruplar, toplam değerleri hesaplar (toplam, rezerve, serbest), her şeyi <code>sectionData</code> state nesnesinde depolar</li>
            <li>Kullanıcı o kategorinin gruplanmış tablosunu görmek için bir Collapse paneline tıklar</li>
            <li>Kullanıcı QR kodları, ağırlıklar, tedarikçi, tarihler ve durumla bireysel lotları görmek için bir grup satırındaki genişletme okuna tıklar</li>
            <li>Kullanıcı istediği zaman tüm verileri yeniden çekmek için sayfa başlığındaki &ldquo;Yenile&rdquo; butonuna tıklayabilir</li>
        </ol>

        <p><strong>Güncelleme (Düzenleme Modalı):</strong></p>
        <ol>
            <li>Herhangi bir bireysel öğe satırındaki (Seviye 3) <code>EditOutlined</code> ikonuna tıklayın</li>
            <li>Modal &ldquo;Düzenle: {QR_CODE}&rdquo; başlığıyla açılır (örn. &ldquo;Düzenle: A7&rdquo;)</li>
            <li>Form, seçilen öğenin mevcut değerlerinden <code>form.setFieldsValue()</code> ile önceden doldurulur</li>
            <li>İki alan mevcut (tam detaylar için 6.2.11&rsquo;e bakınız):
                <ul>
                    <li><code>remaining_weight</code> &mdash; <code>InputNumber</code>, min=0, step=0.1. Palet/makara türleri için <strong>gizli</strong></li>
                    <li><code>status</code> &mdash; 5 seçenekli <code>Select</code> açılır listesi</li>
                </ul>
            </li>
            <li>Gönderimde: <code>PUT /api/materials/update/{id}</code> form değerleriyle</li>
            <li>Başarıda: <code>message.success('Güncellendi')</code> &rarr; modal kapanır &rarr; form sıfırlanır &rarr; <code>fetchMaterials()</code> tüm veriyi yeniden çeker</li>
            <li>Hatada: <code>message.error('Güncellenemedi')</code></li>
        </ol>

        <p><strong>Silme (Onaylı Kalıcı Silme):</strong></p>
        <ol>
            <li>Herhangi bir bireysel öğe satırındaki <code>DeleteOutlined</code> ikonuna (<code>color: '#ff4d4f'</code> stilinde) tıklayın</li>
            <li><code>Modal.confirm()</code> açılır: başlık &ldquo;Silme Onayı&rdquo;, içerik &ldquo;{QR_CODE} kodlu malzemeyi silmek istediğinize emin misiniz?&rdquo;, kırmızı &ldquo;Sil&rdquo; butonu ve &ldquo;İptal&rdquo; butonu</li>
            <li>Onayda: <code>DELETE /api/materials/{id}/hard-delete</code> &mdash; bu <strong>kalıcı, geri dönüşü olmayan</strong> bir silmedir. Malzeme kaydı ve tüm ilişkili <code>material_photos</code> kayıtları veritabanından kaldırılır</li>
            <li>Başarıda: <code>message.success('Silindi')</code> &rarr; <code>fetchMaterials()</code> yeniden çeker</li>
            <li>Hatada: <code>message.error('Silinemedi')</code></li>
        </ol>

        <p><strong>Oluşturma:</strong> Bu sayfada mevcut değil. Malzeme oluşturma yalnızca Hammadde modülündeki Hammadde Girişi sayfasından yapılır. Bu sayfa yalnızca okuma, güncelleme ve silme işlemleri sunar.</p>

        <h3>6.2.3 &mdash; Veri Kaynağı ve API</h3>
        <p>Hammadde Stok, tamamı Hammadde modülüne (<code>material_routes.py</code>) ait olan üç API endpoint&rsquo;i tüketir, Stok modülüne değil:</p>
        <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
            <thead>
                <tr style="background: var(--bg-secondary);">
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Metot</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Yol</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Ne Döndürür</th>
                </tr>
            </thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>GET</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>/api/materials/list</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Düz bir JSON dizisi olarak TÜM hammaddeler. Her nesne: <code>id</code>, <code>qr_code</code>, <code>material_type</code>, <code>material_name</code>, <code>supplier_name</code>, <code>lot_number</code>, <code>weight</code> (girişte orijinal ölçülen ağırlık), <code>remaining_weight</code> (üretim tüketiminden sonra mevcut ağırlık), <code>form_weight</code> (tedarikçinin beyan ettiği ağırlık), <code>quantity</code> (lot bazlı malzemeler için etiket sayısı), <code>received_date</code> (ISO tarihsaat), <code>status</code> (string: received/available/in_use/consumed/rejected) içerir</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>PUT</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>/api/materials/update/{id}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Tek bir malzeme kaydında <code>remaining_weight</code> ve/veya <code>status</code> günceller. Düzenleme modalından çağrılır.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>DELETE</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>/api/materials/{id}/hard-delete</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Malzemeyi ve ilişkili fotoğraflarını veritabanından kalıcı olarak kaldırır. Silme onay modalından çağrılır.</td></tr>
            </tbody>
        </table>
        <p>API yanıtı düz bir dizidir &mdash; sunucu tarafı gruplama, filtreleme veya sayfalama yoktur. Frontend türden bağımsız olarak her malzemeyi alır ve tüm gruplama mantığını istemci tarafında yönetir. Bu, ham malzeme envanterinin tamamının tek bir istekte yüklendiği anlamına gelir.</p>

        <h3>6.2.4 &mdash; State Yönetimi Mimarisi</h3>
        <p>Bileşen 5 adet state yönetir:</p>
        <ul>
            <li><strong><code>allMaterials</code></strong> (<code>RawMaterial[]</code>) &mdash; ham API yanıtı, olası yeniden işleme için saklanır</li>
            <li><strong><code>loading</code></strong> (<code>boolean</code>) &mdash; <code>fetchMaterials()</code> çağrısı sırasında true, &ldquo;Yenile&rdquo; buton spinner&rsquo;ını ve her panel içindeki yükleme göstergesini yönetir</li>
            <li><strong><code>sectionData</code></strong> (<code>Record&lt;string, SectionData&gt;</code>) &mdash; malzeme türüne göre anahtarlanmış çekirdek veri yapısı. Her giriş: <code>groups</code> (<code>MaterialGroupSummary</code> dizisi), <code>loading</code>, <code>expandedKeys</code> (hangi grup satırlarının genişletildiği), ve <code>totalItems</code> (bu kategorideki bireysel malzeme sayısı) tutar. Tüm 8 kategori anahtarı ve boş varsayılanlarla başlatılır.</li>
            <li><strong><code>activePanels</code></strong> (<code>string[]</code>) &mdash; hangi Collapse panellerinin açık olduğu. <code>Collapse</code>&rsquo;a <code>activeKey</code> aracılığıyla aktarılır.</li>
            <li><strong><code>editModalVisible</code></strong> + <strong><code>editingItem</code></strong> &mdash; düzenleme modalı görünürlüğünü ve hangi malzemenin düzenlendiğini kontrol eder</li>
        </ul>
        <p><code>SectionData</code> yapısı, veri yeniden çekmelerinde <code>expandedKeys</code>&rsquo;i korur. Kullanıcı bir malzemeyi düzenler veya silerse ve sayfa yeniden çekerse, <code>processAndGroupMaterials()</code> fonksiyonu önceki <code>expandedKeys</code>&rsquo;i <code>sectionData[cat.key]?.expandedKeys || []</code> aracılığıyla okur ve yeni state&rsquo;e taşır. Bu, açık grup satırlarının bir güncellemeden sonra açık kalması anlamına gelir &mdash; kullanıcı kaydırma konumunu veya genişletilmiş durumunu kaybetmez.</p>

        <h3>6.2.5 &mdash; 8 Malzeme Kategorisi Paneli</h3>
        <p>Sayfa, her malzeme kategorisi için bir tane olmak üzere 8 panelli bir Ant Design <code>Collapse</code> bileşeni renderlar. Kategoriler, her biri <code>key</code>, <code>label</code> (Türkçe ad), <code>icon</code> (Ant Design ikon bileşeni) ve <code>color</code> içeren sabit bir <code>MATERIAL_CATEGORIES</code> dizisinde tanımlanmıştır. Kategoriler Hammadde Girişi sayfasının kart renkleriyle birebir eşleşir:</p>

        <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
            <thead>
                <tr style="background: var(--bg-secondary);">
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Kategori</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Anahtar</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">İkon</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Renk</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Birim</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">QR Ön Eki</th>
                </tr>
            </thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Bakır</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_copper</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>MenuOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#cd7f32 (bronz)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">A</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Kalay</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_tin</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>GoldOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#c0c0c0 (gümüş)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">B</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Plastik</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_plastic</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>DockerOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#3498db (mavi)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">C</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Katalizör</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_catalyst</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>ExperimentOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#9b59b6 (mor)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">D</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Boya</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_dye</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>BgColorsOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#e74c3c (kırmızı)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">E</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Antirodent</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_antirodent</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>BugOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#27ae60 (yeşil)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">kg</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">F</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Palet</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_palette</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>BorderInnerOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#f39c12 (turuncu)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">adet</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">I</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Makara</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>raw_reel</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);"><code>PicCenterOutlined</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">#1abc9c (deniz mavisi)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">adet</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">H</td></tr>
            </tbody>
        </table>
        <p>Kategoriler ve görsel kimlikleri Hammadde Girişi ile paylaşılır &mdash; kullanıcı tutarlılık için her iki modülde de aynı renkleri ve ikonları görür.</p>

        <h3>6.2.6 &mdash; Panel Başlığı: Satır İçi İstatistik Panosu</h3>
        <p>Her panel başlığı sadece bir etiket değildir &mdash; daraltılmış haldeyken bile görünen bir mini panodur. Soldan sağa şunları gösterir: renk kodlu kategori ikonu, kategori adı, kayıt sayısı etiketi (örn. &ldquo;47 kayıt&rdquo;) ve sağa itilmiş üç toplam istatistik:</p>
        <ul>
            <li><strong>Toplam:</strong> kg bazlı malzemeler için <code>remaining_weight</code> toplamı (remaining null ise <code>weight</code>&rsquo;e döner), palet/makara için <code>weight</code> (sayı) toplamı. Türkçe yerel biçimlendirme (örn. &ldquo;12.456,3 kg&rdquo;).</li>
            <li><strong>Kullanımda:</strong> Mavi etiket. <code>status === 'in_use'</code> olan öğelerden toplam &mdash; şu an bir üretim makinesinde olan malzemeler.</li>
            <li><strong>Serbest:</strong> Yeşil etiket. <code>status === 'received'</code> veya <code>'available'</code> olan öğelerden toplam &mdash; Üretim&rsquo;in tüketmeye hazır malzemeler.</li>
        </ul>
        <p><code>getCategoryTotals()</code> fonksiyonu bunları tüm gruplar üzerinde iterasyon yaparak ve <code>total_quantity</code>, <code>reserved_quantity</code>, <code>available_quantity</code> toplayarak hesaplar. Birim palet/makara için &ldquo;adet&rdquo;, diğer her şey için &ldquo;kg&rdquo;dir.</p>

        <h3>6.2.7 &mdash; Üç Seviyeli Tablo Hiyerarşisi</h3>
        <p>Sayfa, kullanıcıların üst düzey kategori toplamlarından bireysel lot detaylarına inmesini sağlayan üç seviyeli bir detay görünümü uygular:</p>

        <p><strong>Seviye 1 &mdash; Kategori Paneli (Collapse):</strong> 8 Collapse panelinin kendileri. Her panel başlığı kategori adı + ikon + toplam istatistikleri gösterir. Bir paneli açmak Seviye 2 tablosunu açar. Birden fazla panel aynı anda açık olabilir &mdash; <code>activePanels</code> state&rsquo;i bir anahtar dizisidir.</p>

        <p><strong>Seviye 2 &mdash; Malzeme Adı Grup Tablosu:</strong> Her panel içinde malzemeler <code>material_name</code>&rsquo;e göre gruplanır. Örneğin, &ldquo;Plastik&rdquo; altında şu grupları görürsünüz: &ldquo;HFX 500P&rdquo;, &ldquo;HFFR 302&rdquo;, &ldquo;XLPE 2003&rdquo;, &ldquo;PVC 70&rdquo;. Her grup satırı gösterir: <strong>Malzeme Adı</strong> (kalın ad + lot sayısı, örn. &ldquo;HFX 500P (12 lot)&rdquo;), <strong>Toplam</strong> (toplam ağırlık/miktar), <strong>Kullanımda</strong> (mavi etiket, kullanımdaki toplam), <strong>Serbest</strong> (yeşil etiket, mevcut toplam). Bir malzemenin adı yoksa &ldquo;{Kategori} (İsimsiz)&rdquo; grubuna düşer.</p>

        <p><strong>Seviye 3 &mdash; Bireysel Lotlar (Genişletilmiş Satır):</strong> Bir grup satırını genişletmek bireysel malzeme girişlerini açar. Detay tablosu 7&ndash;8 sütun gösterir:</p>
        <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
            <thead>
                <tr style="background: var(--bg-secondary);">
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Sütun</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color);">Davranış</th>
                </tr>
            </thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">QR Kod</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Deterministik QR kodu gösteren mavi etiket (A1, B3, C12, vb.). Sola sabitlenmiş.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Ölçülen / Miktar</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Girişte orijinal ağırlık. Başlık uyarlanır: kg türleri için &ldquo;Ölçülen&rdquo;, palet/makara için &ldquo;Miktar&rdquo;.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Kalan</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Üretim tüketiminden sonra mevcut kalan ağırlık. Palet/makara için <strong>yok</strong>. <code>remaining_weight ?? weight</code> yedeği kullanır. <strong>Renk kodlu</strong> (bkz. 6.2.8).</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Durum</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Renk kodlu etiket: yeşil=Teslim Alındı (received), mavi=Mevcut (available), turuncu=Kullanımda (Üretim tarafından in_use), gri=Tükendi (consumed), kırmızı=Reddedildi (Lab tarafından rejected)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Tedarikçi</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Tedarikçi Yönetimi&rsquo;nden tedarikçi adı, yoksa &ldquo;-&rdquo;</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Lot No</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Hammadde Girişi&rsquo;nden lot/parti numarası, yoksa &ldquo;-&rdquo;</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Giriş Tarihi</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Giriş tarihi, UTC&rsquo;den Europe/Istanbul zaman dilimine dönüştürülmüş. GG.AA.YY formatında.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">İşlem</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color);">Düzenle ve Sil butonları. Sağa sabitlenmiş.</td></tr>
            </tbody>
        </table>

        <h3>6.2.8 &mdash; Koşullu Ağırlık Renklendirmesi</h3>
        <p>&ldquo;Kalan&rdquo; sütunu bu sayfadaki operasyonel açıdan en önemli görsel özelliklerden biridir. Malzeme tüketim seviyeleri hakkında anında görsel geri bildirim sağlamak için koşullu renklendirme kullanır. Mantık her satır için iki boolean bayrak hesaplar:</p>
        <ul>
            <li><code>isReduced = currentWeight &lt; originalWeight * 0.95</code> &mdash; malzeme kısmen tüketilmiş (%5&rsquo;ten fazlası kullanılmış)</li>
            <li><code>isLow = currentWeight &lt; originalWeight * 0.2</code> &mdash; malzeme kritik düşük (kalan %20&rsquo;den az)</li>
        </ul>
        <p>Renderlama kuralları:</p>
        <ul>
            <li><strong>Normal (renksiz, normal ağırlık):</strong> <code>remaining_weight &ge; %95</code> orijinal &mdash; malzeme neredeyse dokunulmamış veya yeni girilmiş</li>
            <li><strong style="color: #faad14;">Sarı (#faad14) + kalın (fontWeight: 600):</strong> <code>remaining_weight &lt; %95</code> ama &ge; %20 orijinal &mdash; kısmen tüketilmiş, dikkat çeker</li>
            <li><strong style="color: #ff4d4f;">Kırmızı (#ff4d4f) + kalın (fontWeight: 600):</strong> <code>remaining_weight &lt; %20</code> orijinal &mdash; kritik düşük, yeniden sipariş gerekebilir</li>
        </ul>
        <p>Somut örnek: 1.000 kg&rsquo;lık bir bakır filamaşin (QR: A1) 950 kg&rsquo;ın altına düşene kadar normal metin gösterir. 949 kg&rsquo;da sarıya döner. 199 kg&rsquo;da kırmızıya döner. <code>currentWeight</code>, <code>remaining_weight</code>&rsquo;i olmayan eski kayıtlarla geriye uyumluluk için <code>remaining_weight ?? weight ?? 0</code> olarak hesaplanır.</p>
        <p>Palet ve makara malzemeleri için bu sütun tablodan <strong>tamamen yoktur</strong> &mdash; gizlenmez, sütun dizisinden koşullu olarak çıkarılır: <code>...(!isPaletteOrReel ? [{ ... }] : [])</code>. Sayılan öğelerin kalan ağırlık kavramı yoktur &mdash; ya bütün birimler olarak mevcuttur ya da tüketilmiştir.</p>

        <h3>6.2.9 &mdash; Birim Uyarlaması: kg vs adet</h3>
        <p>Sayfa, bir malzemenin ağırlıkla mı yoksa ayrık parça olarak mı sayıldığına göre davranışını dinamik olarak uyarlar. Bu ayrım UI&rsquo;da <strong>beş farklı yeri</strong> etkiler:</p>
        <ol>
            <li><strong>Panel başlık istatistikleri:</strong> Toplam sayılardan sonra &ldquo;kg&rdquo; veya &ldquo;adet&rdquo; gösterir</li>
            <li><strong>Grup tablosu sütunları:</strong> Toplam, Kullanımda, Serbest değerlerinde birim soneki</li>
            <li><strong>Detay tablosu sütun başlığı:</strong> kg türleri için &ldquo;Ölçülen&rdquo;, adet türleri için &ldquo;Miktar&rdquo;</li>
            <li><strong>Detay tablosu &ldquo;Kalan&rdquo; sütunu:</strong> Palet/makara için tamamen gizli</li>
            <li><strong>Düzenleme modalı:</strong> &ldquo;Kalan Ağırlık (kg)&rdquo; alanı palet/makara türleri için gizli</li>
        </ol>
        <p>Belirleme <code>materialType === 'raw_palette' || materialType === 'raw_reel'</code> kontrolüyle yapılır. Bunlar yalnızca iki sayım bazlı kategoridir &mdash; diğer altısının tamamı kg kullanır. Gruplama mantığındaki miktar hesaplamaları için palet/makara malzemeleri <code>item.weight</code>&rsquo;ten (sayıyı depolar) okurken, kg bazlı malzemeler <code>item.remaining_weight ?? item.weight</code>&rsquo;ten okur.</p>

        <h3>6.2.10 &mdash; İstemci Tarafı Gruplama Mantığı</h3>
        <p><code>processAndGroupMaterials()</code> fonksiyonu çekirdek veri dönüşüm motorudur. Düz API yanıtını alır ve hiyerarşik <code>sectionData</code> yapısını üretir. Fonksiyon dört aşamada çalışır:</p>
        <ol>
            <li><strong>Kategori filtresi:</strong> 8 kategorinin her biri için <code>materials.filter(m =&gt; m.material_type === cat.key)</code> filtrele</li>
            <li><strong>Ad gruplama:</strong> Her kategori içinde <code>material_name</code>&rsquo;e göre anahtarlanmış bir <code>Record&lt;string, RawMaterial[]&gt;</code> oluştur. <code>material_name</code> null/boşsa anahtar &ldquo;{label} (İsimsiz)&rdquo; olur (örn. &ldquo;Bakır (İsimsiz)&rdquo;)</li>
            <li><strong>Grup toplamları:</strong> Her grup için bir <code>MaterialGroupSummary</code> nesnesi oluştur:
                <ul>
                    <li><code>total_quantity</code>: kg türleri için <code>remaining_weight ?? weight ?? 0</code> toplamı, veya adet türleri için <code>weight ?? 0</code> toplamı, durumdan bağımsız TÜM öğeler üzerinden</li>
                    <li><code>reserved_quantity</code>: <code>status === 'in_use'</code> olan öğelerden toplam</li>
                    <li><code>available_quantity</code>: <code>status === 'received' || status === 'available'</code> olan öğelerden toplam</li>
                    <li>Diğer durumlardaki öğeler (<code>consumed</code>, <code>rejected</code>) <code>total_quantity</code>&rsquo;de sayılır ama reserved veya available&rsquo;da sayılmaz &mdash; tüketilmiş veya atılmış stoğu temsil eder</li>
                </ul>
            </li>
            <li><strong>State koruma:</strong> Mevcut <code>sectionData</code>&rsquo;dan önceki <code>expandedKeys</code>&rsquo;i taşı, böylece açık grup satırları veri yenilemesinden sonra açık kalır</li>
        </ol>

        <h3>6.2.11 &mdash; Düzenleme Modalı</h3>
        <p>Düzenleme modalı kasıtlı olarak minimaldir &mdash; Hammaddeler Listesi&rsquo;nin üç varyantının (bakır/kalay, lot bazlı, palet/makara) aksine tek varyantlıdır. Yalnızca iki alan sunar:</p>
        <ul>
            <li><strong>Kalan Ağırlık:</strong> Malzemenin mevcut <code>remaining_weight</code> değeriyle önceden doldurulmuş sayısal giriş. Bu, Üretim malzeme tükettiğinde etkilenen alandır ve bu modal bir stok yöneticisinin sistem değeri fiziksel gerçeklikten saptığında manuel olarak düzeltmesine izin verir. Palet/makara için <strong>gizli</strong>dir çünkü bunlar bütün birimlerdir.</li>
            <li><strong>Durum:</strong> 5 seçenekli açılır liste: Teslim Alındı (received), Mevcut (available), Kullanımda (in_use), Tükendi (consumed), Reddedildi (rejected). Bu bir yöneticinin yaşam döngüsü durumunu manuel olarak geçersiz kılmasına izin verir &mdash; örn. hasarlı bir malzemeyi reddedildi olarak işaretleme veya Üretim&rsquo;in güncellemeyi başaramadığı bir durumu düzeltme.</li>
        </ul>
        <p>Hammaddeler Listesi&rsquo;nin aksine, bu modal QR kodlarını, lot numaralarını, tedarikçi adlarını veya fotoğrafları düzenlemeye izin <strong>vermez</strong>. Bunlar Hammadde modülünün tam düzenleme akışına aittir. Bu modal yalnızca stok düzeyinde düzeltmeler içindir: &ldquo;gerçekte ne kadar kaldı?&rdquo; ve &ldquo;gerçek durumu ne?&rdquo;</p>

        <h3>6.2.12 &mdash; Yükleme ve Boş Durumlar</h3>
        <p>Sayfa iki boş veri senaryosunu yönetir:</p>
        <ul>
            <li><strong>Yükleme durumu:</strong> Veri çekilirken her panel &ldquo;Yükleniyor...&rdquo; ile bir spinner gösterir. Sayfa başlığındaki &ldquo;Yenile&rdquo; butonu da yükleme durumu gösterir.</li>
            <li><strong>Boş kategori:</strong> Bir kategoride malzeme yoksa (örn. stokta şu an antirodent yok) panel &ldquo;Bu kategoride stok bulunamadı&rdquo; mesajını gösterir.</li>
        </ul>

        <h3>6.2.13 &mdash; Zaman Dilimi İşleme</h3>
        <p>API&rsquo;deki tüm tarihler veritabanında UTC olarak depolanır. Frontend bunları <code>dayjs</code>&rsquo;in <code>utc</code> ve <code>timezone</code> eklentileriyle Türkiye zaman dilimine dönüştürür:</p>
        <ul>
            <li>Zaman dilimi sabiti modül seviyesinde tanımlanır: <code>const TURKEY_TZ = 'Europe/Istanbul'</code></li>
            <li>Tarih renderlama: <code>dayjs.utc(date).tz(TURKEY_TZ).format('DD.MM.YY')</code></li>
            <li>Bu, 15 Ocak UTC 23:30&rsquo;da girilen bir malzemenin Türkçe gösterimde 16 Ocak olarak gösterilmesini sağlar (UTC+3), giriş tarihinin yerel tarihini doğru yansıtır</li>
        </ul>

        <h3>6.2.14 &mdash; Diğer Modüllerle Bağlantı</h3>
        <p>Hammadde Stok izole bir şekilde var olmaz &mdash; esasen diğer modüller tarafından oluşturulan, değiştirilen ve tüketilen verilere <strong>salt okunur bir pencere</strong>dir. Bu bağlantıları anlamak bu sayfayı anlamanın anahtarıdır:</p>

        <p><strong>Yukarı Akış: Envanteri kim doldurur?</strong></p>
        <ul>
            <li><strong>Hammadde Girişi</strong> &mdash; tek oluşturucu. Bu sayfada görünen her satır Hammadde Girişi&rsquo;ndeki dört giriş arketipinden biri aracılığıyla oluşturulmuştur. Bakır filamaşin geldiğinde operatör tartar, fotoğraf çeker, QR kodu A{n} atar ve <code>materials</code> tablosuna <code>status = 'received'</code> ve <code>remaining_weight = weight</code> ile girer. O kayıt anında burada &ldquo;Bakır&rdquo; paneli altında görünür hale gelir. Hammadde Stok oluşturamaz, yalnızca görüntüleyebilir.</li>
            <li><strong>Hammadde Sipariş</strong> &mdash; malzemelerin gelmesinin asıl sebebi. Bir satın alma siparişi karşılanıp malzemeler teslim edildiğinde, giriş operatörü malzemeyi sipariş grup koduna (R1, R2, vb.) bağlayabilir. Bu izlenebilirlik veride mevcuttur ama bu sayfada <strong>gösterilmez</strong> &mdash; onun yerine Hammaddeler Listesi&rsquo;nin &ldquo;Sipariş No&rdquo; sütununda görünür.</li>
            <li><strong>Tedarikçi Yönetimi</strong> &mdash; detay satırlarında görünen tedarikçi adlarını tanımlar. Tedarikçi ilişkilendirmesi giriş anında yapılır ve burada salt okunurdur.</li>
        </ul>

        <p><strong>Aşağı Akış: Envanteri kim tüketir?</strong></p>
        <ul>
            <li><strong>Üretim / Production (özellikle Kabatel Çekme)</strong> &mdash; birincil tüketici. Üretim bir iş kartı başlattığında QR koduna göre hammadde seçer. Tel çekme (Kabatel Çekme) için operatör bir bakır filamaşin (örn. A7) alır ve makineye besler. Üretim ardından malzeme kaydını günceller: <code>status</code>, <code>received</code>/<code>available</code>&rsquo;dan <code>in_use</code>&rsquo;a değişir ve malzeme tüketildikçe <code>remaining_weight</code> azalır. Filamaşin tamamen kullanıldığında <code>status</code>, <code>consumed</code> olur. &ldquo;Kalan&rdquo; sütununun sarı/kırmızı renklendirmesiyle var olmasının tüm sebebi budur &mdash; Üretim&rsquo;in ne kadar tükettiğini görselleştirir. Benzer şekilde plastik granüller, kalay, katalizörler ve boyalar kendi üretim adımları (ekstrüzyon, kalaylama, vb.) tarafından tüketilir.</li>
            <li><strong>Laboratuvar (dolaylı)</strong> &mdash; Lab testleri bir malzemenin <code>rejected</code> (reddedildi) durumuna düşmesine neden olabilir, bu da durumunu değiştirir ve bu sayfadaki &ldquo;Serbest&rdquo; sayısından etkin bir şekilde çıkarır.</li>
        </ul>

        <p><strong>Aynı veri üzerindeki kardeş görünümler:</strong></p>
        <ul>
            <li><strong>Hammaddeler Listesi (Hammadde modülünde)</strong> &mdash; tam olarak aynı <code>/api/materials/list</code> endpoint&rsquo;inden okur. Tam güçlü yönetici görünümüdür: 14 sütun, tembel yüklenen fotoğraflar, WebSocket gerçek zamanlı senkronizasyon, iki dilli arama, üç düzenleme form varyantı, QR etiket yazdırma, 12 granüler yetki. O sayfa <em>kayıt düzeyinde</em> görünümdür; Hammadde Stok <em>stok düzeyinde</em> görünümdür. Birlikte aynı veri üzerinde farklı kullanıcı ihtiyaçlarını karşılarlar.</li>
            <li><strong>Projeksiyon (Stok modülünde)</strong> &mdash; malzeme verisini kullanır ama tamamen farklı bir amaç için. Projeksiyon mevcut envanter + gelen siparişler &minus; üretim gereksinimleri birleştirerek stoğun gelecek haftalarda <em>ne olacağını</em> hesaplar. Hammadde Stok stoğun <em>şu an ne olduğunu</em> gösterir. Tamamlayıcıdırlar: biri canlı anlık görüntü, diğeri haftalık tahmin.</li>
        </ul>

        <h3>6.2.15 &mdash; Yetki Modeli</h3>
        <p>Sayfa, sayfa düzeyinde erişim için <code>access.ts</code>&rsquo;den <code>canStok</code> route guard&rsquo;ını kullanır. <code>permissionManifest.ts</code>&rsquo;deki yetki manifestosu bu sayfa için 5 buton tanımlar:</p>
        <ul>
            <li><code>access_page</code> &mdash; Hammadde Stok sayfasına erişebilir</li>
            <li><code>view_table</code> &mdash; kategori tablolarını görebilir</li>
            <li><code>view_details</code> &mdash; bireysel lotları görmek için grupları genişletebilir</li>
            <li><code>edit_stock</code> &mdash; düzenleme modalını açabilir</li>
            <li><code>adjust_quantity</code> &mdash; kalan ağırlık değerlerini değiştirebilir</li>
        </ul>
        <p>Ancak, buton düzeyinde izinleri uygulayan Hammaddeler Listesi&rsquo;nin aksine (örn. <code>print_qr</code> izni olmadan yazdır butonunu devre dışı bırakma), bu sayfa frontend&rsquo;de buton düzeyinde kontroller <strong>uygulamaz</strong>. Düzenle ve sil butonları sayfa erişimi olan her kullanıcıya her zaman renderlanır. Yetki uygulaması yalnızca API seviyesinde gerçekleşir.</p>

        <h3>6.2.16 &mdash; Bu Alt Modülün Yapmadıkları</h3>
        <ul>
            <li>Kendi backend route&rsquo;ları <strong>yoktur</strong> &mdash; Hammadde modülünün <code>material_routes.py</code> endpoint&rsquo;lerini tüketir</li>
            <li>Malzeme oluşturmayı <strong>desteklemez</strong> &mdash; o yalnızca Hammadde Girişi&rsquo;nde yapılır</li>
            <li>Gerçek zamanlı güncellemeler için WebSocket <strong>kullanmaz</strong> &mdash; veri mount&rsquo;ta bir kez çekilir ve düzenleme/silme işlemlerinden sonra manuel olarak yenilenir. <code>materials</code> ve <code>all</code> WebSocket odalarına abone olan Hammaddeler Listesi ile karşılaştırın</li>
            <li>Sunucu tarafı filtreleme veya sayfalama <strong>yoktur</strong> &mdash; 8 yönlü kategori filtreleme, ad bazlı gruplama ve miktar toplamlamasının tamamı istemci tarafındadır</li>
            <li>Malzeme fotoğraflarını <strong>göstermez</strong> &mdash; ne teslimat ne de test fotoğrafları görüntülenir. Bunlar yalnızca Hammaddeler Listesi&rsquo;nde görünür</li>
            <li>Sipariş bağlantısını <strong>göstermez</strong> &mdash; &ldquo;Sipariş No&rdquo; (sipariş grup kodu) sütunu Hammaddeler Listesi&rsquo;nde var ama burada yok</li>
            <li>Yazdırmayı <strong>desteklemez</strong> &mdash; QR etiket yeniden yazdırma işlevi yok. O Hammaddeler Listesi&rsquo;nde</li>
            <li>İstemci tarafı arama çubuğu <strong>yoktur</strong> &mdash; gezinme kategori panellerini ve grup satırlarını genişleterek yapılır</li>
            <li>Tüketim geçmişini <strong>izlemez</strong> &mdash; yalnızca mevcut anlık görüntüyü gösterir, ağırlık değişikliklerinin zaman çizelgesini değil</li>
            <li>Yumuşak silme <strong>yoktur</strong> &mdash; silme işlemi <code>/hard-delete</code> kullanır, kaydı kalıcı olarak kaldırır</li>
        </ul>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>Hammadde Stok vs Hammaddeler Listesi &mdash; aynı veri, farklı amaç:</strong> Her iki sayfa da aynı <code>/api/materials/list</code> endpoint&rsquo;inden okur ve aynı <code>materials</code> tablosu verisini görüntüler. Fark bakış açısındadır. Hammaddeler Listesi (Hammadde modülünde) tam güçlü yönetici görünümüdür: 14 sütun, tembel fotoğraflar, WebSocket, iki dilli arama, üç düzenleme form varyantı, yazdırma, 12 granüler yetki. Hammadde Stok (Stok modülünde) <strong>stok yöneticisinin görünümü</strong>dür: kategoriye ve malzeme adına göre gruplanmış, toplam değerler ön planda, &ldquo;bu lotun tam geçmişi ne?&rdquo; yerine &ldquo;ne kadarımız var?&rdquo; sorusunu yanıtlamak için optimize edilmiş. Buradaki düzenleme modalı kasıtlı olarak minimaldir (yalnızca ağırlık + durum) çünkü tam düzenleme Hammadde modülüne aittir.</p>
        </div>

        <!-- ====== 6.3 ÜRÜN STOK ====== -->
        <h2 id="sec-6-3">6.3 &mdash; Ürün Stok (Ürün Stoğu)</h2>
        <p class="subtitle">Üretim adımına göre düzenlenmiş yarı mamul ve mamul ürünlerin canlı envanteri &mdash; fabrika üretim hattının çıktı tarafı.</p>

        <h3 id="urun-stok-purpose">6.3.1 &mdash; Amaç ve İş Bağlamı</h3>
        <p>Ürün Stok şu soruyu yanıtlar: <strong>"Fabrika ne üretti ve şu an nerede?"</strong></p>
        <p>Hammadde Stok tüketilmeyi bekleyen ham <em>girdileri</em> takip ederken, Ürün Stok <em>çıktıları</em> takip eder: bir üretim makinesinden çıkan her sepet ve makara. Bu sayfadaki her kayıt fiziksel olarak bir <strong>Üretim Oturumu</strong> sırasında oluşturulmuştur &mdash; bir operatör makineyi çalıştırmış, çıktı sepetlerini kaydetmiş, QR etiketleri basmış ve bu sepetler buraya düşmüştür. Sayfanın var olma nedenleri:</p>
        <ul>
            <li><strong>Üretim Listesi</strong> bu kayıtları oluşturur &mdash; bir üretim oturumu çıktı sepetlerini kaydettiğinde, her sepet aynı anda hem <code>production_outputs</code> hem de <code>half_product_stock</code> tablolarına yazılır. Bu sayfa, biriken envanterin <strong>salt okunur penceresi</strong>dir.</li>
            <li><strong>Üretim Geçmişi</strong> aynı kayıtları oturum merkezli bir perspektiften gösterir (hangi oturum ne üretti). Ürün Stok ise bunları <strong>stok merkezli</strong> bir perspektiften gösterir (hangi oturum ürettiğinden bağımsız olarak, her ürün kodundan şu an ne kadar mevcut).</li>
            <li><strong>Sipariş Modülü</strong> <strong>tahsisi</strong> belirler &mdash; bir sipariş için iş kartı açıldığında, siparişin gerektirdiği miktarın altında üretilen sepetler <code>ORDER</code> olarak işaretlenir. Fazla üretim <code>STOCK</code> (serbest envanter) olur. Bu tahsis ayrımı, her grup satırında görünen temel bir iş kavramıdır.</li>
            <li><strong>Laboratuvar Modülü</strong> (Test Yönetimi) kalite testlerini belirli üretim çıktılarına bağlar. Ürün Stok, stok yöneticilerinin bağlı test sonuçlarını doğrudan her kayıttan görüntülemesine olanak tanır &mdash; satırdaki test ikonu, Lab sisteminden alınan test aralığı, adı, standart numarası ve geçti/kaldı durumunu gösteren bir modal açar.</li>
            <li><strong>Kaynak QR İzlenebilirlik</strong> &mdash; her kayıt, üretiminde tüketilen girdi QR kodlarının JSON dizisini <code>source_qr_codes</code> alanında saklar. Bu zincir (A1 bakır &rarr; X1 kabatel &rarr; Y1 kalaylama &rarr; ...) fabrikanın izlenebilirlik omurgasıdır.</li>
        </ul>

        <h3 id="urun-stok-crud">6.3.2 &mdash; CRUD Akışı</h3>
        <p><strong>Oluşturma (Create):</strong> Bu sayfa kayıt <strong>oluşturmaz</strong>. Yarı mamul stok kayıtları yalnızca <strong>Üretim modülü</strong> tarafından aktif üretim oturumları sırasında oluşturulur. Bir operatör sepet çıktısı kaydettiğinde, backend aynı anda hem <code>production_outputs</code> hem de <code>half_product_stock</code> tablolarına yazar. Bu sayfada "Ekle" butonu yoktur.</p>
        <p><strong>Okuma (Read):</strong> Sayfa yüklendiğinde bileşen <strong>7 paralel API isteği</strong> atar &mdash; her üretim adımı için bir tane (Kabatel, Kalaylama, İncetel, Buncher, Extruder, E-Beam, Aktarma). Her istek <code>GET /api/stock/half-products/by-step/{step}?status_filter=available</code> endpoint'ine gider. Backend, <code>half_product_stock</code> tablosunu <code>production_step</code> ve <code>status</code>'a göre filtreler, operatör adını almak için <code>production_sessions</code> ile birleştirir ve en yeniden eskiye sıralı sonuçlar döner. Frontend daha sonra <code>product_code</code>'a göre gruplar, grup başına toplamları hesaplar ve Collapse panel hiyerarşisini oluşturur.</p>
        <p><strong>Güncelleme (Update):</strong> Kayıt başına modal ile düzenleme. Düzenle ikonuna tıklamak üç alanlı bir form açar: <code>remaining_weight_kg</code> (zorunlu, min=0, adım=0.1 InputNumber), <code>allocation</code> (Select: ORDER veya STOCK), ve <code>notes</code> (TextArea). <code>PUT /api/stock/half-products/{id}</code> ile gönderilir. Backend yalnızca <code>remaining_weight_kg</code>, <code>status</code> ve <code>notes</code> alanlarını güncellemeye izin verir (not: allocation frontend'den gönderilir ama backend'in <code>allowed_fields</code> listesinde yoktur &mdash; potansiyel tutarsızlık). Başarı sonrası tam veri yenileme.</p>
        <p><strong>Silme (Delete):</strong> QR kodu görüntülenen onay modalı. <code>DELETE /api/stock/half-products/{id}</code> çağırır. Backend <strong>kademeli silme</strong> gerçekleştirir: (1) <code>production_output_id</code> veya yedek <code>output_code</code> eşleşmesi ile bağlı <code>ProductionOutput</code> kaydını bulur ve siler, (2) silinen kaydın QR numarasının prefix dizisindeki en yüksek numara olup olmadığını kontrol eder (örn. X150 en yüksek X-prefix ise) &mdash; öyleyse yeniden kullanıma izin vermek için <code>HalfProductSequence.last_number</code>'ı azaltır, (3) stok kaydını siler. Bu kademe, stoktan silmenin yetim üretim çıktı kayıtları veya bozuk QR dizileri bırakmamasını sağlar.</p>

        <h3 id="urun-stok-api">6.3.3 &mdash; Veri Kaynağı ve API Mimarisi</h3>
        <p>Hammadde modülünden tek bir endpoint ödünç alan Hammadde Stok'un aksine, Ürün Stok'un <code>api/stock/half_product_routes.py</code> dosyasında 6 endpoint'li <strong>kendi özel backend'i</strong> vardır:</p>
        <div style="overflow-x:auto">
        <table style="width:100%; border-collapse: collapse; margin: 12px 0">
            <thead><tr style="background: var(--bg-secondary)">
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Endpoint</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Metod</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Amaç</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Frontend kullanıyor mu?</th>
            </tr></thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/by-step/{step}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">GET</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Birincil veri: bir adımdaki tüm kayıtlar, operatör adı ile. <code>ProductionSession</code> birleştirmesi.</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Evet (yüklemede 7 paralel çağrı)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/{id}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">PUT</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Ağırlık, durum, notları güncelle</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Evet (düzenleme modalı)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/{id}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">DELETE</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Kademeli silme: stok + üretim çıktısı + dizi sıfırlama</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Evet (silme onayı)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">GET</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Sayfalı genel listeleme, opsiyonel adım/durum filtresi</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Hayır (diğer tüketiciler için mevcut)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/summary</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">GET</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Adım başına sayı ve ağırlıklar (mevcut/toplam)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Hayır</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>/api/stock/half-products/{qr_code}</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">GET</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">QR koda göre arama</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Hayır</td></tr>
            </tbody>
        </table>
        </div>
        <p>Ayrıca <strong>bağlı testler</strong> özelliği, Üretim modülünün <code>test_integration_routes.py</code> dosyasından <code>GET /api/production/test-requests/bonded-tests/output/{output_id}</code> endpoint'ini çağırır. Bu çapraz modül çağrısı, belirli bir üretim çıktısına bağlı Lab testlerini test aralığına göre gruplandırarak (<code>üretim_başı</code>, <code>her_sepet_sonu</code>, <code>üretim_sonu</code>) getirir.</p>

        <h3 id="urun-stok-db">6.3.4 &mdash; Veritabanı Şeması: <code>half_product_stock</code> Tablosu</h3>
        <p>Bu alt modülün <strong>özel</strong> tablosudur &mdash; Hammadde modülünün <code>materials</code> tablosundan okuyan Hammadde Stok'un aksine, Ürün Stok'un <code>models/half_product_stock.py</code> tarafından yönetilen kendi tablosu vardır.</p>
        <div style="overflow-x:auto">
        <table style="width:100%; border-collapse: collapse; margin: 12px 0">
            <thead><tr style="background: var(--bg-secondary)">
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Sütun</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Tip</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">İş Anlamı</th>
            </tr></thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>qr_code</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(50), benzersiz</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Deterministik QR: X=Kabatel, Y=Kalaylama, Z=İncetel, T=Buncher, U=Extruder, G=E-Beam. Prefix başına global sıralı.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>product_code</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(100)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Teknik ürün tanımlayıcı (örn. KC_18, KL_18). Frontend'de gruplama anahtarı.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>production_step</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(50)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Hangi makine adımı üretti: <code>kabatel_cekme</code>, <code>kalaylama</code>, <code>incetel</code>, <code>buncher</code>, <code>extruder</code>, <code>ebeam</code>, <code>aktarma</code>.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>initial_weight_kg</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Float</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Sepetin makineden çıktığı andaki ağırlık. Asla değişmez.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>remaining_weight_kg</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Float</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Alt akış tüketimi sonrası güncel ağırlık. Sonraki üretim adımı bu sepeti tükettiğinde azalır.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>basket_number</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Integer</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Üretim oturumu içindeki sıralı sepet numarası.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>allocation</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(20)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>ORDER</code> = müşteri siparişini karşılamak için üretildi. <code>STOCK</code> = fazla üretim, serbest envanter.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>order_id</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">FK &rarr; orders.id</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Bu sepetin tahsis edildiği müşteri siparişi (STOCK ise null).</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>status</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">String(50)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>available</code> &rarr; <code>in_use</code> &rarr; <code>consumed</code>. Ayrıca <code>reserved</code>, <code>shipped</code>, <code>defective</code>.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>production_output_id</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">FK &rarr; production_outputs.id</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Üretim çıktı kaydına bağlantı. Bağlı test sorgusu ve kademeli silme için kullanılır.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>session_id</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">FK &rarr; production_sessions.id</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Bu sepeti hangi üretim oturumu oluşturdu. Operatör adını çekmek için kullanılır.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>work_card_id</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">FK &rarr; work_cards.id</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Bu üretimi yönlendiren iş kartı (Sipariş modülünden).</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>source_qr_codes</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Text (JSON)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Bu ürünü üretmek için tüketilen girdi QR kodlarının JSON dizisi. Örn. Kabatel sepeti için <code>["A1","A3"]</code> bakır lotları. İzlenebilirlik zinciri.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>produced_at</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">DateTime</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Sepetin üretildiği zaman. UTC olarak saklanır, Europe/Istanbul olarak gösterilir.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>consumed_at</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">DateTime, nullable</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Bu sepetin sonraki üretim adımı tarafından tamamen tüketildiği zaman.</td></tr>
            </tbody>
        </table>
        </div>
        <p>ORM'deki temel ilişkiler: <code>order</code> (Order), <code>production_output</code> (ProductionOutput), <code>session</code> (ProductionSession), <code>work_card</code> (WorkCardDB). <code>(production_step, status)</code> ve <code>(product_code, status)</code> üzerindeki bileşik indeksler birincil sorgu kalıbını optimize eder.</p>
        <p>Eşlik eden <code>HalfProductSequence</code> modeli (<code>half_product_sequences</code> tablosu) her prefix için kullanılan son numarayı takip eder: <code>{'X': 150}</code>, X150'nin son Kabatel çıktısı olduğu anlamına gelir. Prefix-makine eşlemesi: <code>kabatel_cekme &rarr; X</code>, <code>kalaylama &rarr; Y</code>, <code>incetel &rarr; Z</code>, <code>buncher &rarr; T</code>, <code>extruder &rarr; U</code>, <code>ebeam &rarr; G</code>.</p>

        <h3 id="urun-stok-state">6.3.5 &mdash; Durum Yönetimi Mimarisi</h3>
        <p>Bileşen 8 durum değişkeni kullanır:</p>
        <ul>
            <li><code>loading</code> (boolean) &mdash; 7 adımın paralel getirimi sırasındaki global yükleme bayrağı</li>
            <li><code>sectionData</code> (Record&lt;string, SectionData&gt;) &mdash; ana veri deposu. 7 üretim adımı anahtarıyla başlatılır, her biri şunları içerir: <code>groups</code> (ProductGroupSummary[]), <code>loading</code>, <code>expandedKeys</code>, <code>totalItems</code> ve <code>grandTotals</code> (toplam/sipariş/serbest). Sayfanın kalbi budur.</li>
            <li><code>activePanels</code> (string[]) &mdash; şu an açık olan Collapse panelleri</li>
            <li><code>editModalVisible</code> + <code>editingItem</code> &mdash; düzenleme modalı durumu</li>
            <li><code>testsModalVisible</code> + <code>testsLoading</code> + <code>selectedTests</code> + <code>selectedOutputCode</code> &mdash; bağlı testler modalı durumu</li>
        </ul>
        <p>Veri akışı: <code>fetchAllData()</code>, <code>Promise.all()</code> ile 7 paralel <code>request()</code> çağrısı atar. Her yanıt client tarafında <code>product_code</code>'a göre gruplandırılır, grup başına tahsis ayrımı (ORDER kg vs STOCK kg) ve adım başına genel toplamlar hesaplanır. Gruplandırılmış sonuçlar tüm <code>sectionData</code> durumunu değiştirir, önceki durumdan <code>expandedKeys</code>'i koruyarak satır açılımlarının yenileme sırasında kaybolmamasını sağlar.</p>

        <h3 id="urun-stok-panels">6.3.6 &mdash; 7 Üretim Adımı Paneli</h3>
        <p>Sayfa, her üretim adımı için bir panel olmak üzere 7 panelli bir Ant Design <code>Collapse</code> bileşeni kullanır. Hammadde Stok'un 8 malzeme kategorisinin (statik isimler: "Bakır", "PVC") aksine, bu paneller <strong>kablo üretim hattını</strong> takip eder:</p>
        <div style="overflow-x:auto">
        <table style="width:100%; border-collapse: collapse; margin: 12px 0">
            <thead><tr style="background: var(--bg-secondary)">
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Anahtar</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Etiket</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">QR Prefix</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Ne üretir</th>
            </tr></thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>kabatel_cekme</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Kabatel</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">X (X1, X2...)</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Ham bakırdan çekilen 1.8mm tel</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>kalaylama</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Kalaylama</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Y</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Kalaylanmış tel</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>incetel</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">İncetel</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Z</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">İnce tel (daha küçük çap)</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>buncher</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Buncher</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">T</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Demet halinde tel telleri</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>extruder</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Extruder</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">U</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Yalıtılmış kablo</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>ebeam</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">E-Beam</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">G</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Elektron ışını ile çapraz bağlanmış kablo</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>aktarma</code></td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Aktarma</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">AK</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Malzeme aktarma / yeniden sarım</td></tr>
            </tbody>
        </table>
        </div>
        <p>Her panelin kendine özgü ikonu ve rengi vardır. İkon seti Ant Design ikonları kullanır: ScissorOutlined (Kabatel), FireOutlined (Kalaylama), CompressOutlined (İncetel), ApartmentOutlined (Buncher), BuildOutlined (Extruder), ThunderboltOutlined (E-Beam), SwapOutlined (Aktarma).</p>

        <h3 id="urun-stok-header-stats">6.3.7 &mdash; Panel Başlığı: Üç Sütunlu İstatistik</h3>
        <p>Her panel başlığı, <strong>tahsis ayrımını</strong> gösteren sağa hizalı üç istatistik sütunu görüntüler:</p>
        <ul>
            <li><strong>Toplam</strong> &mdash; bu üretim adımındaki tüm mevcut kayıtların toplam kg'ı</li>
            <li><strong>Sipariş</strong> &mdash; müşteri siparişlerine tahsis edilmiş toplam kg (yeşil etiket)</li>
            <li><strong>Serbest</strong> &mdash; fazla üretim / serbest stok toplam kg'ı (turuncu etiket)</li>
        </ul>
        <p>Kayıt sayısı da adım etiketinin yanında bir tag olarak gösterilir. Bir adımda veri olmadığında, istatistik sütunları düşük opaklıkta görünür kalarak tüm panellerde düzen tutarlılığını korur.</p>

        <h3 id="urun-stok-hierarchy">6.3.8 &mdash; İki Seviyeli Tablo Hiyerarşisi</h3>
        <p>Her panel içinde veriler <strong>iki seviyeli bir hiyerarşide</strong> görüntülenir (Hammadde Stok'un üç seviyesine kıyasla):</p>
        <p><strong>Seviye 1 &mdash; Grup Satırı (product_code'a göre):</strong> Her satır, bu üretim adımındaki belirli bir ürün kodunun tüm sepetlerini temsil eder. Gösterir:</p>
        <ul>
            <li><strong>Ürün Kodu</strong> kayıt sayısı ile</li>
            <li><strong>Toplam</strong> (Toplam kg) &mdash; tüm kalan ağırlıkların toplamı</li>
            <li><strong>Sipariş</strong> (Sipariş kg) &mdash; ORDER tahsisli kayıtların toplamı (yeşil etiket)</li>
            <li><strong>Serbest</strong> (Serbest kg) &mdash; STOCK tahsisli kayıtların toplamı (turuncu etiket)</li>
        </ul>
        <p>Genişletme ikonuna tıklamak açılır...</p>
        <p><strong>Seviye 2 &mdash; Bireysel Kayıtlar:</strong> Her satır, tam detayıyla tek bir sepet/makaradır. Sütunlar:</p>
        <div style="overflow-x:auto">
        <table style="width:100%; border-collapse: collapse; margin: 12px 0">
            <thead><tr style="background: var(--bg-secondary)">
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Sütun</th>
                <th style="padding: 8px; text-align: left; border-bottom: 2px solid var(--border-color)">Açıklama</th>
            </tr></thead>
            <tbody>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">QR Kod</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Deterministik QR kodu (örn. X5, Y12). Mavi etiket. Sabit sol sütun.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Ağırlık</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Güncel kalan ağırlık kg cinsinden (Türkçe yerel formatlaması).</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Tahsis</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">ORDER (yeşil) veya Stok (turuncu) etiketi.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Durum</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Mevcut (available/yeşil), Tüketildi (consumed/varsayılan), Rezerve (reserved/mavi), Hatalı (defective/kırmızı).</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">İş Kartı</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">İş kartı ID'si mavi etiket olarak, bu sepeti kaynak sipariş görevine bağlar.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Üretim Tarihi</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Üretim tarih/saati. UTC &rarr; Europe/Istanbul dönüşümü dayjs eklentileriyle.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Kaynak</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Girdi QR kodları (JSON'dan ayrıştırılır). İlk 2 kodu gösterir + daha fazlası varsa "...". Üst akış malzemelerine izlenebilirlik bağlantısı.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Test</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)"><code>production_output_id</code> varsa deney ikonu butonu. Bağlı testler modalını açar.</td></tr>
                <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">İşlem</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-color)">Düzenle ve Sil butonları. Sabit sağ sütun.</td></tr>
            </tbody>
        </table>
        </div>

        <h3 id="urun-stok-allocation">6.3.9 &mdash; Tahsis Sistemi: ORDER vs STOCK</h3>
        <p>Ürün Stok'un görüntülediği ancak <strong>kontrol etmediği</strong> temel bir kavramdır. Tahsis, stok görüntüleme zamanında değil <strong>üretim zamanında</strong> belirlenir:</p>
        <ul>
            <li>Bir üretim oturumu iş kartına karşı çalıştığında, backend <strong>kümülatif üretimi</strong> siparişin gerektirdiği miktarla karşılaştırarak takip eder.</li>
            <li>Kümülatif çıktı gerekli miktarın <strong>altında</strong>yken üretilen her sepet <code>ORDER</code> olarak işaretlenir ve <code>order_id</code>'ye bağlanır.</li>
            <li>Kümülatif çıktı gerekli miktarı <strong>aştığında</strong>, sonraki sepetler null <code>order_id</code> ile <code>STOCK</code> olarak işaretlenir.</li>
        </ul>
        <p>Ürün Stok bu tahsis ayrımını her seviyede görüntüler: kayıt başına (etiket), grup başına (iki ayrı kg sütunu) ve adım başına (panel başlık istatistikleri). Bu, stok yöneticilerine envanterin ne kadarının siparişlere tahsis edildiğini ve ne kadarının yeni siparişler veya genel kullanım için serbest olduğunu anında gösterir.</p>

        <h3 id="urun-stok-bonded-tests">6.3.10 &mdash; Bağlı Testler Modalı: Lab Bağlantısı</h3>
        <p><code>production_output_id</code>'si olan kayıtlar (normal üretim akışıyla oluşturulan neredeyse tüm kayıtlar) satırlarında bir deney ikonu gösterir. Tıklamak <code>/api/production/test-requests/bonded-tests/output/{output_id}</code> endpoint'ini çağıran ve belirli üretim çıktısına bağlı tüm kalite testlerini görüntüleyen bir modal açar.</p>
        <p>Yanıt testleri aralığa göre gruplandırır:</p>
        <ul>
            <li><strong>Üretim Başı</strong> &mdash; oturum başında yapılan testler</li>
            <li><strong>Her Sepet Sonu</strong> &mdash; sepet başına testler, en ayrıntılı seviye</li>
            <li><strong>Üretim Sonu</strong> &mdash; oturum sonu doğrulama testleri</li>
        </ul>
        <p>Her test satırı gösterir: test ID'si (mor etiket), test adı, standart numarası (varsa), aralık etiketi ve renk kodlu ikon ile durum (geçti için yeşil onay, kaldı için kırmızı X, bekliyor için sarı saat). Veri Lab modülünün test istek sisteminden gelir &mdash; bu, Stok ve Kalite Kontrolü arasında köprü kuran bir <strong>çapraz modül okuma</strong>dır.</p>

        <h3 id="urun-stok-source-traceability">6.3.11 &mdash; Kaynak QR İzlenebilirliği</h3>
        <p><code>source_qr_codes</code> alanı, bu ürünü üretmek için tüketilen QR kodlarının JSON dizisini saklar. Frontend bu JSON'u ayrıştırır ve daha fazlası varsa üç nokta ile ilk 2 kodu gösterir. Örneğin:</p>
        <ul>
            <li>Bir Kabatel sepeti X5 kaynak olarak <code>["A1", "A3"]</code> gösterebilir &mdash; tükettiği ham bakır lotları</li>
            <li>Bir Kalaylama makarası Y12 kaynak olarak <code>["X5", "X6"]</code> gösterebilir &mdash; tükettiği Kabatel çıktıları</li>
        </ul>
        <p>Bu, <strong>tam bir malzeme zinciri</strong> oluşturur: ham bakır (A-prefix) &rarr; kabatel teli (X-prefix) &rarr; kalaylanmış tel (Y-prefix) &rarr; ince tel (Z-prefix) &rarr; demet tel (T-prefix) &rarr; yalıtılmış kablo (U-prefix) &rarr; çapraz bağlanmış kablo (G-prefix). Her bağlantı <code>source_qr_codes</code>'da saklanır ve herhangi bir sepeti ham madde kaynağına kadar izlenebilir kılar.</p>

        <h3 id="urun-stok-grouping">6.3.12 &mdash; İstemci Tarafı Gruplama Mantığı</h3>
        <p>7 paralel API yanıtı geldikten sonra <code>fetchAllData()</code> her adımın verisini işler:</p>
        <ol>
            <li>Kayıtlar üzerinde döner, <code>product_code</code>'a göre (veya "Unknown" yedek değeri) bir <code>Record&lt;string, HalfProductStock[]&gt;</code> haritasına gruplar</li>
            <li>Her grup için <code>remaining_weight_kg</code> toplayarak <code>total_kg</code>, <code>siparis_kg</code> (ORDER tahsisi) ve <code>serbest_kg</code> (STOCK tahsisi) hesaplar</li>
            <li>Adım başına genel toplamları biriktirir</li>
            <li>Grupları ürün koduna göre alfabetik sıralar</li>
            <li><code>SectionData</code> nesnesini oluşturur, mevcut <code>expandedKeys</code>'i koruyarak açılmış satırların veri yenilemesi sırasında kaybolmamasını sağlar</li>
        </ol>
        <p>Hammadde Stok'un kategoriye sonra malzeme adına göre gruplayan <code>processAndGroupMaterials()</code> fonksiyonuyla (3 seviye) karşılaştırıldığında, Ürün Stok her adım paneli içinde yalnızca product_code'a göre gruplar (2 seviye), çünkü adım panelinin kendisi üst seviye gruplama görevi görür.</p>

        <h3 id="urun-stok-edit-modal">6.3.13 &mdash; Düzenleme Modalı</h3>
        <p>Düzenleme modalı üç alanın değiştirilmesine izin verir: <code>remaining_weight_kg</code> (zorunlu sayısal girdi, 0.1 adımlı), <code>allocation</code> (ORDER/STOCK açılır menü) ve <code>notes</code> (serbest metin alanı). Hammadde Stok'un 2 alanlı modalıyla (ağırlık + durum) karşılaştırıldığında, bu tahsis alanını ekler. Gönderimde form değerleri <code>PUT /api/stock/half-products/{id}</code>'ye gönderilir, ardından tüm veriler yenilenir.</p>
        <p>Not: Backend'in PUT endpoint'i için <code>allowed_fields</code> beyaz listesi <code>['remaining_weight_kg', 'status', 'notes']</code>'dır &mdash; <code>allocation</code> içermez. Frontend allocation'ı payload'da gönderir ama backend bunu sessizce yok sayar. Bu, tahsisin bu sayfadan etkin bir şekilde <strong>salt okunur</strong> olduğu, yalnızca üretim zamanında değiştirilebildiği anlamına gelir.</p>

        <h3 id="urun-stok-loading-empty">6.3.14 &mdash; Yükleme ve Boş Durumlar</h3>
        <p>Paralel getirme sırasında her panelin içerik alanı "Yükleniyor..." metinli bir <code>Spin</code> döndürücüsü gösterir. Yükleme tamamlandıktan sonra, o üretim adımı için kayıt bulunmayan paneller "Bu kategoride stok bulunamadı" mesajlı Ant Design <code>Empty</code> bileşeni gösterir.</p>

        <h3 id="urun-stok-timezone">6.3.15 &mdash; Saat Dilimi İşleme</h3>
        <p>Hammadde Stok ile aynı kalıp: <code>dayjs</code> ile <code>utc</code> ve <code>timezone</code> eklentileri. Tüm <code>produced_at</code> zaman damgaları veritabanında UTC olarak saklanır ve frontend'de <code>dayjs.utc(date).tz(TURKEY_TZ).format('DD.MM.YY HH:mm')</code> kullanılarak <code>Europe/Istanbul</code> saat dilimine dönüştürülür.</p>

        <h3 id="urun-stok-connections">6.3.16 &mdash; Diğer Modüllerle Bağlantılar</h3>
        <p>Ürün Stok, üç Stok alt modülü arasında en çok <strong>bağlantılı</strong> olanıdır. Her büyük modüle dokunur:</p>
        <ul>
            <li><strong>Üretim &rarr; Üretim Listesi (üst akış yazıcı):</strong> <code>half_product_stock</code>'taki her kayıt bir üretim oturumu sırasında oluşturulmuştur. <code>session_id</code> ve <code>production_output_id</code> sütunları doğrudan Üretim modülünün verisine bağlanır. Backend, operatör adlarını döndürmek için <code>ProductionSession</code> ile birleştirme bile yapar.</li>
            <li><strong>Üretim &rarr; Üretim Geçmişi (paralel görünüm):</strong> Üretim Geçmişi aynı üretim çıktılarını oturum ve zamana göre düzenlenmiş olarak gösterir. Ürün Stok aynı temel veriyi <em>ürün kodu ve adıma</em> göre yeniden düzenleyerek oturum merkezli değil envanter merkezli bir görünüm sağlar.</li>
            <li><strong>Üretim &rarr; Alt akış tüketimi:</strong> <em>Sonraki</em> üretim adımı bir sepeti tükettiğinde (örn. Kalaylama X-kodlu Kabatel çıktısını tüketir), sepetin <code>remaining_weight_kg</code>'si azalır, <code>status</code>'u <code>in_use</code> veya <code>consumed</code>'a değişir ve <code>consumed_at</code> doldurulur. Varsayılan filtre <code>status_filter=available</code> olduğundan bu kayıtlar artık bu sayfada görünmez.</li>
            <li><strong>Sipariş Modülü (tahsis kaynağı):</strong> <code>allocation</code> (ORDER/STOCK) ve <code>order_id</code>, kümülatif çıktının sipariş gereksinimlerine oranına göre üretim zamanında belirlenir. <code>work_card_id</code> sütunu her sepeti Sipariş modülündeki kaynak iş kartına izler.</li>
            <li><strong>Laboratuvar Modülü &rarr; Test Yönetimi (kalite köprüsü):</strong> Bağlı testler modalı, Lab'ın <code>test_integration_routes.py</code> dosyasından test sonuçlarını getirir. Testler, üretim sırasında veya sonrasında Lab sistemi tarafından üretim çıktılarına bağlanır. Ürün Stok, doğrudan Lab verisi okuyan <strong>tek Stok alt modülü</strong>dür.</li>
            <li><strong>Hammadde Modülü (kaynak malzeme):</strong> <code>source_qr_codes</code> alanı Hammadde modülünden ham malzeme QR kodlarına (bakır için A-prefix vb.) referanslar içerir. Ürün Stok <code>materials</code> tablosunu sorgulamasa da, izlenebilirlik zinciri iki modülü veri düzeyinde birbirine bağlar.</li>
        </ul>

        <h3 id="urun-stok-not">6.3.17 &mdash; Bu Alt Modülün Yapmadıkları</h3>
        <ul>
            <li>Envanter <strong>oluşturmaz</strong> &mdash; bu yalnızca Üretim modülünde aktif oturumlar sırasında gerçekleşir.</li>
            <li>Tüketilmiş veya sevk edilmiş kayıtları <strong>göstermez</strong> &mdash; varsayılan <code>status_filter=available</code> filtresi tamamlanmış yaşam döngüsü kayıtlarını gizler.</li>
            <li>Arama çubuğu <strong>yoktur</strong> &mdash; gezinme adım panellerini ve grup satırlarını açarak yapılır.</li>
            <li>Toplu işlem <strong>desteklemez</strong> &mdash; çoklu seçim, toplu tahsis değişikliği veya toplu silme yoktur.</li>
            <li>Tahsisi gerçekten <strong>değiştirmez</strong> &mdash; düzenleme modalı bir tahsis açılır menüsü sunsa da, backend bunu sessizce yok sayar (<code>allowed_fields</code>'da yok).</li>
            <li>WebSocket veya gerçek zamanlı güncelleme <strong>kullanmaz</strong> &mdash; veri yüklemede ve Yenile butonu ile manuel olarak çekilir.</li>
            <li><code>initial_weight_kg</code>'yi <strong>göstermez</strong> &mdash; yalnızca <code>remaining_weight_kg</code> gösterilir, bu nedenle tüketim yüzdesi görselleştirmesi yoktur (Hammadde Stok'un renk kodlu ağırlık sütununun aksine).</li>
            <li>Koşullu ağırlık renklendirmesi <strong>yoktur</strong> &mdash; Hammadde Stok tüketim oranına göre ağırlıkları sarı/kırmızı renklendirirken, bu sayfa tüm ağırlıkları düz metin olarak gösterir.</li>
            <li><code>aktarma</code> adımı backend'in <code>ProductionStep</code> enum'unda veya <code>MACHINE_TO_PREFIX</code> eşlemesinde <strong>yoktur</strong> &mdash; frontend 7 adım tanımlar ama backend enum'u yalnızca 6 içerir, bu da Aktarma'nın daha yeni bir ekleme olduğunu düşündürür.</li>
        </ul>

        <div class="insight">
            <p style="margin-bottom: 0;"><strong>Ürün Stok vs Hammadde Stok &mdash; aynı kabuk, farklı motor:</strong> Görsel düzen neredeyse aynıdır (Collapse paneller, gruplu tablolar, düzenleme modalı, yenile butonu), ancak alttaki veri modeli temelden farklıdır. Hammadde Stok, Hammadde modülünün <code>materials</code> tablosundan tek bir API çağrısıyla okur ve malzeme kategorisi/adına göre gruplar. Ürün Stok, kendi <code>half_product_stock</code> tablosundan 7 paralel API çağrısıyla okur, product_code'a göre gruplar ve ORDER/STOCK tahsis ayrımı, Lab test entegrasyonu, kaynak QR izlenebilirliği ve üretim oturumu bağlantısını ekler. Hammadde Stok ham girdilere salt okunur bir penceredir. Ürün Stok, Üretim, Lab ve Sipariş modülleriyle derin çapraz modül bağlantılarına sahip üretim çıktılarına oku-ve-yönet bir penceredir.</p>
        </div>

        <!-- placeholder: Bölüm 7 SONUÇ buraya eklenecek -->

    </main>
</body>
</html>
